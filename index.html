<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#5D4037" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Daily Brew">
  <title>My Daily Brew</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Cormorant+Garamond:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    html, body, #root { height: 100%; width: 100%; overflow-x: hidden; }
    body { font-family: 'Cormorant Garamond', Georgia, serif; min-height: 100vh; transition: background 0.4s ease; overscroll-behavior: none; }
    .loading-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; background: linear-gradient(180deg, #F5E6D3 0%, #FDFBF7 50%, #F5E6D3 100%); transition: opacity 0.5s; }
    .loading-screen.hidden { opacity: 0; pointer-events: none; }
    .loading-icon { font-size: 56px; animation: steam 2s ease-in-out infinite; }
    @keyframes steam { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.1); } }
    .loading-text { font-family: 'Caveat', cursive; font-size: 26px; color: #5D4037; margin-top: 16px; }
    .loading-subtext { font-family: 'Lora', serif; font-size: 14px; color: #8B7355; margin-top: 8px; opacity: 0.8; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-icon">â˜•</div>
    <div class="loading-text">Brewing something special...</div>
    <div class="loading-subtext">v6.3 Grand Reopening</div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const store = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} };
    const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
    const getDateKey = (d = new Date()) => d.toISOString().split('T')[0];
    const getDayOfWeek = (d = new Date()) => d.getDay();
    const isSameDay = (d1, d2) => getDateKey(d1) === getDateKey(d2);
    const formatTime = (t) => { if (!t) return ''; const [h, m] = t.split(':').map(Number); return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`; };
    const formatTimer = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
    const getWeekNumber = () => Math.floor(new Date().getTime() / (7 * 24 * 60 * 60 * 1000));
    const getMonthKey = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEASONAL THEMES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const getCurrentSeason = () => {
      const month = new Date().getMonth();
      if (month >= 2 && month <= 4) return 'spring';
      if (month >= 5 && month <= 7) return 'summer';
      if (month >= 8 && month <= 10) return 'fall';
      return 'winter';
    };

    const seasonalDecorations = {
      spring: { emoji: 'ðŸŒ¸', name: 'Cherry Blossom', accent: '#FFB7C5' },
      summer: { emoji: 'ðŸŒ»', name: 'Sunshine', accent: '#FFD93D' },
      fall: { emoji: 'ðŸ‚', name: 'Pumpkin Spice', accent: '#D2691E' },
      winter: { emoji: 'â„ï¸', name: 'Peppermint', accent: '#B8E0E0' }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BREW-THEMED DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const brewRanks = {
      coffee: [
        { level: 1, title: 'Coffee Bean', xp: 0, icon: 'ðŸ«˜' },
        { level: 2, title: 'Barista Trainee', xp: 100, icon: 'ðŸ‘¶' },
        { level: 3, title: 'Junior Barista', xp: 300, icon: 'â˜•' },
        { level: 4, title: 'Senior Barista', xp: 600, icon: 'â­' },
        { level: 5, title: 'Head Barista', xp: 1000, icon: 'ðŸŽ–ï¸' },
        { level: 6, title: 'CafÃ© Manager', xp: 1500, icon: 'ðŸ‘”' },
        { level: 7, title: 'CafÃ© Owner', xp: 2500, icon: 'ðŸ†' },
      ],
      tea: [
        { level: 1, title: 'Tea Leaf', xp: 0, icon: 'ðŸŒ¿' },
        { level: 2, title: 'Tea Apprentice', xp: 100, icon: 'ðŸƒ' },
        { level: 3, title: 'Tea Steeper', xp: 300, icon: 'ðŸµ' },
        { level: 4, title: 'Tea Blender', xp: 600, icon: 'â­' },
        { level: 5, title: 'Tea Sommelier', xp: 1000, icon: 'ðŸŽ–ï¸' },
        { level: 6, title: 'Tea Sage', xp: 1500, icon: 'ðŸ§˜' },
        { level: 7, title: 'Tea Grandmaster', xp: 2500, icon: 'ðŸ‘‘' },
      ],
      matcha: [
        { level: 1, title: 'Matcha Seedling', xp: 0, icon: 'ðŸŒ±' },
        { level: 2, title: 'Matcha Student', xp: 100, icon: 'ðŸ“š' },
        { level: 3, title: 'Matcha Whisker', xp: 300, icon: 'ðŸƒ' },
        { level: 4, title: 'Matcha Artisan', xp: 600, icon: 'ðŸŽ¨' },
        { level: 5, title: 'Matcha Sensei', xp: 1000, icon: 'ðŸ¥‹' },
        { level: 6, title: 'Matcha Master', xp: 1500, icon: 'ðŸ¯' },
        { level: 7, title: 'Zen Grandmaster', xp: 2500, icon: 'ðŸ‰' },
      ]
    };

    const brewBadges = {
      coffee: [
        { id: 'first_habit', name: 'First Sip', desc: 'Complete your first habit', icon: 'â˜•', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Regular Order', desc: '7-day streak', icon: 'ðŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Loyal Customer', desc: '30-day streak', icon: 'ðŸ’Ž', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Roast', desc: 'Complete all daily goals', icon: 'âœ¨', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Barista\'s Best', desc: '7 perfect days', icon: 'ðŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Coffee Connoisseur', desc: 'Track mood 7 days', icon: 'ðŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Deep Brew', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Espresso Shot', desc: '10 hours focus', icon: 'âš¡', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Coffee Journal', desc: '5 journal entries', icon: 'ðŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Order Up!', desc: '25 tasks done', icon: 'ðŸ›Žï¸', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Rush Hour Hero', desc: '100 tasks done', icon: 'ðŸ’¯', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Morning Brew', desc: 'Task before 8 AM', icon: 'ðŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Late Night Latte', desc: 'Task after 10 PM', icon: 'ðŸ¦‰', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Daily Grind', desc: '14-day app streak', icon: 'ðŸ“…', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Iced Coffee', desc: 'Use streak freeze', icon: 'â„ï¸', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Challenge Champion', desc: 'Complete a challenge', icon: 'ðŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Social Barista', desc: 'Share an achievement', icon: 'ðŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Data Roaster', desc: 'Export your data', icon: 'ðŸ’¾', check: s => s.timesExported >= 1 },
      ],
      tea: [
        { id: 'first_habit', name: 'First Steep', desc: 'Complete your first habit', icon: 'ðŸµ', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Daily Ritual', desc: '7-day streak', icon: 'ðŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Tea Tradition', desc: '30-day streak', icon: 'ðŸ’Ž', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Steep', desc: 'Complete all daily goals', icon: 'âœ¨', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Golden Cup', desc: '7 perfect days', icon: 'ðŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Tea Taster', desc: 'Track mood 7 days', icon: 'ðŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Zen Focus', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Tea Meditation', desc: '10 hours focus', icon: 'ðŸ§˜', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Tea Thoughts', desc: '5 journal entries', icon: 'ðŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Steeping Success', desc: '25 tasks done', icon: 'ðŸ«–', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Tea Party Host', desc: '100 tasks done', icon: 'ðŸ’¯', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Morning Tea', desc: 'Task before 8 AM', icon: 'ðŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Chamomile Night', desc: 'Task after 10 PM', icon: 'ðŸŒ™', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Tea Time', desc: '14-day app streak', icon: 'ðŸ“…', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Iced Tea', desc: 'Use streak freeze', icon: 'ðŸ§Š', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Challenge Conqueror', desc: 'Complete a challenge', icon: 'ðŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Tea Socialite', desc: 'Share an achievement', icon: 'ðŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Tea Archivist', desc: 'Export your data', icon: 'ðŸ’¾', check: s => s.timesExported >= 1 },
      ],
      matcha: [
        { id: 'first_habit', name: 'First Whisk', desc: 'Complete your first habit', icon: 'ðŸƒ', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Daily Practice', desc: '7-day streak', icon: 'ðŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Zen Discipline', desc: '30-day streak', icon: 'ðŸ’Ž', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Balance', desc: 'Complete all daily goals', icon: 'â˜¯ï¸', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Harmony Week', desc: '7 perfect days', icon: 'ðŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Mindful Taster', desc: 'Track mood 7 days', icon: 'ðŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Zen Focus', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Deep Meditation', desc: '10 hours focus', icon: 'ðŸ§˜', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Zen Journal', desc: '5 journal entries', icon: 'ðŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Flowing Progress', desc: '25 tasks done', icon: 'ðŸŒŠ', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Mountain Climber', desc: '100 tasks done', icon: 'ðŸ”ï¸', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Sunrise Ritual', desc: 'Task before 8 AM', icon: 'ðŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Moonlit Practice', desc: 'Task after 10 PM', icon: 'ðŸŒ™', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Path of Zen', desc: '14-day app streak', icon: 'ðŸ›¤ï¸', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Frozen Matcha', desc: 'Use streak freeze', icon: 'ðŸ§Š', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Zen Champion', desc: 'Complete a challenge', icon: 'ðŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Zen Teacher', desc: 'Share an achievement', icon: 'ðŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Scroll Keeper', desc: 'Export your data', icon: 'ðŸ’¾', check: s => s.timesExported >= 1 },
      ]
    };

    const brewMessages = {
      coffee: { emptyHabits: "No habits brewing yet! Let's start your routine â˜•", emptyTasks: "All clear! Grab a coffee and relax! â˜•", perfect: "Perfect roast today! You're amazing âœ¨", good: "You're brewing greatness! â˜•", start: "One sip at a time â˜•", timerDone: "â˜• Brew complete!", timerFocus: "Stay focused, one cup at a time", freeze: "â„ï¸ Iced Coffee saved your streak!" },
      tea: { emptyHabits: "No habits steeping yet! Let's start your ritual ðŸµ", emptyTasks: "All clear! Enjoy a peaceful cup of tea! ðŸµ", perfect: "Perfect steep today! You're amazing âœ¨", good: "You're steeping success! ðŸµ", start: "One steep at a time ðŸµ", timerDone: "ðŸµ Steep complete!", timerFocus: "Stay focused, find your calm", freeze: "ðŸ§Š Iced Tea saved your streak!" },
      matcha: { emptyHabits: "No habits cultivated yet! Let's find balance ðŸƒ", emptyTasks: "All clear! Find your zen moment! ðŸƒ", perfect: "Perfect harmony today! You're amazing âœ¨", good: "You're finding balance! ðŸƒ", start: "One breath at a time ðŸƒ", timerDone: "ðŸƒ Meditation complete!", timerFocus: "Stay focused, embrace the calm", freeze: "ðŸ§Š Frozen Matcha saved your streak!" }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHALLENGES SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const weeklyChallengeDefs = [
      { id: 'habits_21', name: 'Habit Hero', desc: 'Complete 21 habits this week', target: 21, type: 'habits', xp: 100, icon: 'â­' },
      { id: 'tasks_15', name: 'Task Tornado', desc: 'Complete 15 tasks this week', target: 15, type: 'tasks', xp: 75, icon: 'ðŸŒªï¸' },
      { id: 'focus_120', name: 'Deep Focus Week', desc: 'Focus for 2 hours total', target: 120, type: 'focus', xp: 100, icon: 'ðŸŽ¯' },
      { id: 'mood_7', name: 'Mood Tracker', desc: 'Log mood every day', target: 7, type: 'moods', xp: 50, icon: 'ðŸ˜Š' },
      { id: 'perfect_3', name: 'Triple Threat', desc: '3 perfect days', target: 3, type: 'perfect', xp: 150, icon: 'âœ¨' },
    ];

    const monthlyChallengeDefs = [
      { id: 'habits_100', name: 'Century Club', desc: '100 habits this month', target: 100, type: 'habits', xp: 300, icon: 'ðŸ’¯' },
      { id: 'streak_14', name: 'Fortnight Force', desc: '14-day streak', target: 14, type: 'streak', xp: 200, icon: 'ðŸ”¥' },
      { id: 'journal_20', name: 'Diary Devotee', desc: '20 journal entries', target: 20, type: 'journal', xp: 250, icon: 'ðŸ“š' },
      { id: 'focus_600', name: 'Focus Master', desc: '10 hours of focus', target: 600, type: 'focus', xp: 350, icon: 'ðŸ§ ' },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI COACH TIPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const getDailyTip = (stats, brewType) => {
      const tips = {
        coffee: {
          lowMood: "â˜• Feeling a bit flat? Sometimes a change of scenery or a short walk can perk you up like a fresh espresso!",
          streakRisk: "â˜• Your streak is precious! Even completing one small habit keeps the momentum brewing.",
          perfectDay: "â˜• You're on fire today! Keep this energy going - you're the head barista of your life!",
          morning: "â˜• Good morning! Start with your easiest habit - it's like that first sip of coffee that gets everything flowing.",
          evening: "â˜• Winding down? Take a moment to reflect on your wins today. Every small step counts!",
          newUser: "â˜• Welcome to the cafÃ©! Start small - pick just one habit and make it your daily ritual.",
          focusTip: "â˜• Try the Pomodoro technique: 25 minutes of focus, then a coffee break!",
          habitTip: "â˜• Stack your habits! Do your new habit right after something you already do daily.",
        },
        tea: {
          lowMood: "ðŸµ Feeling low? Take a mindful moment. Brew some tea and breathe deeply - calm is coming.",
          streakRisk: "ðŸµ Your streak is like a delicate tea - nurture it with just one small action today.",
          perfectDay: "ðŸµ Beautiful harmony today! You're steeping in success and it shows!",
          morning: "ðŸµ Good morning! Like a gentle tea, ease into your day with your simplest habit first.",
          evening: "ðŸµ Evening reflection time. What brought you peace today? Savor those moments.",
          newUser: "ðŸµ Welcome, friend! Start with one calming habit. Let it steep into your routine naturally.",
          focusTip: "ðŸµ Focus is like steeping tea - give it time and attention for the best results.",
          habitTip: "ðŸµ Attach new habits to your tea time for a soothing ritual.",
        },
        matcha: {
          lowMood: "ðŸƒ Feeling unbalanced? Return to your breath. Each moment is a chance to find your center again.",
          streakRisk: "ðŸƒ Your streak is part of your practice. Honor it with even the smallest mindful action.",
          perfectDay: "ðŸƒ Perfect balance achieved! You are the master of your own zen garden today!",
          morning: "ðŸƒ Good morning! Begin with intention. What will bring you harmony today?",
          evening: "ðŸƒ As the day settles, reflect on your journey. Growth happens in stillness too.",
          newUser: "ðŸƒ Welcome to the path! One small habit, practiced with intention, creates lasting change.",
          focusTip: "ðŸƒ Focus is meditation in action. Be present with your task, breath by breath.",
          habitTip: "ðŸƒ Let habits flow naturally, like water finding its path. Don't force - allow.",
        }
      };
      
      const hour = new Date().getHours();
      const brewTips = tips[brewType];
      
      if (stats.moodDaysTracked > 0 && stats.lastMoodValue <= 2) return brewTips.lowMood;
      if (stats.appStreak > 3 && stats.perfectDayToday === false && hour >= 20) return brewTips.streakRisk;
      if (stats.perfectDayToday) return brewTips.perfectDay;
      if (stats.totalHabitsCompleted < 5) return brewTips.newUser;
      if (hour < 10) return brewTips.morning;
      if (hour >= 18) return brewTips.evening;
      if (Math.random() > 0.5) return brewTips.focusTip;
      return brewTips.habitTip;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THEME SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const brewThemes = {
      coffee: {
        icon: 'â˜•', name: 'Coffee',
        light: { id: 'coffee-light', name: 'Light Brew', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #F5E6D3 0%, #FDFBF7 50%, #F5E6D3 100%)', cardBg: 'linear-gradient(145deg, #FDFBF7 0%, #FBF7F0 100%)', cardBorder: '#E8DCC8', text: '#5D4037', textSecondary: '#8B7355', textMuted: '#C4A77D', accent: '#8B7355', accentLight: '#E8DCC8', accentGradient: 'linear-gradient(145deg, #8B7355 0%, #6B5344 100%)', inputBg: '#FDFBF7', inputBorder: '#D4C4A8', progressBg: '#F0E6D8', streakGradient: 'linear-gradient(145deg, #D4A574 0%, #C4946A 100%)', navBg: 'rgba(253, 251, 247, 0.95)', modalBg: '#FDFBF7', success: '#8FB573', danger: '#C57373', xpBar: 'linear-gradient(90deg, #D4A574 0%, #8B7355 100%)', themeColor: '#5D4037', isDark: false },
        dark: { id: 'coffee-dark', name: 'Dark Brew', icon: 'ðŸŒ™', bg: 'linear-gradient(180deg, #1A1412 0%, #2D2320 50%, #1A1412 100%)', cardBg: 'linear-gradient(145deg, #2D2320 0%, #3D322E 100%)', cardBorder: '#4A3F3A', text: '#F5E6D3', textSecondary: '#C4A77D', textMuted: '#8B7355', accent: '#D4A574', accentLight: '#3D322E', accentGradient: 'linear-gradient(145deg, #D4A574 0%, #C4946A 100%)', inputBg: '#2D2320', inputBorder: '#4A3F3A', progressBg: '#3D322E', streakGradient: 'linear-gradient(145deg, #C4946A 0%, #A67B5B 100%)', navBg: 'rgba(45, 35, 32, 0.95)', modalBg: '#2D2320', success: '#7A9A6A', danger: '#9A6A6A', xpBar: 'linear-gradient(90deg, #C4946A 0%, #8B6B4A 100%)', themeColor: '#1A1412', isDark: true }
      },
      tea: {
        icon: 'ðŸµ', name: 'Tea',
        light: { id: 'tea-light', name: 'White Tea', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #FDF8E8 0%, #FFFDF5 50%, #FDF8E8 100%)', cardBg: 'linear-gradient(145deg, #FFFDF5 0%, #FDF8E8 100%)', cardBorder: '#E8DFB8', text: '#6B5D14', textSecondary: '#8B7B34', textMuted: '#C4B477', accent: '#A8923D', accentLight: '#F0E8C8', accentGradient: 'linear-gradient(145deg, #C4A43D 0%, #A8862D 100%)', inputBg: '#FFFDF5', inputBorder: '#D4C898', progressBg: '#F5EED8', streakGradient: 'linear-gradient(145deg, #D4B454 0%, #C4A444 100%)', navBg: 'rgba(255, 253, 245, 0.95)', modalBg: '#FFFDF5', success: '#8FB573', danger: '#C57373', xpBar: 'linear-gradient(90deg, #D4B454 0%, #A8923D 100%)', themeColor: '#A8923D', isDark: false },
        dark: { id: 'tea-dark', name: 'Black Tea', icon: 'ðŸŒ™', bg: 'linear-gradient(180deg, #1A1808 0%, #2D2810 50%, #1A1808 100%)', cardBg: 'linear-gradient(145deg, #2D2810 0%, #3D3820 100%)', cardBorder: '#4A4530', text: '#F5EED3', textSecondary: '#C4B477', textMuted: '#8B7B34', accent: '#D4B454', accentLight: '#3D3820', accentGradient: 'linear-gradient(145deg, #D4B454 0%, #C4A444 100%)', inputBg: '#2D2810', inputBorder: '#4A4530', progressBg: '#3D3820', streakGradient: 'linear-gradient(145deg, #C4A444 0%, #A48B3B 100%)', navBg: 'rgba(45, 40, 16, 0.95)', modalBg: '#2D2810', success: '#7A9A6A', danger: '#9A6A6A', xpBar: 'linear-gradient(90deg, #C4A444 0%, #8B7B34 100%)', themeColor: '#1A1808', isDark: true }
      },
      matcha: {
        icon: 'ðŸƒ', name: 'Matcha',
        light: { id: 'matcha-light', name: 'Light Matcha', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #EFF5E6 0%, #F8FBF5 50%, #EFF5E6 100%)', cardBg: 'linear-gradient(145deg, #F8FBF5 0%, #EFF5E6 100%)', cardBorder: '#D4E4C4', text: '#3D5D2D', textSecondary: '#5B7B4B', textMuted: '#9AB48A', accent: '#6B8B5B', accentLight: '#E0EED4', accentGradient: 'linear-gradient(145deg, #7B9B6B 0%, #5B7B4B 100%)', inputBg: '#F8FBF5', inputBorder: '#C4D4B4', progressBg: '#E4EED8', streakGradient: 'linear-gradient(145deg, #8BAB7B 0%, #7B9B6B 100%)', navBg: 'rgba(248, 251, 245, 0.95)', modalBg: '#F8FBF5', success: '#7B9B6B', danger: '#B57373', xpBar: 'linear-gradient(90deg, #8BAB7B 0%, #6B8B5B 100%)', themeColor: '#6B8B5B', isDark: false },
        dark: { id: 'matcha-dark', name: 'Dark Matcha', icon: 'ðŸŒ™', bg: 'linear-gradient(180deg, #0F1A0C 0%, #1E2D18 50%, #0F1A0C 100%)', cardBg: 'linear-gradient(145deg, #1E2D18 0%, #2E3D28 100%)', cardBorder: '#3A4A34', text: '#E4EED8', textSecondary: '#9AB48A', textMuted: '#5B7B4B', accent: '#8BAB7B', accentLight: '#2E3D28', accentGradient: 'linear-gradient(145deg, #8BAB7B 0%, #7B9B6B 100%)', inputBg: '#1E2D18', inputBorder: '#3A4A34', progressBg: '#2E3D28', streakGradient: 'linear-gradient(145deg, #7B9B6B 0%, #6B8B5B 100%)', navBg: 'rgba(30, 45, 24, 0.95)', modalBg: '#1E2D18', success: '#6B8B5B', danger: '#8B5B5B', xpBar: 'linear-gradient(90deg, #7B9B6B 0%, #5B7B4B 100%)', themeColor: '#0F1A0C', isDark: true }
      }
    };

    const categories = [
      { id: 'health', name: 'Health', icon: 'ðŸ’ª', color: '#7BB56B' },
      { id: 'work', name: 'Work', icon: 'ðŸ’¼', color: '#8B6BB5' },
      { id: 'creative', name: 'Creative', icon: 'ðŸŽ¨', color: '#B5956B' },
      { id: 'social', name: 'Social', icon: 'ðŸ‘¥', color: '#B56BB5' },
      { id: 'chores', name: 'Chores', icon: 'ðŸ ', color: '#6BB5B5' },
      { id: 'self', name: 'Self Care', icon: 'ðŸ’†', color: '#B56B8B' },
    ];

    const defaultEmojis = ['ðŸ’§','ðŸƒ','ðŸ“–','ðŸ˜´','ðŸ¥—','ðŸ“','ðŸŽ¨','ðŸ§˜','ðŸ’¬','âœ¨','ðŸŽµ','ðŸš¶','ðŸƒ','ðŸ““','ðŸ¤¸','ðŸ’Š','ðŸ§¹','ðŸŒ…','ðŸŽ','ðŸ’¤','ðŸŽ¯','ðŸ“±','ðŸ§ ','â¤ï¸','ðŸŒ¿','â˜€ï¸','ðŸŒ™','â­','ðŸ”¥','ðŸ’ª'];
    const moodEmojis = [{ emoji: 'ðŸ˜¢', label: 'Rough', value: 1 }, { emoji: 'ðŸ˜•', label: 'Meh', value: 2 }, { emoji: 'ðŸ˜Š', label: 'Good', value: 3 }, { emoji: 'ðŸ˜„', label: 'Great', value: 4 }, { emoji: 'ðŸ¤©', label: 'Amazing', value: 5 }];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WHAT'S NEW CONTENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const whatsNewContent = [
      { version: '6.0', title: 'ðŸŽ‰ Grand Reopening!', items: [
        { icon: 'ðŸŽšï¸', title: 'Volume Sliders', desc: 'Control ambiance & music independently' },
        { icon: 'ðŸ ', title: 'Mood Presets', desc: 'Cozy, Chill, Upbeat, Soothing, Meditative, Focus' },
        { icon: 'ðŸŒ™', title: 'Light/Dark Sound', desc: 'Sounds adapt to your color theme' },
        { icon: 'ðŸŽµ', title: 'Richer Audio', desc: 'More authentic piano, chimes & bowls' },
        { icon: 'ðŸŽ¨', title: 'Mix & Match', desc: 'Combine any ambiance with any music' },
        { icon: 'ðŸ‚', title: 'Seasonal Themes', desc: 'Automatic decorations for each season' },
        { icon: 'ðŸ†', title: 'Challenges', desc: 'Weekly & monthly goals for XP' },
        { icon: 'ðŸ“…', title: 'Year in Review', desc: 'See your complete journey' },
      ]},
      { version: '5.0', title: 'â˜• Themed Experience', items: [
        { icon: 'â˜•ðŸµðŸƒ', title: 'Brew-Specific Everything', desc: 'Ranks, badges, and messages match your brew' },
        { icon: 'â±ï¸', title: 'Custom Timer', desc: 'Set any focus duration you want' },
        { icon: 'ðŸ“Š', title: 'Mood Insights', desc: 'See how habits affect your mood' },
      ]},
      { version: '4.0', title: 'âœ¨ Feature Explosion', items: [
        { icon: 'ðŸ‘†', title: 'Swipe Gestures', desc: 'Swipe to complete or delete' },
        { icon: 'ðŸ”„', title: 'Recurring Tasks', desc: 'Daily, weekday, or weekly schedules' },
        { icon: 'ðŸ“‹', title: 'Subtasks', desc: 'Break tasks into smaller steps' },
        { icon: 'â„ï¸', title: 'Streak Freeze', desc: 'Weekly protection for your streaks' },
        { icon: 'ðŸ”¥', title: 'Habit Heatmap', desc: '12-week visual progress grid' },
      ]},
      { version: '3.0', title: 'ðŸŽ¨ Choose Your Brew', items: [
        { icon: 'ðŸŽ¨', title: '6 Beautiful Themes', desc: 'Coffee, Tea, Matcha - light & dark' },
        { icon: 'ðŸŽ®', title: 'XP & Leveling', desc: 'Gamified progression system' },
        { icon: 'ðŸ†', title: 'Achievement Badges', desc: 'Unlock rewards for milestones' },
      ]},
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TUTORIAL STEPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const tutorialSteps = [
      { id: 'welcome', title: 'Welcome to the CafÃ©! â˜•', subtitle: 'Pull up a chair, friend!', content: "We've been busy renovating! Your cozy productivity companion is now better than ever. Let me show you around the new digs!", icon: 'ðŸ ', highlight: null },
      { id: 'brew', title: 'Pick Your Signature Drink', subtitle: 'Every regular has their usual...', content: "Choose Coffee â˜•, Tea ðŸµ, or Matcha ðŸƒ - each with unique ranks, badges, and vibes. Your whole experience adapts to your brew!", icon: 'â˜•', highlight: 'theme' },
      { id: 'habits', title: 'Your Daily Specials', subtitle: 'The menu of good habits!', content: "Add habits you want to build. Tap to complete, swipe right for quick check-off, or swipe left to remove. Build streaks and watch them grow!", icon: 'â­', highlight: 'habits' },
      { id: 'tasks', title: 'Today\'s Orders', subtitle: 'One task at a time, barista!', content: "Add tasks with priorities, categories, times, and subtasks. Set them to repeat daily, on weekdays, or weekly!", icon: 'âœ“', highlight: 'tasks' },
      { id: 'timer', title: 'The Focus Bar', subtitle: 'Time to get in the zone!', content: "Use our cozy focus timer with brew-specific soundscapes. Pick a preset or set your own custom duration. Deep work, cafÃ© style!", icon: 'â±ï¸', highlight: 'timer' },
      { id: 'journal', title: 'The Corner Booth', subtitle: 'Your private reflection spot...', content: "Journal your gratitude, daily reflections, and tomorrow's plans. It's your cozy corner for self-discovery.", icon: 'ðŸ“', highlight: 'journal' },
      { id: 'challenges', title: 'Weekly Specials Board', subtitle: 'Extra rewards await!', content: "Check out weekly and monthly challenges for bonus XP. Push yourself and earn special recognition!", icon: 'ðŸ†', highlight: 'challenges' },
      { id: 'streak', title: 'Streak Insurance', subtitle: 'We\'ve got your back!', content: "Life happens! You get one free streak freeze per week. If you miss a day, it activates automatically to protect your progress.", icon: 'â„ï¸', highlight: 'streak' },
      { id: 'sounds', title: 'Your Signature Soundtrack', subtitle: 'Set the perfect mood...', content: "Tap the ðŸŽµ button anytime to open Soundscape. Choose a mood (Cozy, Chill, Focus...), adjust volume sliders, and mix any ambiance with any music. Light mode sounds brighter, dark mode sounds warmer!", icon: 'ðŸŽµ', highlight: 'sounds' },
      { id: 'ready', title: 'Your Table is Ready!', subtitle: 'Time to make it yours...', content: "That's the grand tour! Remember, every small sip of progress counts. Your journey to better habits starts with a single step. Enjoy your stay! â˜•", icon: 'âœ¨', highlight: null },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SWIPEABLE COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function SwipeableCard({ children, onSwipeLeft, onSwipeRight, style }) {
      const [touchStart, setTouchStart] = useState(null);
      const [touchEnd, setTouchEnd] = useState(null);
      const [offset, setOffset] = useState(0);
      const minSwipe = 50;
      const onTouchStart = (e) => { setTouchEnd(null); setTouchStart(e.targetTouches[0].clientX); };
      const onTouchMove = (e) => { setTouchEnd(e.targetTouches[0].clientX); if (touchStart) setOffset(e.targetTouches[0].clientX - touchStart); };
      const onTouchEnd = () => { if (!touchStart || !touchEnd) { setOffset(0); return; } const dist = touchStart - touchEnd; if (dist > minSwipe && onSwipeLeft) onSwipeLeft(); if (dist < -minSwipe && onSwipeRight) onSwipeRight(); setOffset(0); };
      const bgColor = offset > minSwipe ? 'rgba(139,181,115,0.3)' : offset < -minSwipe ? 'rgba(197,115,115,0.3)' : 'transparent';
      return (<div onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd} style={{ ...style, transform: `translateX(${Math.max(-100, Math.min(100, offset * 0.5))}px)`, transition: offset === 0 ? 'transform 0.2s' : 'none', background: bgColor }}>{children}</div>);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function App() {
      const APP_VERSION = '6.3.0';
      const season = getCurrentSeason();
      const seasonDeco = seasonalDecorations[season];

      // Core state
      const [brewType, setBrewType] = useState(() => load('brewType', 'coffee'));
      const [isDark, setIsDark] = useState(() => load('isDark', false));
      const [highContrast, setHighContrast] = useState(() => load('highContrast', false));
      const theme = brewThemes[brewType][isDark ? 'dark' : 'light'];
      const levels = brewRanks[brewType];
      const badges = brewBadges[brewType];
      const messages = brewMessages[brewType];

      const [activeTab, setActiveTab] = useState('today');
      const [habits, setHabits] = useState(() => load('habits', [{ id: 1, name: 'Drink water', icon: 'ðŸ’§', completed: false, streak: 0, history: {} }]));
      const [tasks, setTasks] = useState(() => load('tasks', []));
      const [moods, setMoods] = useState(() => load('moods', {}));
      const [journal, setJournal] = useState(() => load('journal', {}));
      const [habitHistory, setHabitHistory] = useState(() => load('habitHistory', {}));
      const [gameStats, setGameStats] = useState(() => load('gameStats', { xp: 0, totalHabitsCompleted: 0, totalTasksCompleted: 0, perfectDays: 0, moodDaysTracked: 0, totalFocusMinutes: 0, journalEntries: 0, earlyTasks: 0, lateTasks: 0, appStreak: 0, maxStreak: 0, lastActiveDate: null, unlockedBadges: [], freezesAvailable: 1, freezesUsed: 0, weeklyFreeze: null, challengesCompleted: 0, timesShared: 0, timesExported: 0, lastMoodValue: 3, perfectDayToday: false }));
      const [challenges, setChallenges] = useState(() => load('challenges', { weekly: { id: null, progress: 0, week: null }, monthly: { id: null, progress: 0, month: null } }));
      const [cafeName, setCafeName] = useState(() => load('cafeName', 'My Daily Brew'));

      // UI state
      const [showWhatsNew, setShowWhatsNew] = useState(() => load('lastSeenVersion', '0') !== APP_VERSION);
      const [showTutorial, setShowTutorial] = useState(false);
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showAddHabit, setShowAddHabit] = useState(false);
      const [showAddTask, setShowAddTask] = useState(false);
      const [showThemePicker, setShowThemePicker] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showBadges, setShowBadges] = useState(false);
      const [showQuickAdd, setShowQuickAdd] = useState(false);
      const [showSubtaskInput, setShowSubtaskInput] = useState(null);
      const [showChallenges, setShowChallenges] = useState(false);
      const [showYearReview, setShowYearReview] = useState(false);
      const [showCustomTimer, setShowCustomTimer] = useState(false);
      const [showExport, setShowExport] = useState(false);
      const [celebration, setCelebration] = useState(null);
      const [undoAction, setUndoAction] = useState(null);
      const [showDailyTip, setShowDailyTip] = useState(() => load('lastTipDate', '') !== getDateKey());
      const [newHabit, setNewHabit] = useState({ name: '', icon: 'ðŸ’§' });
      const [newTask, setNewTask] = useState({ text: '', time: '', priority: 'medium', category: null, recurring: 'none', subtasks: [] });
      const [newSubtask, setNewSubtask] = useState('');
      const [calendarDate, setCalendarDate] = useState(new Date());
      const [timerSeconds, setTimerSeconds] = useState(25 * 60);
      const [timerRunning, setTimerRunning] = useState(false);
      const [timerTask, setTimerTask] = useState(null);
      const [timerStartTime, setTimerStartTime] = useState(null);
      const [customTimerMins, setCustomTimerMins] = useState(25);
      const [ambientSound, setAmbientSound] = useState(() => load('ambientSound', 'off')); // 'off', 'ambiance', 'music', 'both'
      const [soundAmbianceSource, setSoundAmbianceSource] = useState(() => load('soundAmbianceSource', 'auto')); // 'auto', 'coffee', 'tea', 'matcha'
      const [soundMusicSource, setSoundMusicSource] = useState(() => load('soundMusicSource', 'auto')); // 'auto', 'coffee', 'tea', 'matcha'
      const [ambianceVolume, setAmbianceVolume] = useState(() => load('ambianceVolume', 50)); // 0-100
      const [musicVolume, setMusicVolume] = useState(() => load('musicVolume', 50)); // 0-100
      const [soundMood, setSoundMood] = useState(() => load('soundMood', 'cozy')); // cozy, chill, upbeat, soothing, meditative, focus
      const [backgroundPlay, setBackgroundPlay] = useState(() => load('backgroundPlay', false));
      const [soundEnabled, setSoundEnabled] = useState(false); // Whether sound is currently playing
      const [showSoundMenu, setShowSoundMenu] = useState(false);
      const [todayJournal, setTodayJournal] = useState(() => load('journal', {})[getDateKey()] || { gratitude: '', reflection: '', tomorrow: '' });
      
      const timerRef = useRef(null);

      const today = new Date();
      const todayKey = getDateKey();
      const currentYear = today.getFullYear();

      // Save effects
      useEffect(() => { store('habits', habits); }, [habits]);
      useEffect(() => { store('tasks', tasks); }, [tasks]);
      useEffect(() => { store('moods', moods); }, [moods]);
      useEffect(() => { store('journal', journal); }, [journal]);
      useEffect(() => { store('habitHistory', habitHistory); }, [habitHistory]);
      useEffect(() => { store('gameStats', gameStats); }, [gameStats]);
      useEffect(() => { store('challenges', challenges); }, [challenges]);
      useEffect(() => { store('brewType', brewType); }, [brewType]);
      useEffect(() => { store('isDark', isDark); }, [isDark]);
      useEffect(() => { store('highContrast', highContrast); }, [highContrast]);
      useEffect(() => { store('cafeName', cafeName); }, [cafeName]);
      useEffect(() => { store('ambientSound', ambientSound); }, [ambientSound]);
      useEffect(() => { store('soundAmbianceSource', soundAmbianceSource); }, [soundAmbianceSource]);
      useEffect(() => { store('soundMusicSource', soundMusicSource); }, [soundMusicSource]);
      useEffect(() => { store('ambianceVolume', ambianceVolume); }, [ambianceVolume]);
      useEffect(() => { store('musicVolume', musicVolume); }, [musicVolume]);
      useEffect(() => { store('soundMood', soundMood); }, [soundMood]);
      useEffect(() => { store('backgroundPlay', backgroundPlay); }, [backgroundPlay]);
      useEffect(() => { document.getElementById('themeColor').content = theme.themeColor; }, [theme]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED SOUNDSCAPE SYSTEM - Volume, Moods, Light/Dark
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const soundRefs = useRef({ ctx: null, nodes: [], intervals: [], ambianceGain: null, musicGain: null });

      // Mood configurations - affect tempo, density, brightness
      const moodConfigs = useMemo(() => ({
        cozy: { tempoMult: 1.0, skipChance: 0.25, brightness: 1.0, reverbMult: 1.0, desc: 'Warm & inviting', icon: 'ðŸ ' },
        chill: { tempoMult: 1.3, skipChance: 0.35, brightness: 0.9, reverbMult: 1.2, desc: 'Laid back vibes', icon: 'ðŸ˜Œ' },
        upbeat: { tempoMult: 0.7, skipChance: 0.15, brightness: 1.2, reverbMult: 0.8, desc: 'Energetic flow', icon: 'âœ¨' },
        soothing: { tempoMult: 1.5, skipChance: 0.4, brightness: 0.8, reverbMult: 1.3, desc: 'Gentle & calm', icon: 'ðŸŒŠ' },
        meditative: { tempoMult: 2.0, skipChance: 0.5, brightness: 0.7, reverbMult: 1.5, desc: 'Deep & contemplative', icon: 'ðŸ§˜' },
        focus: { tempoMult: 1.2, skipChance: 0.3, brightness: 1.0, reverbMult: 1.0, desc: 'Steady & consistent', icon: 'ðŸŽ¯' }
      }), []);

      // Light/Dark variants - light is brighter, dark is warmer/deeper
      const lightDarkMod = useMemo(() => ({
        filterMult: isDark ? 0.8 : 1.2,    // Dark = warmer (lower filter), Light = brighter
        octaveShift: isDark ? 0.5 : 1.0,   // Dark = lower octave option
        reverbMult: isDark ? 1.1 : 0.9,    // Dark = more reverb
        gainMult: isDark ? 0.9 : 1.0       // Dark = slightly quieter
      }), [isDark]);

      // Base sound profiles
      const soundProfiles = useMemo(() => ({
        coffee: {
          name: 'CafÃ©',
          icon: 'â˜•',
          ambiance: { type: 'cafe', baseFilterFreq: 280 },
          music: {
            baseScale: [130.81, 146.83, 164.81, 174.61, 196.00, 220.00, 246.94], // C3 major
            baseTempo: 3500,
            baseNoteLength: 2.5,
            baseReverb: 0.55,
            warmth: 650,
            style: 'piano'
          }
        },
        tea: {
          name: 'Rain',
          icon: 'ðŸµ',
          ambiance: { type: 'rain', baseFilterFreq: 450 },
          music: {
            baseScale: [392.00, 440.00, 493.88, 587.33, 659.25], // G4 pentatonic
            baseTempo: 4500,
            baseNoteLength: 3.0,
            baseReverb: 0.7,
            warmth: 950,
            style: 'chimes'
          }
        },
        matcha: {
          name: 'Wind',
          icon: 'ðŸƒ',
          ambiance: { type: 'wind', baseFilterFreq: 220 },
          music: {
            baseScale: [174.61, 196.00, 261.63, 293.66, 349.23], // Japanese In
            baseTempo: 7000,
            baseNoteLength: 5.0,
            baseReverb: 0.8,
            warmth: 400,
            style: 'bowls'
          }
        }
      }), []);

      // Get active profiles with mood and light/dark adjustments
      const activeAmbianceProfile = useMemo(() => {
        const source = soundAmbianceSource === 'auto' ? brewType : soundAmbianceSource;
        const base = soundProfiles[source];
        const mood = moodConfigs[soundMood];
        return {
          ...base,
          ambiance: {
            ...base.ambiance,
            filterFreq: base.ambiance.baseFilterFreq * lightDarkMod.filterMult * mood.brightness
          }
        };
      }, [soundAmbianceSource, brewType, soundProfiles, soundMood, moodConfigs, lightDarkMod]);
      
      const activeMusicProfile = useMemo(() => {
        const source = soundMusicSource === 'auto' ? brewType : soundMusicSource;
        const base = soundProfiles[source];
        const mood = moodConfigs[soundMood];
        return {
          ...base,
          music: {
            ...base.music,
            scale: base.music.baseScale.map(f => f * (isDark && Math.random() > 0.7 ? lightDarkMod.octaveShift : 1)),
            tempo: base.music.baseTempo * mood.tempoMult,
            noteLength: base.music.baseNoteLength * mood.tempoMult * 0.8,
            reverb: Math.min(0.95, base.music.baseReverb * mood.reverbMult * lightDarkMod.reverbMult),
            skipChance: mood.skipChance,
            warmth: base.music.warmth * lightDarkMod.filterMult
          }
        };
      }, [soundMusicSource, brewType, soundProfiles, soundMood, moodConfigs, lightDarkMod, isDark]);

      // Update volumes in real-time
      useEffect(() => {
        if (soundRefs.current.ambianceGain) {
          const baseGain = 0.06 * lightDarkMod.gainMult;
          soundRefs.current.ambianceGain.gain.value = baseGain * (ambianceVolume / 100);
        }
      }, [ambianceVolume, lightDarkMod.gainMult]);

      useEffect(() => {
        if (soundRefs.current.musicGain) {
          soundRefs.current.musicGain.gain.value = musicVolume / 100;
        }
      }, [musicVolume]);

      // Enhanced ambiance with more life
      const createAmbiance = useCallback((ctx, profile, gainNode) => {
        const bufferSize = 4 * ctx.sampleRate; // Longer buffer for more variation
        const noiseBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate); // Stereo
        
        for (let channel = 0; channel < 2; channel++) {
          const output = noiseBuffer.getChannelData(channel);
          
          if (profile.ambiance.type === 'cafe') {
            // CafÃ© ambiance: warm brown noise + subtle "life" modulation
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
              const white = Math.random() * 2 - 1;
              output[i] = (lastOut + (0.02 * white)) / 1.02;
              lastOut = output[i];
              // Add subtle "crowd murmur" modulation
              const murmur = Math.sin(i / ctx.sampleRate * 0.5 + channel) * 0.15 + 
                            Math.sin(i / ctx.sampleRate * 0.23) * 0.1;
              output[i] *= (1.8 + murmur);
            }
          } else if (profile.ambiance.type === 'rain') {
            // Rain: pink noise + occasional "droplet" emphasis
            let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
            for (let i = 0; i < bufferSize; i++) {
              const white = Math.random() * 2 - 1;
              b0 = 0.99886 * b0 + white * 0.0555179;
              b1 = 0.99332 * b1 + white * 0.0750759;
              b2 = 0.96900 * b2 + white * 0.1538520;
              b3 = 0.86650 * b3 + white * 0.3104856;
              b4 = 0.55000 * b4 + white * 0.5329522;
              b5 = -0.7616 * b5 - white * 0.0168980;
              // Rain intensity varies
              const rainMod = Math.sin(i / ctx.sampleRate * 0.08) * 0.2 + 0.9;
              output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.18 * rainMod;
              b6 = white * 0.115926;
            }
          } else if (profile.ambiance.type === 'wind') {
            // Wind through trees: modulated with "gusts"
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
              const white = Math.random() * 2 - 1;
              // Multi-layered wind modulation
              const gust1 = Math.sin(i / ctx.sampleRate * 0.15) * 0.3;
              const gust2 = Math.sin(i / ctx.sampleRate * 0.07 + 1.5) * 0.2;
              const rustling = Math.sin(i / ctx.sampleRate * 2.5) * 0.05;
              output[i] = (lastOut + (0.012 * white)) / 1.012;
              lastOut = output[i];
              output[i] *= (1.2 + gust1 + gust2 + rustling);
            }
          }
        }
        
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;
        
        // Triple filter for ultra-smooth sound
        const filter1 = ctx.createBiquadFilter();
        filter1.type = 'lowpass';
        filter1.frequency.value = profile.ambiance.filterFreq;
        filter1.Q.value = 0.4;
        
        const filter2 = ctx.createBiquadFilter();
        filter2.type = 'lowpass';
        filter2.frequency.value = profile.ambiance.filterFreq * 1.3;
        filter2.Q.value = 0.3;
        
        const filter3 = ctx.createBiquadFilter();
        filter3.type = 'highpass';
        filter3.frequency.value = 40; // Remove sub-bass rumble
        filter3.Q.value = 0.5;
        
        noise.connect(filter1);
        filter1.connect(filter2);
        filter2.connect(filter3);
        filter3.connect(gainNode);
        noise.start();
        
        return { noise, filters: [filter1, filter2, filter3] };
      }, []);

      // Create lush reverb
      const createReverb = useCallback((ctx, decay, isDarkMode) => {
        const length = ctx.sampleRate * (isDarkMode ? 5 : 4);
        const impulse = ctx.createBuffer(2, length, ctx.sampleRate);
        for (let c = 0; c < 2; c++) {
          const channel = impulse.getChannelData(c);
          for (let i = 0; i < length; i++) {
            const stereoOffset = c === 0 ? 0 : Math.random() * 0.002;
            channel[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay * 2.2 + stereoOffset);
          }
        }
        const convolver = ctx.createConvolver();
        convolver.buffer = impulse;
        return convolver;
      }, []);

      // Enhanced piano with more harmonics and realistic envelope
      const playPianoNote = useCallback((ctx, freq, profile, destination, mood) => {
        const now = ctx.currentTime;
        const noteLen = profile.music.noteLength;
        const brightness = moodConfigs[mood].brightness;
        
        const masterGain = ctx.createGain();
        const attackTime = 0.006 + Math.random() * 0.004; // Slight variation
        const peakGain = 0.065 * brightness;
        
        masterGain.gain.setValueAtTime(0, now);
        masterGain.gain.linearRampToValueAtTime(peakGain, now + attackTime);
        masterGain.gain.exponentialRampToValueAtTime(peakGain * 0.5, now + 0.15);
        masterGain.gain.exponentialRampToValueAtTime(peakGain * 0.25, now + noteLen * 0.4);
        masterGain.gain.exponentialRampToValueAtTime(0.001, now + noteLen);
        
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(profile.music.warmth * brightness, now);
        filter.frequency.exponentialRampToValueAtTime(profile.music.warmth * 0.5, now + noteLen * 0.7);
        filter.Q.value = 0.5;
        
        // Rich harmonics for authentic piano
        const harmonics = [
          { ratio: 1, gain: 1.0, decay: 1.0 },
          { ratio: 2, gain: 0.45, decay: 0.9 },
          { ratio: 3, gain: 0.22, decay: 0.8 },
          { ratio: 4, gain: 0.12, decay: 0.7 },
          { ratio: 5, gain: 0.06, decay: 0.6 },
          { ratio: 6, gain: 0.03, decay: 0.5 },
        ];
        
        harmonics.forEach(h => {
          if (freq * h.ratio < 8000) { // Don't exceed hearing range
            const osc = ctx.createOscillator();
            const oscGain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = freq * h.ratio * (1 + (Math.random() - 0.5) * 0.001); // Slight detune for richness
            oscGain.gain.setValueAtTime(h.gain, now);
            oscGain.gain.exponentialRampToValueAtTime(h.gain * h.decay * 0.3, now + noteLen * 0.6);
            
            osc.connect(oscGain);
            oscGain.connect(filter);
            osc.start(now);
            osc.stop(now + noteLen + 0.2);
          }
        });
        
        filter.connect(masterGain);
        masterGain.connect(destination);
      }, [moodConfigs]);

      // Enhanced chimes with shimmer and resonance
      const playChimeNote = useCallback((ctx, freq, profile, destination, mood) => {
        const now = ctx.currentTime;
        const noteLen = profile.music.noteLength;
        const brightness = moodConfigs[mood].brightness;
        
        // Main tone
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gainNode.gain.setValueAtTime(0.05 * brightness, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + noteLen);
        
        // Shimmer overtones
        const shimmerFreqs = [2.0, 3.01, 4.02]; // Slightly inharmonic for bell-like quality
        shimmerFreqs.forEach((mult, i) => {
          const shimmer = ctx.createOscillator();
          const shimmerGain = ctx.createGain();
          shimmer.type = 'sine';
          shimmer.frequency.value = freq * mult;
          shimmerGain.gain.setValueAtTime(0.015 / (i + 1), now);
          shimmerGain.gain.exponentialRampToValueAtTime(0.001, now + noteLen * (0.6 - i * 0.1));
          shimmer.connect(shimmerGain);
          shimmerGain.connect(destination);
          shimmer.start(now);
          shimmer.stop(now + noteLen);
        });
        
        osc.connect(gainNode);
        gainNode.connect(destination);
        osc.start(now);
        osc.stop(now + noteLen + 0.1);
      }, [moodConfigs]);

      // Enhanced singing bowls with complex beating
      const playBowlNote = useCallback((ctx, freq, profile, destination, mood) => {
        const now = ctx.currentTime;
        const noteLen = profile.music.noteLength * 1.2;
        
        // Multiple oscillators with slight detuning for rich beating
        const detunes = [0, 1.001, 1.003, 0.998];
        detunes.forEach((detune, i) => {
          const osc = ctx.createOscillator();
          const gainNode = ctx.createGain();
          osc.type = 'sine';
          osc.frequency.value = freq * detune;
          
          const attackTime = 0.8 + i * 0.2;
          const peakGain = 0.04 / (i + 1);
          
          gainNode.gain.setValueAtTime(0, now);
          gainNode.gain.linearRampToValueAtTime(peakGain, now + attackTime);
          gainNode.gain.setValueAtTime(peakGain, now + attackTime + 0.5);
          gainNode.gain.exponentialRampToValueAtTime(0.001, now + noteLen);
          
          osc.connect(gainNode);
          gainNode.connect(destination);
          osc.start(now);
          osc.stop(now + noteLen + 0.2);
        });
        
        // Add subtle high harmonic for "singing" quality
        const harmonic = ctx.createOscillator();
        const harmonicGain = ctx.createGain();
        harmonic.type = 'sine';
        harmonic.frequency.value = freq * 3;
        harmonicGain.gain.setValueAtTime(0, now);
        harmonicGain.gain.linearRampToValueAtTime(0.008, now + 1.5);
        harmonicGain.gain.exponentialRampToValueAtTime(0.001, now + noteLen * 0.7);
        harmonic.connect(harmonicGain);
        harmonicGain.connect(destination);
        harmonic.start(now);
        harmonic.stop(now + noteLen);
      }, []);

      const playNote = useCallback((ctx, freq, profile, destination, mood) => {
        if (profile.music.style === 'piano') {
          playPianoNote(ctx, freq, profile, destination, mood);
        } else if (profile.music.style === 'chimes') {
          playChimeNote(ctx, freq, profile, destination, mood);
        } else if (profile.music.style === 'bowls') {
          playBowlNote(ctx, freq, profile, destination, mood);
        }
      }, [playPianoNote, playChimeNote, playBowlNote]);

      const startMusic = useCallback((ctx, profile, reverb, musicGainNode, mood) => {
        const dryGain = ctx.createGain();
        const wetGain = ctx.createGain();
        dryGain.gain.value = 1 - profile.music.reverb;
        wetGain.gain.value = profile.music.reverb;
        
        dryGain.connect(musicGainNode);
        wetGain.connect(reverb);
        reverb.connect(musicGainNode);
        
        const merger = ctx.createGain();
        merger.connect(dryGain);
        merger.connect(wetGain);
        
        let lastNotes = [];
        const scale = profile.music.scale;
        
        const playRandomNote = () => {
          let noteIndex;
          do {
            noteIndex = Math.floor(Math.random() * scale.length);
          } while (lastNotes.includes(noteIndex) && scale.length > 3);
          
          lastNotes.push(noteIndex);
          if (lastNotes.length > 3) lastNotes.shift();
          
          // Skip based on mood
          if (Math.random() > profile.music.skipChance) {
            playNote(ctx, scale[noteIndex], profile, merger, mood);
            
            // Occasional chords for piano
            if (profile.music.style === 'piano' && Math.random() > 0.7) {
              const chordNote = (noteIndex + 2) % scale.length;
              setTimeout(() => playNote(ctx, scale[chordNote], profile, merger, mood), 60 + Math.random() * 40);
              
              // Sometimes add fifth for richer chord
              if (Math.random() > 0.6) {
                const fifthNote = (noteIndex + 4) % scale.length;
                setTimeout(() => playNote(ctx, scale[fifthNote] * 0.5, profile, merger, mood), 120);
              }
            }
          }
        };
        
        setTimeout(playRandomNote, 800 + Math.random() * 1000);
        
        const interval = setInterval(() => {
          const variance = profile.music.tempo * 0.35;
          const delay = Math.random() * variance;
          setTimeout(playRandomNote, delay);
        }, profile.music.tempo);
        
        return { interval, merger, dryGain, wetGain };
      }, [playNote]);

      const startSoundscape = useCallback(() => {
        if (soundRefs.current.ctx) return;
        
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          soundRefs.current.ctx = ctx;
          
          const nodes = [];
          const intervals = [];
          
          // Master gains for volume control
          const ambianceGainNode = ctx.createGain();
          const musicGainNode = ctx.createGain();
          const baseAmbianceGain = 0.06 * lightDarkMod.gainMult;
          ambianceGainNode.gain.value = baseAmbianceGain * (ambianceVolume / 100);
          musicGainNode.gain.value = musicVolume / 100;
          ambianceGainNode.connect(ctx.destination);
          musicGainNode.connect(ctx.destination);
          
          soundRefs.current.ambianceGain = ambianceGainNode;
          soundRefs.current.musicGain = musicGainNode;
          
          // Create reverb
          const reverb = createReverb(ctx, activeMusicProfile.music.reverb, isDark);
          nodes.push(reverb);
          
          // Start ambiance
          if (ambientSound === 'ambiance' || ambientSound === 'both') {
            const ambianceNodes = createAmbiance(ctx, activeAmbianceProfile, ambianceGainNode);
            nodes.push(ambianceNodes);
          }
          
          // Start music
          if (ambientSound === 'music' || ambientSound === 'both') {
            const musicNodes = startMusic(ctx, activeMusicProfile, reverb, musicGainNode, soundMood);
            nodes.push(musicNodes);
            intervals.push(musicNodes.interval);
          }
          
          soundRefs.current.nodes = nodes;
          soundRefs.current.intervals = intervals;
        } catch(e) { console.log('Audio not supported:', e); }
      }, [ambientSound, activeAmbianceProfile, activeMusicProfile, ambianceVolume, musicVolume, soundMood, isDark, lightDarkMod, createAmbiance, createReverb, startMusic]);

      const stopSoundscape = useCallback(() => {
        if (soundRefs.current.ctx) {
          try {
            soundRefs.current.intervals.forEach(i => clearInterval(i));
            soundRefs.current.ctx.close();
          } catch(e) {}
          soundRefs.current = { ctx: null, nodes: [], intervals: [], ambianceGain: null, musicGain: null };
        }
      }, []);

      // Restart when major settings change (not volume)
      useEffect(() => {
        if (soundEnabled && ambientSound !== 'off') {
          stopSoundscape();
          setTimeout(startSoundscape, 100);
        } else {
          stopSoundscape();
        }
        return () => stopSoundscape();
      }, [soundEnabled, ambientSound, soundAmbianceSource, soundMusicSource, soundMood, brewType, isDark, startSoundscape, stopSoundscape]);

      // Handle visibility change (pause when leaving app)
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (document.hidden && !backgroundPlay) {
            setSoundEnabled(false);
          }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, [backgroundPlay]);

      // Toggle sound helper
      const toggleSound = useCallback(() => {
        if (ambientSound === 'off') {
          setAmbientSound('both');
          setSoundEnabled(true);
        } else if (soundEnabled) {
          setSoundEnabled(false);
        } else {
          setSoundEnabled(true);
        }
      }, [ambientSound, soundEnabled]);

      // Daily reset & challenges
      useEffect(() => {
        const lastDate = gameStats.lastActiveDate;
        if (lastDate !== todayKey) {
          setHabits(h => h.map(habit => ({ ...habit, completed: false })));
          
          // Reset recurring tasks
          const dayOfWeek = getDayOfWeek();
          const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
          setTasks(t => t.map(task => {
            if (!task.recurring || task.recurring === 'none') return task;
            if (task.recurring === 'daily') return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            if (task.recurring === 'weekdays' && isWeekday) return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            if (task.recurring === 'weekly' && dayOfWeek === 1) return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            return task;
          }));
          
          const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
          const isConsecutive = lastDate === getDateKey(yesterday);
          if (!isConsecutive && lastDate && gameStats.freezesAvailable > 0) {
            setGameStats(s => ({ ...s, freezesUsed: s.freezesUsed + 1, freezesAvailable: s.freezesAvailable - 1 }));
            triggerCelebration(messages.freeze);
          }
          const weekNum = getWeekNumber();
          if (gameStats.weeklyFreeze !== weekNum) setGameStats(s => ({ ...s, freezesAvailable: 1, weeklyFreeze: weekNum }));
          setGameStats(s => ({ ...s, lastActiveDate: todayKey, appStreak: isConsecutive || (s.freezesUsed > 0) ? s.appStreak + 1 : 1, perfectDayToday: false }));
          
          // Weekly challenge reset
          if (challenges.weekly.week !== weekNum) {
            const newChallenge = weeklyChallengeDefs[Math.floor(Math.random() * weeklyChallengeDefs.length)];
            setChallenges(c => ({ ...c, weekly: { id: newChallenge.id, progress: 0, week: weekNum } }));
          }
          // Monthly challenge reset
          const monthKey = getMonthKey();
          if (challenges.monthly.month !== monthKey) {
            const newChallenge = monthlyChallengeDefs[Math.floor(Math.random() * monthlyChallengeDefs.length)];
            setChallenges(c => ({ ...c, monthly: { id: newChallenge.id, progress: 0, month: monthKey } }));
          }
        }
      }, []);

      // Timer
      useEffect(() => {
        if (timerRunning && timerSeconds > 0) {
          timerRef.current = setTimeout(() => setTimerSeconds(s => s - 1), 1000);
        } else if (timerRunning && timerSeconds === 0) {
          setTimerRunning(false);
          setSoundEnabled(false); // Stop sound when timer completes
          const elapsed = timerStartTime ? Math.round((Date.now() - timerStartTime) / 60000) : 25;
          setGameStats(s => ({ ...s, totalFocusMinutes: s.totalFocusMinutes + elapsed }));
          updateChallengeProgress('focus', elapsed);
          addXP(elapsed);
          triggerCelebration(messages.timerDone);
          if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
        }
        return () => clearTimeout(timerRef.current);
      }, [timerRunning, timerSeconds]);

      // Badge checking
      useEffect(() => {
        const newBadges = badges.filter(b => !gameStats.unlockedBadges.includes(b.id) && b.check(gameStats));
        if (newBadges.length > 0) {
          const updated = [...gameStats.unlockedBadges, ...newBadges.map(b => b.id)];
          setGameStats(s => ({ ...s, unlockedBadges: updated }));
          newBadges.forEach((b, i) => setTimeout(() => { triggerCelebration(`ðŸ† ${b.name}!`); addXP(50); }, i * 1500));
        }
      }, [gameStats, badges]);

      // XP and levels
      const currentLevel = useMemo(() => { for (let i = levels.length - 1; i >= 0; i--) { if (gameStats.xp >= levels[i].xp) return levels[i]; } return levels[0]; }, [gameStats.xp, levels]);
      const nextLevel = useMemo(() => { const idx = levels.findIndex(l => l.level === currentLevel.level); return levels[idx + 1] || null; }, [currentLevel, levels]);
      const xpProgress = useMemo(() => { if (!nextLevel) return 100; const min = currentLevel.xp; const need = nextLevel.xp - min; const have = gameStats.xp - min; return Math.round((have / need) * 100); }, [gameStats.xp, currentLevel, nextLevel]);
      const addXP = (amount) => setGameStats(s => ({ ...s, xp: s.xp + amount }));
      const triggerCelebration = (msg) => { setCelebration(msg); if ('vibrate' in navigator) navigator.vibrate(100); setTimeout(() => setCelebration(null), 2500); };

      // Challenge progress
      const updateChallengeProgress = (type, amount = 1) => {
        setChallenges(c => {
          const updated = { ...c };
          // Weekly
          const wDef = weeklyChallengeDefs.find(d => d.id === c.weekly.id);
          if (wDef && wDef.type === type) {
            updated.weekly = { ...c.weekly, progress: c.weekly.progress + amount };
            if (updated.weekly.progress >= wDef.target && c.weekly.progress < wDef.target) {
              setTimeout(() => { addXP(wDef.xp); triggerCelebration(`ðŸ… Challenge Complete: ${wDef.name}!`); setGameStats(s => ({ ...s, challengesCompleted: s.challengesCompleted + 1 })); }, 500);
            }
          }
          // Monthly
          const mDef = monthlyChallengeDefs.find(d => d.id === c.monthly.id);
          if (mDef && mDef.type === type) {
            updated.monthly = { ...c.monthly, progress: c.monthly.progress + amount };
            if (updated.monthly.progress >= mDef.target && c.monthly.progress < mDef.target) {
              setTimeout(() => { addXP(mDef.xp); triggerCelebration(`ðŸ… Monthly Challenge: ${mDef.name}!`); setGameStats(s => ({ ...s, challengesCompleted: s.challengesCompleted + 1 })); }, 500);
            }
          }
          return updated;
        });
      };

      // Daily tip
      const dailyTip = useMemo(() => getDailyTip(gameStats, brewType), [gameStats, brewType]);
      const dismissDailyTip = () => { setShowDailyTip(false); store('lastTipDate', todayKey); };

      // Habit actions
      const toggleHabit = (id) => {
        const habit = habits.find(h => h.id === id);
        const nowComplete = !habit.completed;
        const newHistory = { ...(habit.history || habitHistory[id] || {}), [todayKey]: nowComplete };
        setHabitHistory(h => ({ ...h, [id]: newHistory }));
        setHabits(habits.map(h => {
          if (h.id !== id) return h;
          if (nowComplete) { addXP(10); updateChallengeProgress('habits'); const newStreak = h.streak + 1; setGameStats(s => ({ ...s, totalHabitsCompleted: s.totalHabitsCompleted + 1, maxStreak: Math.max(s.maxStreak, newStreak) })); if (newStreak % 7 === 0) triggerCelebration(`ðŸ”¥ ${newStreak} day streak!`); }
          return { ...h, completed: nowComplete, streak: nowComplete ? h.streak + 1 : Math.max(0, h.streak - 1), history: newHistory };
        }));
        checkPerfectDay();
      };

      const addHabit = () => { if (!newHabit.name.trim()) return; setHabits([...habits, { id: Date.now(), name: newHabit.name, icon: newHabit.icon, completed: false, streak: 0, history: {} }]); setNewHabit({ name: '', icon: 'ðŸ’§' }); setShowAddHabit(false); setShowQuickAdd(false); };
      const deleteHabit = (id) => { const habit = habits.find(h => h.id === id); setHabits(habits.filter(h => h.id !== id)); setUndoAction({ type: 'habit', action: () => setHabits(h => [...h, habit]) }); setTimeout(() => setUndoAction(null), 4000); };
      const reorderHabit = (id, dir) => { const idx = habits.findIndex(h => h.id === id); if ((dir === -1 && idx === 0) || (dir === 1 && idx === habits.length - 1)) return; const n = [...habits]; [n[idx], n[idx + dir]] = [n[idx + dir], n[idx]]; setHabits(n); };

      // Task actions
      const toggleTask = (id) => {
        setTasks(tasks.map(t => {
          if (t.id !== id) return t;
          const nowDone = !t.done;
          if (nowDone) { addXP(15); updateChallengeProgress('tasks'); const hour = new Date().getHours(); setGameStats(s => ({ ...s, totalTasksCompleted: s.totalTasksCompleted + 1, earlyTasks: hour < 8 ? s.earlyTasks + 1 : s.earlyTasks, lateTasks: hour >= 22 ? s.lateTasks + 1 : s.lateTasks })); }
          return { ...t, done: nowDone };
        }));
        checkPerfectDay();
      };

      const toggleSubtask = (taskId, subIdx) => { setTasks(tasks.map(t => { if (t.id !== taskId) return t; const subs = [...(t.subtasks || [])]; subs[subIdx] = { ...subs[subIdx], done: !subs[subIdx].done }; const allDone = subs.every(s => s.done); return { ...t, subtasks: subs, done: allDone ? true : t.done }; })); };
      const addSubtaskToTask = (taskId, text) => { if (!text.trim()) return; setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), { text, done: false }] } : t)); setNewSubtask(''); setShowSubtaskInput(null); };
      const addTask = () => { if (!newTask.text.trim()) return; setTasks([...tasks, { ...newTask, id: Date.now(), done: false, lastReset: todayKey }]); setNewTask({ text: '', time: '', priority: 'medium', category: null, recurring: 'none', subtasks: [] }); setShowAddTask(false); setShowQuickAdd(false); };
      const deleteTask = (id) => { const task = tasks.find(t => t.id === id); setTasks(tasks.filter(t => t.id !== id)); setUndoAction({ type: 'task', action: () => setTasks(ts => [...ts, task]) }); setTimeout(() => setUndoAction(null), 4000); };

      const checkPerfectDay = () => { setTimeout(() => { const allH = habits.length > 0 && habits.every(h => h.completed); const activeTasks = tasks.filter(t => !t.recurring || t.recurring === 'none' || (t.recurring === 'daily') || (t.recurring === 'weekdays' && getDayOfWeek() >= 1 && getDayOfWeek() <= 5) || (t.recurring === 'weekly' && getDayOfWeek() === 1)); const allT = activeTasks.length === 0 || activeTasks.every(t => t.done); if (allH && allT && !gameStats.perfectDayToday) { setGameStats(s => ({ ...s, perfectDays: s.perfectDays + 1, perfectDayToday: true })); updateChallengeProgress('perfect'); triggerCelebration('âœ¨ Perfect day!'); addXP(50); } }, 100); };

      const setMood = (value) => { const isNew = !moods[todayKey]; setMoods({ ...moods, [todayKey]: { value, time: Date.now() } }); setGameStats(s => ({ ...s, lastMoodValue: value, moodDaysTracked: isNew ? s.moodDaysTracked + 1 : s.moodDaysTracked })); if (isNew) { addXP(5); updateChallengeProgress('moods'); } };
      const saveJournal = () => { const isNew = !journal[todayKey]; setJournal({ ...journal, [todayKey]: todayJournal }); if (isNew && (todayJournal.gratitude || todayJournal.reflection || todayJournal.tomorrow)) { setGameStats(s => ({ ...s, journalEntries: s.journalEntries + 1 })); updateChallengeProgress('journal'); addXP(10); } };

      // Share
      const shareAchievement = async (text) => {
        const shareData = { title: 'My Daily Brew', text: text, url: 'https://mydailybrew.app' };
        try {
          if (navigator.share) { await navigator.share(shareData); setGameStats(s => ({ ...s, timesShared: s.timesShared + 1 })); triggerCelebration('ðŸ“¤ Shared!'); }
          else { await navigator.clipboard.writeText(text); triggerCelebration('ðŸ“‹ Copied to clipboard!'); setGameStats(s => ({ ...s, timesShared: s.timesShared + 1 })); }
        } catch(e) { console.log('Share failed'); }
      };

      // Export
      const exportData = () => {
        const data = { habits, tasks, moods, journal, gameStats, cafeName, brewType, exportDate: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `daily-brew-backup-${todayKey}.json`; a.click();
        URL.revokeObjectURL(url);
        setGameStats(s => ({ ...s, timesExported: s.timesExported + 1 }));
        triggerCelebration('ðŸ’¾ Data exported!');
        setShowExport(false);
      };

      const dismissWhatsNew = () => { setShowWhatsNew(false); store('lastSeenVersion', APP_VERSION); if (!load('tutorialSeen', false)) setShowTutorial(true); };
      const dismissTutorial = () => { setShowTutorial(false); store('tutorialSeen', true); };

      // Stats
      const completedHabits = habits.filter(h => h.completed).length;
      const dayOfWeek = getDayOfWeek();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      const isMonday = dayOfWeek === 1;
      const todayTasks = tasks.filter(t => {
        if (!t.recurring || t.recurring === 'none') return true;
        if (t.recurring === 'daily') return true;
        if (t.recurring === 'weekdays' && isWeekday) return true;
        if (t.recurring === 'weekly' && isMonday) return true;
        return false;
      });
      const completedTasks = todayTasks.filter(t => t.done).length;
      const progress = Math.round(((completedHabits + completedTasks) / Math.max(1, habits.length + todayTasks.length)) * 100);

      // Calendar
      const calMonth = calendarDate.getMonth();
      const calYear = calendarDate.getFullYear();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const calDays = useMemo(() => { const d = []; for (let i = 0; i < firstDay; i++) d.push(null); for (let i = 1; i <= daysInMonth; i++) d.push(new Date(calYear, calMonth, i)); return d; }, [calYear, calMonth, firstDay, daysInMonth]);

      // Heatmap
      const heatmapData = useMemo(() => {
        const weeks = [];
        for (let w = 11; w >= 0; w--) {
          const week = [];
          for (let d = 0; d < 7; d++) {
            const date = new Date(); date.setDate(date.getDate() - (w * 7 + (6 - d)));
            const key = getDateKey(date);
            const completedCount = habits.filter(h => (h.history || habitHistory[h.id] || {})[key]).length;
            week.push({ date: key, count: completedCount, total: habits.length });
          }
          weeks.push(week);
        }
        return weeks;
      }, [habits, habitHistory]);

      // Year review
      // Mood Insights - correlate mood with habits
      const moodInsights = useMemo(() => {
        const moodDays = Object.entries(moods);
        if (moodDays.length < 3) return null;
        
        // Calculate average mood on high vs low habit completion days
        let highCompletionMoods = [];
        let lowCompletionMoods = [];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const moodByDay = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
        
        moodDays.forEach(([dateKey, moodData]) => {
          const date = new Date(dateKey);
          const dow = date.getDay();
          moodByDay[dow].push(moodData.value);
          
          // Check habit completion for that day
          const completedCount = habits.filter(h => (h.history || habitHistory[h.id] || {})[dateKey]).length;
          const completionRate = habits.length > 0 ? completedCount / habits.length : 0;
          
          if (completionRate >= 0.7) highCompletionMoods.push(moodData.value);
          else if (completionRate <= 0.3) lowCompletionMoods.push(moodData.value);
        });
        
        const avgHighCompletion = highCompletionMoods.length > 0 ? (highCompletionMoods.reduce((a, b) => a + b, 0) / highCompletionMoods.length).toFixed(1) : null;
        const avgLowCompletion = lowCompletionMoods.length > 0 ? (lowCompletionMoods.reduce((a, b) => a + b, 0) / lowCompletionMoods.length).toFixed(1) : null;
        
        // Find best/worst mood days
        const avgByDay = dayNames.map((name, i) => ({
          name,
          avg: moodByDay[i].length > 0 ? moodByDay[i].reduce((a, b) => a + b, 0) / moodByDay[i].length : null,
          count: moodByDay[i].length
        })).filter(d => d.count >= 2);
        
        const bestDay = avgByDay.length > 0 ? avgByDay.reduce((best, d) => d.avg > (best?.avg || 0) ? d : best, null) : null;
        const moodDiff = avgHighCompletion && avgLowCompletion ? (avgHighCompletion - avgLowCompletion).toFixed(1) : null;
        
        return { avgHighCompletion, avgLowCompletion, moodDiff, bestDay, hasEnoughData: moodDays.length >= 7 };
      }, [moods, habits, habitHistory]);

      const yearReview = useMemo(() => {
        const yearMoods = Object.entries(moods).filter(([k]) => k.startsWith(`${currentYear}`));
        const avgMood = yearMoods.length ? (yearMoods.reduce((s, [, v]) => s + v.value, 0) / yearMoods.length).toFixed(1) : null;
        const moodCounts = yearMoods.reduce((a, [, v]) => { a[v.value] = (a[v.value] || 0) + 1; return a; }, {});
        const totalJournal = Object.keys(journal).filter(k => k.startsWith(`${currentYear}`)).length;
        return { avgMood, moodCounts, totalJournal, daysTracked: yearMoods.length, totalHabits: gameStats.totalHabitsCompleted, totalTasks: gameStats.totalTasksCompleted, totalFocus: gameStats.totalFocusMinutes, longestStreak: gameStats.maxStreak, badgesEarned: gameStats.unlockedBadges.length };
      }, [moods, journal, gameStats, currentYear]);

      // Challenge display
      const weeklyChallenge = weeklyChallengeDefs.find(c => c.id === challenges.weekly.id);
      const monthlyChallenge = monthlyChallengeDefs.find(c => c.id === challenges.monthly.id);

      // Styles
      const s = {
        card: { background: theme.cardBg, border: `1px solid ${theme.cardBorder}`, borderRadius: '16px', padding: '14px', marginBottom: '10px' },
        btn: { background: theme.accentGradient, color: theme.isDark ? '#1a1a1a' : '#fff', border: 'none', borderRadius: '12px', padding: '12px 20px', fontFamily: "'Lora',serif", fontWeight: 600, cursor: 'pointer' },
        btnSecondary: { background: theme.progressBg, color: theme.text, border: `1px solid ${theme.cardBorder}`, borderRadius: '12px', padding: '10px 16px', fontFamily: "'Lora',serif", fontWeight: 500, cursor: 'pointer' },
        input: { background: theme.inputBg, border: `1px solid ${theme.inputBorder}`, borderRadius: '12px', padding: '12px', fontFamily: "'Lora',serif", fontSize: '1rem', color: theme.text, width: '100%', outline: 'none' },
        navItem: (a) => ({ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', padding: '8px 12px', borderRadius: '12px', background: a ? theme.accentGradient : 'transparent', color: a ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.textSecondary, border: 'none', cursor: 'pointer', fontFamily: "'Lora',serif", fontSize: '9px', fontWeight: a ? 600 : 400 }),
        fab: { position: 'fixed', bottom: '90px', right: '20px', width: '56px', height: '56px', borderRadius: '50%', background: theme.accentGradient, border: 'none', fontSize: '24px', cursor: 'pointer', boxShadow: '0 4px 20px rgba(0,0,0,0.3)', zIndex: 99, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.isDark ? '#1a1a1a' : '#fff' },
        modal: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(8px)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' },
        modalContent: { background: theme.modalBg, borderRadius: '20px', maxWidth: '360px', width: '100%', padding: '20px', maxHeight: '85vh', overflow: 'auto' }
      };

      return (
        <div style={{ minHeight: '100vh', background: theme.bg, transition: 'background 0.4s', filter: highContrast ? 'contrast(1.2)' : 'none' }}>
          <style>{`
            .hw { font-family: 'Caveat', cursive; }
            .bt { font-family: 'Lora', serif; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
            @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
            .fade { animation: fadeIn 0.3s; }
            .slide { animation: slideUp 0.4s; }
            .pop { animation: pop 0.3s; }
            .pulse { animation: pulse 2s infinite; }
            .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
          `}</style>

          <div style={{ maxWidth: '28rem', margin: '0 auto', padding: '16px 14px 100px' }}>
            {/* Header with seasonal decoration */}
            <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '14px' }}>
              <div>
                <h1 className="hw" style={{ fontSize: '1.6rem', color: theme.text, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }} aria-label={`${cafeName} - ${brewThemes[brewType].name} theme`}>
                  {brewThemes[brewType].icon} {cafeName} <span style={{ fontSize: '0.9rem' }}>{seasonDeco.emoji}</span>
                </h1>
                <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginTop: '2px' }}>{today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</p>
              </div>
              <div style={{ display: 'flex', gap: '6px' }}>
                <button onClick={() => setShowSoundMenu(true)} aria-label="Sound settings" style={{ background: soundEnabled ? theme.accentGradient : theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer', position: 'relative' }}>
                  <span>{soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'}</span>
                  {soundEnabled && <span style={{ position: 'absolute', top: '-2px', right: '-2px', width: '8px', height: '8px', background: '#4ade80', borderRadius: '50%', border: '2px solid ' + theme.bg }} />}
                </button>
                <button onClick={() => setShowThemePicker(true)} aria-label="Change theme" style={{ background: theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span>{brewThemes[brewType].icon}</span>
                  <span style={{ fontSize: '0.75rem' }}>{isDark ? 'ðŸŒ™' : 'â˜€ï¸'}</span>
                </button>
                <button onClick={() => setShowSettings(true)} aria-label="Settings" style={{ background: theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer' }}>âš™ï¸</button>
              </div>
            </header>

            {/* XP Bar */}
            <div style={{ ...s.card, padding: '10px 14px', display: 'flex', alignItems: 'center', gap: '10px' }} onClick={() => setShowBadges(true)} role="button" aria-label={`Level ${currentLevel.level}: ${currentLevel.title}. ${gameStats.xp} XP. Tap to view badges.`}>
              <div style={{ fontSize: '1.3rem' }}>{currentLevel.icon}</div>
              <div style={{ flex: 1 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '3px' }}>
                  <span className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.text }}>{currentLevel.title}</span>
                  <span className="bt" style={{ fontSize: '0.65rem', color: theme.textMuted }}>{gameStats.xp} XP</span>
                </div>
                <div style={{ height: '5px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }} role="progressbar" aria-valuenow={xpProgress} aria-valuemin="0" aria-valuemax="100">
                  <div style={{ height: '100%', width: `${xpProgress}%`, background: theme.xpBar, borderRadius: '999px', transition: 'width 0.5s' }} />
                </div>
              </div>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: '0.7rem', color: theme.textMuted }}>ðŸ† {gameStats.unlockedBadges.length}/{badges.length}</div>
                {gameStats.freezesAvailable > 0 && <div style={{ fontSize: '0.6rem', color: theme.accent }}>â„ï¸ {gameStats.freezesAvailable}</div>}
              </div>
            </div>

            {/* Daily Tip Card */}
            {showDailyTip && (
              <div style={{ ...s.card, background: theme.accentLight, borderColor: theme.accent }} className="slide">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                  <div style={{ flex: 1 }}>
                    <p className="bt" style={{ fontSize: '0.7rem', color: theme.accent, fontWeight: 600, marginBottom: '4px' }}>ðŸ¤– Today's Barista Tip</p>
                    <p className="bt" style={{ fontSize: '0.85rem', color: theme.text, lineHeight: 1.4 }}>{dailyTip}</p>
                  </div>
                  <button onClick={dismissDailyTip} style={{ background: 'none', border: 'none', color: theme.textMuted, cursor: 'pointer', padding: '4px' }}>Ã—</button>
                </div>
              </div>
            )}

            {/* TODAY TAB */}
            {activeTab === 'today' && (
              <div className="fade">
                {/* Progress */}
                <div style={s.card}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                    <div>
                      <p className="bt" style={{ fontSize: '0.65rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: theme.textSecondary }}>Today's Progress</p>
                      <p style={{ fontSize: '1.75rem', fontWeight: 600, color: theme.text }}>{progress}%</p>
                    </div>
                    <div className="bt" style={{ textAlign: 'right', fontSize: '0.75rem', color: theme.textSecondary }}>
                      <p><span style={{ color: theme.text, fontWeight: 600 }}>{completedHabits}</span>/{habits.length} habits</p>
                      <p><span style={{ color: theme.text, fontWeight: 600 }}>{completedTasks}</span>/{todayTasks.length} tasks</p>
                    </div>
                  </div>
                  <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                    <div style={{ height: '100%', width: `${progress}%`, background: theme.accentGradient, borderRadius: '999px', transition: 'width 0.5s' }} />
                  </div>
                </div>

                {/* Mood */}
                <div style={s.card}>
                  <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '8px' }}>How are you feeling?</p>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: '5px' }} role="radiogroup" aria-label="Mood selection">
                    {moodEmojis.map(m => (
                      <button key={m.value} onClick={() => setMood(m.value)} className={moods[todayKey]?.value === m.value ? 'pop' : ''} aria-pressed={moods[todayKey]?.value === m.value} style={{ flex: 1, padding: '8px 4px', borderRadius: '12px', border: moods[todayKey]?.value === m.value ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, background: moods[todayKey]?.value === m.value ? theme.accentLight : 'transparent', cursor: 'pointer' }}>
                        <div style={{ fontSize: '1.2rem' }}>{m.emoji}</div>
                        <div className="bt" style={{ fontSize: '0.5rem', color: theme.textMuted, marginTop: '2px' }}>{m.label}</div>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Active Challenges Preview */}
                {(weeklyChallenge || monthlyChallenge) && (
                  <div style={{ ...s.card, cursor: 'pointer' }} onClick={() => setShowChallenges(true)}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                      <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text }}>ðŸ† Active Challenges</p>
                      <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>View all â†’</span>
                    </div>
                    {weeklyChallenge && (
                      <div style={{ marginBottom: '6px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                          <span className="bt" style={{ color: theme.textSecondary }}>{weeklyChallenge.icon} {weeklyChallenge.name}</span>
                          <span className="bt" style={{ color: theme.accent }}>{challenges.weekly.progress}/{weeklyChallenge.target}</span>
                        </div>
                        <div style={{ height: '4px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                          <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Habits */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '14px 0 8px' }}>
                  <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>â­ Habits</h2>
                  <button onClick={() => setShowAddHabit(true)} style={{ ...s.btn, padding: '5px 12px', fontSize: '1rem' }} aria-label="Add habit">+</button>
                </div>

                {habits.length === 0 && <p className="bt" style={{ textAlign: 'center', color: theme.textMuted, padding: '16px' }}>{messages.emptyHabits}</p>}

                {habits.map(h => (
                  <SwipeableCard key={h.id} onSwipeRight={() => toggleHabit(h.id)} onSwipeLeft={() => deleteHabit(h.id)} style={{ ...s.card, display: 'flex', alignItems: 'center', gap: '10px', borderColor: h.completed ? theme.success : theme.cardBorder }}>
                    <button onClick={() => toggleHabit(h.id)} className={h.completed ? 'pop' : ''} aria-pressed={h.completed} style={{ width: '40px', height: '40px', borderRadius: '12px', border: h.completed ? 'none' : `2px solid ${theme.inputBorder}`, background: h.completed ? theme.accentGradient : theme.progressBg, fontSize: '1rem', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: h.completed ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text, flexShrink: 0 }}>
                      {h.completed ? 'âœ“' : h.icon}
                    </button>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p className="bt" style={{ fontSize: '0.9rem', fontWeight: 500, color: h.completed ? theme.textMuted : theme.text, textDecoration: h.completed ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{h.name}</p>
                      <span className="bt" style={{ fontSize: '0.6rem', padding: '2px 6px', borderRadius: '999px', background: theme.streakGradient, color: theme.isDark ? '#1a1a1a' : '#fff' }}>ðŸ”¥ {h.streak}d</span>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                      <button onClick={() => reorderHabit(h.id, -1)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }} aria-label="Move up">â–²</button>
                      <button onClick={() => reorderHabit(h.id, 1)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }} aria-label="Move down">â–¼</button>
                    </div>
                    <button onClick={() => deleteHabit(h.id)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }} aria-label="Delete habit">Ã—</button>
                  </SwipeableCard>
                ))}

                {/* Tasks */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '14px 0 8px' }}>
                  <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>âœ“ Tasks</h2>
                  <button onClick={() => setShowAddTask(true)} style={{ ...s.btn, padding: '5px 12px', fontSize: '1rem' }} aria-label="Add task">+</button>
                </div>

                {todayTasks.length === 0 && <p className="bt" style={{ textAlign: 'center', color: theme.textMuted, padding: '16px' }}>{messages.emptyTasks}</p>}

                {todayTasks.sort((a, b) => ({ high: 0, medium: 1, low: 2 })[a.priority] - ({ high: 0, medium: 1, low: 2 })[b.priority]).map(task => {
                  const cat = categories.find(c => c.id === task.category);
                  const subtasksDone = (task.subtasks || []).filter(st => st.done).length;
                  const subtasksTotal = (task.subtasks || []).length;
                  return (
                    <SwipeableCard key={task.id} onSwipeRight={() => toggleTask(task.id)} onSwipeLeft={() => deleteTask(task.id)} style={{ ...s.card, opacity: task.done ? 0.7 : 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <button onClick={() => toggleTask(task.id)} className={task.done ? 'pop' : ''} style={{ width: '36px', height: '36px', borderRadius: '12px', border: task.done ? 'none' : `2px solid ${theme.inputBorder}`, background: task.done ? theme.accentGradient : theme.progressBg, fontSize: '0.9rem', cursor: 'pointer', flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', color: task.done ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text }}>
                          {task.done && 'âœ“'}
                        </button>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 500, color: task.done ? theme.textMuted : theme.text, textDecoration: task.done ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{task.text}</p>
                          <div style={{ display: 'flex', gap: '4px', alignItems: 'center', marginTop: '3px', flexWrap: 'wrap' }}>
                            {task.time && <span className="bt" style={{ fontSize: '0.6rem', color: theme.textSecondary }}>ðŸ• {formatTime(task.time)}</span>}
                            {cat && <span style={{ fontSize: '0.55rem', padding: '1px 5px', borderRadius: '4px', background: `${cat.color}22`, color: cat.color }}>{cat.icon}</span>}
                            {task.recurring && task.recurring !== 'none' && <span className="bt" style={{ fontSize: '0.55rem', color: theme.accent }}>ðŸ”„ {task.recurring === 'daily' ? 'Daily' : task.recurring === 'weekdays' ? 'Weekdays' : 'Weekly'}</span>}
                            {subtasksTotal > 0 && <span className="bt" style={{ fontSize: '0.55rem', color: theme.textMuted }}>ðŸ“‹ {subtasksDone}/{subtasksTotal}</span>}
                          </div>
                        </div>
                        <button onClick={() => deleteTask(task.id)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }}>Ã—</button>
                      </div>
                      {subtasksTotal > 0 && (
                        <div style={{ marginTop: '8px', paddingLeft: '46px' }}>
                          {task.subtasks.map((st, i) => (
                            <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                              <button onClick={() => toggleSubtask(task.id, i)} style={{ width: '18px', height: '18px', borderRadius: '5px', border: st.done ? 'none' : `1px solid ${theme.inputBorder}`, background: st.done ? theme.accent : 'transparent', fontSize: '0.6rem', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff' }}>{st.done && 'âœ“'}</button>
                              <span className="bt" style={{ fontSize: '0.75rem', color: st.done ? theme.textMuted : theme.textSecondary, textDecoration: st.done ? 'line-through' : 'none' }}>{st.text}</span>
                            </div>
                          ))}
                        </div>
                      )}
                      {showSubtaskInput === task.id ? (
                        <div style={{ marginTop: '8px', paddingLeft: '46px', display: 'flex', gap: '6px' }}>
                          <input value={newSubtask} onChange={e => setNewSubtask(e.target.value)} placeholder="Add subtask..." style={{ ...s.input, padding: '8px', fontSize: '0.8rem', flex: 1 }} onKeyPress={e => e.key === 'Enter' && addSubtaskToTask(task.id, newSubtask)} autoFocus />
                          <button onClick={() => addSubtaskToTask(task.id, newSubtask)} style={{ ...s.btn, padding: '8px 12px', fontSize: '0.8rem' }}>+</button>
                        </div>
                      ) : (
                        <button onClick={() => setShowSubtaskInput(task.id)} className="bt" style={{ marginTop: '6px', marginLeft: '46px', background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }}>+ Add subtask</button>
                      )}
                    </SwipeableCard>
                  );
                })}

                {/* Motivational */}
                <div style={{ ...s.card, textAlign: 'center', marginTop: '12px' }}>
                  <span style={{ fontSize: '1.1rem' }}>{brewThemes[brewType].icon}</span>
                  <p className="hw" style={{ fontSize: '1rem', color: theme.textSecondary, marginTop: '4px' }}>
                    {progress === 100 ? messages.perfect : progress > 60 ? messages.good : messages.start}
                  </p>
                </div>
              </div>
            )}

            {/* TIMER TAB */}
            {activeTab === 'timer' && (
              <div className="fade">
                <div style={{ ...s.card, textAlign: 'center', padding: '24px 16px' }}>
                  <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '4px' }}>â±ï¸ Focus Time</h2>
                  <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '16px' }}>{timerTask || messages.timerFocus}</p>
                  <div style={{ fontSize: '3rem', fontWeight: 300, color: theme.text, fontFamily: "'Lora',serif", marginBottom: '16px' }} aria-live="polite">{formatTimer(timerSeconds)}</div>
                  
                  {/* Sound Settings Button */}
                  <div style={{ marginBottom: '16px', display: 'flex', gap: '8px', justifyContent: 'center', alignItems: 'center' }}>
                    <button onClick={() => setShowSoundMenu(true)} style={{ ...s.btnSecondary, display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px' }}>
                      <span style={{ fontSize: '1.1rem' }}>{ambientSound === 'off' ? 'ðŸ”‡' : ambientSound === 'ambiance' ? 'ðŸŒ§ï¸' : ambientSound === 'music' ? 'ðŸŽ¹' : 'âœ¨'}</span>
                      <span className="bt" style={{ fontSize: '0.8rem' }}>
                        {ambientSound === 'off' ? 'Sound Off' : 
                         ambientSound === 'ambiance' ? `${activeAmbianceProfile.name.split(' ')[0]} Ambiance` :
                         ambientSound === 'music' ? `${activeMusicProfile.music.style === 'piano' ? 'Piano' : activeMusicProfile.music.style === 'chimes' ? 'Chimes' : 'Bowls'}` :
                         'Full Soundscape'}
                      </span>
                      <span style={{ fontSize: '0.7rem', opacity: 0.7 }}>â–¼</span>
                    </button>
                    {ambientSound !== 'off' && (
                      <button 
                        onClick={() => setSoundEnabled(!soundEnabled)} 
                        style={{ 
                          ...s.btnSecondary, 
                          padding: '10px 14px',
                          background: soundEnabled ? theme.accentGradient : theme.progressBg,
                          color: soundEnabled ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text
                        }}
                      >
                        {soundEnabled ? 'â¸' : 'â–¶'}
                      </button>
                    )}
                  </div>

                  <div style={{ display: 'flex', gap: '8px', justifyContent: 'center', marginBottom: '16px' }}>
                    {!timerRunning ? (
                      <button onClick={() => { setTimerRunning(true); setTimerStartTime(Date.now()); if (ambientSound !== 'off') setSoundEnabled(true); }} style={{ ...s.btn, padding: '10px 24px' }}>â–¶ Start</button>
                    ) : (
                      <button onClick={() => { setTimerRunning(false); setSoundEnabled(false); }} style={{ ...s.btn, padding: '10px 24px' }}>â¸ Pause</button>
                    )}
                    <button onClick={() => { setTimerRunning(false); setTimerSeconds(25 * 60); setTimerTask(null); setTimerStartTime(null); setSoundEnabled(false); }} style={s.btnSecondary}>â†º</button>
                  </div>
                  <div style={{ display: 'flex', gap: '6px', justifyContent: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    {[5, 15, 25, 45, 60].map(m => (
                      <button key={m} onClick={() => { setTimerSeconds(m * 60); setTimerRunning(false); }} style={{ padding: '6px 12px', borderRadius: '8px', border: `1px solid ${theme.cardBorder}`, background: 'transparent', color: theme.textSecondary, fontFamily: "'Lora',serif", fontSize: '0.75rem', cursor: 'pointer' }}>{m}m</button>
                    ))}
                  </div>
                  <button onClick={() => setShowCustomTimer(true)} className="bt" style={{ background: 'none', border: 'none', color: theme.accent, fontSize: '0.8rem', cursor: 'pointer' }}>âš™ï¸ Custom time</button>
                </div>

                {soundEnabled && ambientSound !== 'off' && (
                  <div style={{ ...s.card, textAlign: 'center', background: theme.accentLight }} className="pulse">
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', flexWrap: 'wrap' }}>
                      <p className="bt" style={{ fontSize: '0.8rem', color: theme.accent }}>
                        ðŸŽµ {ambientSound === 'ambiance' && `${activeAmbianceProfile.icon} ${activeAmbianceProfile.name.split(' ')[0]} ambiance`}
                        {ambientSound === 'music' && `${activeMusicProfile.icon} ${activeMusicProfile.music.style === 'piano' ? 'Soft piano' : activeMusicProfile.music.style === 'chimes' ? 'Gentle chimes' : 'Zen bowls'}`}
                        {ambientSound === 'both' && `${activeAmbianceProfile.icon} ambiance + ${activeMusicProfile.icon} ${activeMusicProfile.music.style}`}
                        {' '}playing...
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* JOURNAL TAB */}
            {activeTab === 'journal' && (
              <div className="fade">
                <div style={s.card}>
                  <h2 className="hw" style={{ fontSize: '1.3rem', color: theme.text, marginBottom: '12px' }}>ðŸ“ Daily Reflection</h2>
                  <div style={{ marginBottom: '12px' }}>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ðŸ™ 3 things I'm grateful for:</label>
                    <textarea value={todayJournal.gratitude} onChange={e => setTodayJournal({ ...todayJournal, gratitude: e.target.value })} onBlur={saveJournal} placeholder="1. ...\n2. ...\n3. ..." style={{ ...s.input, minHeight: '70px', resize: 'vertical', fontSize: '0.9rem' }} aria-label="Gratitude journal" />
                  </div>
                  <div style={{ marginBottom: '12px' }}>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ðŸ’­ How was today?</label>
                    <textarea value={todayJournal.reflection} onChange={e => setTodayJournal({ ...todayJournal, reflection: e.target.value })} onBlur={saveJournal} placeholder="What went well? What was challenging?" style={{ ...s.input, minHeight: '80px', resize: 'vertical', fontSize: '0.9rem' }} />
                  </div>
                  <div>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ðŸŽ¯ Top 3 for tomorrow:</label>
                    <textarea value={todayJournal.tomorrow} onChange={e => setTodayJournal({ ...todayJournal, tomorrow: e.target.value })} onBlur={saveJournal} placeholder="1. ...\n2. ...\n3. ..." style={{ ...s.input, minHeight: '70px', resize: 'vertical', fontSize: '0.9rem' }} />
                  </div>
                </div>
                <p className="bt" style={{ textAlign: 'center', fontSize: '0.7rem', color: theme.textMuted }}>Auto-saved â€¢ {Object.keys(journal).length} entries</p>
              </div>
            )}

            {/* CALENDAR TAB */}
            {activeTab === 'calendar' && (
              <div className="fade">
                <div style={s.card}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <button onClick={() => setCalendarDate(new Date(calYear, calMonth - 1, 1))} style={{ background: 'none', border: 'none', color: theme.textSecondary, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }}>â€¹</button>
                    <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>{calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h2>
                    <button onClick={() => setCalendarDate(new Date(calYear, calMonth + 1, 1))} style={{ background: 'none', border: 'none', color: theme.textSecondary, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }}>â€º</button>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '3px', marginBottom: '4px' }}>
                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => <div key={i} className="bt" style={{ textAlign: 'center', fontSize: '0.6rem', color: theme.textMuted, padding: '3px' }}>{d}</div>)}
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '3px' }}>
                    {calDays.map((day, i) => {
                      if (!day) return <div key={i} />;
                      const dk = getDateKey(day);
                      const dm = moods[dk];
                      const isToday = isSameDay(day, today);
                      return (
                        <div key={i} style={{ aspectRatio: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', borderRadius: '8px', background: isToday ? theme.accentGradient : dm ? theme.accentLight : 'transparent', border: isToday ? 'none' : `1px solid ${theme.cardBorder}` }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: isToday ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text, fontWeight: isToday ? 600 : 400 }}>{day.getDate()}</span>
                          {dm && <span style={{ fontSize: '0.45rem' }}>{moodEmojis.find(m => m.value === dm.value)?.emoji}</span>}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Heatmap */}
                <div style={s.card}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ”¥ Habit Heatmap (12 weeks)</h3>
                  <div style={{ display: 'flex', gap: '2px', justifyContent: 'center' }}>
                    {heatmapData.map((week, wi) => (
                      <div key={wi} style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        {week.map((day, di) => {
                          const intensity = day.total > 0 ? day.count / day.total : 0;
                          return (<div key={di} title={`${day.date}: ${day.count}/${day.total}`} style={{ width: '10px', height: '10px', borderRadius: '2px', background: intensity === 0 ? theme.progressBg : `rgba(${theme.isDark ? '139,171,123' : '107,139,91'}, ${0.3 + intensity * 0.7})`, cursor: 'pointer', transition: 'transform 0.2s' }} />);
                        })}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* STATS TAB */}
            {activeTab === 'stats' && (
              <div className="fade">
                {/* Year in Review */}
                <button onClick={() => setShowYearReview(true)} style={{ ...s.card, width: '100%', textAlign: 'center', cursor: 'pointer', border: `2px solid ${theme.accent}` }}>
                  <span style={{ fontSize: '1.2rem' }}>ðŸ“…</span>
                  <p className="hw" style={{ fontSize: '1.2rem', color: theme.text, marginTop: '4px' }}>{currentYear} Year in Review</p>
                </button>

                {/* Challenges */}
                <div style={{ ...s.card, cursor: 'pointer' }} onClick={() => setShowChallenges(true)}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ† Challenges</h3>
                  {weeklyChallenge && (
                    <div style={{ marginBottom: '8px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                        <span className="bt" style={{ color: theme.textSecondary }}>Weekly: {weeklyChallenge.name}</span>
                        <span className="bt" style={{ color: theme.accent }}>{Math.min(challenges.weekly.progress, weeklyChallenge.target)}/{weeklyChallenge.target}</span>
                      </div>
                      <div style={{ height: '6px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                        <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                      </div>
                    </div>
                  )}
                  {monthlyChallenge && (
                    <div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                        <span className="bt" style={{ color: theme.textSecondary }}>Monthly: {monthlyChallenge.name}</span>
                        <span className="bt" style={{ color: theme.accent }}>{Math.min(challenges.monthly.progress, monthlyChallenge.target)}/{monthlyChallenge.target}</span>
                      </div>
                      <div style={{ height: '6px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                        <div style={{ height: '100%', width: `${Math.min(100, (challenges.monthly.progress / monthlyChallenge.target) * 100)}%`, background: theme.xpBar, borderRadius: '999px' }} />
                      </div>
                    </div>
                  )}
                </div>

                {/* Mood Insights */}
                {moodInsights && (
                  <div style={s.card}>
                    <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ˜Š Mood Insights</h3>
                    {moodInsights.hasEnoughData ? (
                      <div className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, lineHeight: 1.6 }}>
                        {moodInsights.moodDiff && parseFloat(moodInsights.moodDiff) > 0 && (
                          <p style={{ marginBottom: '8px', padding: '8px', background: theme.accentLight, borderRadius: '8px' }}>
                            <span style={{ fontSize: '1.1rem' }}>âœ¨</span> Your mood is <strong style={{ color: theme.accent }}>+{moodInsights.moodDiff} points higher</strong> on days you complete most habits!
                          </p>
                        )}
                        {moodInsights.avgHighCompletion && (
                          <p>ðŸ“ˆ High habit days: <strong style={{ color: theme.text }}>{moodInsights.avgHighCompletion}/5</strong> avg mood</p>
                        )}
                        {moodInsights.avgLowCompletion && (
                          <p>ðŸ“‰ Low habit days: <strong style={{ color: theme.text }}>{moodInsights.avgLowCompletion}/5</strong> avg mood</p>
                        )}
                        {moodInsights.bestDay && (
                          <p style={{ marginTop: '6px' }}>ðŸŒŸ Best mood day: <strong style={{ color: theme.accent }}>{moodInsights.bestDay.name}</strong> ({moodInsights.bestDay.avg.toFixed(1)}/5)</p>
                        )}
                      </div>
                    ) : (
                      <p className="bt" style={{ fontSize: '0.75rem', color: theme.textMuted }}>Track your mood for a week to unlock insights!</p>
                    )}
                  </div>
                )}

                {/* Streaks */}
                <div style={s.card}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ”¥ Streaks</h3>
                  {habits.sort((a, b) => b.streak - a.streak).slice(0, 5).map(h => (
                    <div key={h.id} style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1rem' }}>{h.icon}</span>
                      <div style={{ flex: 1 }}>
                        <p className="bt" style={{ fontSize: '0.75rem', color: theme.text }}>{h.name}</p>
                        <div style={{ height: '4px', background: theme.progressBg, borderRadius: '999px', marginTop: '3px', overflow: 'hidden' }}>
                          <div style={{ height: '100%', width: `${Math.min(100, h.streak * 3.33)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                        </div>
                      </div>
                      <span className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.accent }}>{h.streak}d</span>
                    </div>
                  ))}
                </div>

                {/* Quick Actions */}
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowExport(true)} style={{ ...s.btnSecondary, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', padding: '14px' }}>
                    <span style={{ fontSize: '1.2rem' }}>ðŸ’¾</span>
                    <span className="bt" style={{ fontSize: '0.75rem' }}>Export Data</span>
                  </button>
                  <button onClick={() => shareAchievement(`I'm a ${currentLevel.title} at ${cafeName}! ${gameStats.xp} XP earned on my productivity journey. â˜•ðŸ†`)} style={{ ...s.btnSecondary, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', padding: '14px' }}>
                    <span style={{ fontSize: '1.2rem' }}>ðŸ“¤</span>
                    <span className="bt" style={{ fontSize: '0.75rem' }}>Share Progress</span>
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Bottom Nav */}
          <nav style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: theme.navBg, borderTop: `1px solid ${theme.cardBorder}`, display: 'flex', justifyContent: 'space-around', padding: '5px 0', paddingBottom: 'max(5px,env(safe-area-inset-bottom))', backdropFilter: 'blur(20px)', zIndex: 100 }} role="navigation" aria-label="Main navigation">
            {[{ id: 'today', icon: 'ðŸ“‹', label: 'Today' }, { id: 'timer', icon: 'â±ï¸', label: 'Focus' }, { id: 'journal', icon: 'ðŸ“', label: 'Journal' }, { id: 'calendar', icon: 'ðŸ“…', label: 'Calendar' }, { id: 'stats', icon: 'ðŸ“Š', label: 'Stats' }].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={s.navItem(activeTab === tab.id)} aria-current={activeTab === tab.id ? 'page' : undefined}>
                <span style={{ fontSize: '1.1rem' }}>{tab.icon}</span>
                <span>{tab.label}</span>
              </button>
            ))}
          </nav>

          {/* Floating Sound Button */}
          <button 
            onClick={() => setShowSoundMenu(true)} 
            style={{ 
              position: 'fixed', 
              bottom: '90px', 
              left: '20px', 
              width: '48px', 
              height: '48px', 
              borderRadius: '50%', 
              background: soundEnabled ? theme.accentGradient : theme.cardBg, 
              border: `2px solid ${soundEnabled ? 'transparent' : theme.cardBorder}`, 
              fontSize: '20px', 
              cursor: 'pointer', 
              boxShadow: '0 4px 16px rgba(0,0,0,0.2)', 
              zIndex: 99, 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              color: soundEnabled ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text
            }} 
            aria-label="Sound settings"
          >
            {soundEnabled ? 'ðŸŽµ' : 'ðŸ”‡'}
          </button>

          {/* FAB */}
          <button onClick={() => setShowQuickAdd(true)} style={s.fab} aria-label="Quick add">+</button>

          {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
          {/* MODALS */}
          {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}

          {/* What's New / Grand Reopening */}
          {showWhatsNew && (
            <div style={s.modal} className="fade">
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide">
                <div style={{ fontSize: '3rem', marginBottom: '8px' }}>ðŸŽ‰</div>
                <h2 className="hw" style={{ fontSize: '1.8rem', color: theme.text, marginBottom: '4px' }}>Grand Reopening!</h2>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, marginBottom: '20px' }}>We've been renovating! Pull up a chair and see what's new...</p>
                
                <div style={{ textAlign: 'left', maxHeight: '300px', overflow: 'auto', marginBottom: '16px' }}>
                  {whatsNewContent.map((section, i) => (
                    <div key={i} style={{ marginBottom: '16px' }}>
                      <h3 className="hw" style={{ fontSize: '1.2rem', color: theme.accent, marginBottom: '8px' }}>{section.title}</h3>
                      {section.items.map((item, j) => (
                        <div key={j} style={{ display: 'flex', gap: '10px', alignItems: 'flex-start', marginBottom: '8px', padding: '8px', background: theme.progressBg, borderRadius: '10px' }}>
                          <span style={{ fontSize: '1.2rem' }}>{item.icon}</span>
                          <div>
                            <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text }}>{item.title}</p>
                            <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{item.desc}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
                
                <button onClick={dismissWhatsNew} style={{ ...s.btn, width: '100%' }}>Show Me Around! â˜•</button>
              </div>
            </div>
          )}

          {/* Interactive Tutorial */}
          {showTutorial && (
            <div style={s.modal} className="fade">
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide">
                <button onClick={dismissTutorial} style={{ position: 'absolute', top: '16px', right: '16px', background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.8rem', cursor: 'pointer' }}>Skip tour</button>
                
                <div style={{ fontSize: '2.5rem', marginBottom: '12px' }}>{tutorialSteps[tutorialStep].icon}</div>
                <h2 className="hw" style={{ fontSize: '1.5rem', color: theme.text, marginBottom: '4px' }}>{tutorialSteps[tutorialStep].title}</h2>
                <p className="bt" style={{ fontSize: '0.9rem', color: theme.accent, fontStyle: 'italic', marginBottom: '12px' }}>{tutorialSteps[tutorialStep].subtitle}</p>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, lineHeight: 1.5, marginBottom: '20px' }}>{tutorialSteps[tutorialStep].content}</p>
                
                {/* Progress dots */}
                <div style={{ display: 'flex', justifyContent: 'center', gap: '6px', marginBottom: '16px' }}>
                  {tutorialSteps.map((_, i) => (
                    <div key={i} style={{ width: i === tutorialStep ? '20px' : '8px', height: '8px', borderRadius: '4px', background: i === tutorialStep ? theme.accentGradient : theme.progressBg, transition: 'all 0.3s' }} />
                  ))}
                </div>
                
                <div style={{ display: 'flex', gap: '10px' }}>
                  {tutorialStep > 0 && (
                    <button onClick={() => setTutorialStep(s => s - 1)} style={{ ...s.btnSecondary, flex: 1 }}>â† Back</button>
                  )}
                  {tutorialStep < tutorialSteps.length - 1 ? (
                    <button onClick={() => setTutorialStep(s => s + 1)} style={{ ...s.btn, flex: 1 }}>Next â†’</button>
                  ) : (
                    <button onClick={dismissTutorial} style={{ ...s.btn, flex: 1 }}>Let's Brew! â˜•</button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Quick Add */}
          {showQuickAdd && (
            <div style={{ ...s.modal, alignItems: 'flex-end' }} onClick={() => setShowQuickAdd(false)}>
              <div style={{ background: theme.modalBg, borderRadius: '20px 20px 0 0', width: '100%', maxWidth: '28rem', padding: '20px', paddingBottom: 'max(20px,env(safe-area-inset-bottom))' }} className="slide" onClick={e => e.stopPropagation()}>
                <h3 className="hw" style={{ fontSize: '1.3rem', color: theme.text, textAlign: 'center', marginBottom: '16px' }}>Quick Add</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => { setShowQuickAdd(false); setShowAddHabit(true); }} style={{ ...s.btn, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '6px', padding: '16px' }}>
                    <span style={{ fontSize: '1.5rem' }}>â­</span><span>New Habit</span>
                  </button>
                  <button onClick={() => { setShowQuickAdd(false); setShowAddTask(true); }} style={{ ...s.btn, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '6px', padding: '16px' }}>
                    <span style={{ fontSize: '1.5rem' }}>âœ“</span><span>New Task</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add Habit */}
          {showAddHabit && (
            <div style={s.modal} onClick={() => setShowAddHabit(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>â­ New Habit</h2>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '8px' }}>Choose an icon:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px', maxHeight: '120px', overflow: 'auto' }}>
                  {defaultEmojis.map(e => (<button key={e} onClick={() => setNewHabit({ ...newHabit, icon: e })} style={{ width: '36px', height: '36px', borderRadius: '10px', border: newHabit.icon === e ? `2px solid ${theme.accent}` : 'none', background: newHabit.icon === e ? theme.accentLight : theme.progressBg, fontSize: '1.1rem', cursor: 'pointer' }}>{e}</button>))}
                </div>
                <input value={newHabit.name} onChange={e => setNewHabit({ ...newHabit, name: e.target.value })} placeholder="Habit name..." style={{ ...s.input, marginBottom: '14px' }} onKeyPress={e => e.key === 'Enter' && addHabit()} autoFocus />
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowAddHabit(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={addHabit} style={{ ...s.btn, flex: 1 }}>Add Habit</button>
                </div>
              </div>
            </div>
          )}

          {/* Add Task */}
          {showAddTask && (
            <div style={s.modal} onClick={() => setShowAddTask(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>âœ“ New Task</h2>
                <input value={newTask.text} onChange={e => setNewTask({ ...newTask, text: e.target.value })} placeholder="What needs doing?" style={{ ...s.input, marginBottom: '12px' }} autoFocus />
                <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                  <input type="time" value={newTask.time} onChange={e => setNewTask({ ...newTask, time: e.target.value })} style={{ ...s.input, flex: 1 }} />
                  <select value={newTask.priority} onChange={e => setNewTask({ ...newTask, priority: e.target.value })} style={{ ...s.input, flex: 1 }}>
                    <option value="high">ðŸ”´ High</option>
                    <option value="medium">ðŸŸ¡ Medium</option>
                    <option value="low">ðŸŸ¢ Low</option>
                  </select>
                </div>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Category:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px' }}>
                  {categories.map(c => (<button key={c.id} onClick={() => setNewTask({ ...newTask, category: newTask.category === c.id ? null : c.id })} style={{ padding: '5px 10px', borderRadius: '8px', border: newTask.category === c.id ? `2px solid ${c.color}` : `1px solid ${theme.cardBorder}`, background: newTask.category === c.id ? `${c.color}22` : 'transparent', fontSize: '0.7rem', cursor: 'pointer' }}>{c.icon}</button>))}
                </div>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>ðŸ”„ Repeat:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px' }}>
                  {[{ id: 'none', label: 'Once' }, { id: 'daily', label: 'Daily' }, { id: 'weekdays', label: 'Weekdays' }, { id: 'weekly', label: 'Weekly' }].map(r => (
                    <button key={r.id} onClick={() => setNewTask({ ...newTask, recurring: r.id })} style={{ padding: '6px 12px', borderRadius: '8px', border: newTask.recurring === r.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, background: newTask.recurring === r.id ? theme.accentLight : 'transparent', fontSize: '0.75rem', color: theme.text, cursor: 'pointer', fontFamily: "'Lora',serif" }}>{r.label}</button>
                  ))}
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowAddTask(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={addTask} style={{ ...s.btn, flex: 1 }}>Add Task</button>
                </div>
              </div>
            </div>
          )}

          {/* Theme Picker */}
          {showThemePicker && (
            <div style={s.modal} className="fade" onClick={() => setShowThemePicker(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.5rem', color: theme.text, textAlign: 'center', marginBottom: '16px' }}>{brewThemes[brewType].icon} Choose Your Brew</h2>
                {Object.entries(brewThemes).map(([key, brew]) => (
                  <div key={key} style={{ marginBottom: '14px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.2rem' }}>{brew.icon}</span>
                      <span className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>{brew.name}</span>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      {['light', 'dark'].map(mode => {
                        const t = brew[mode];
                        const isActive = brewType === key && isDark === (mode === 'dark');
                        return (<button key={mode} onClick={() => { setBrewType(key); setIsDark(mode === 'dark'); }} style={{ flex: 1, padding: '12px 10px', borderRadius: '12px', border: isActive ? `3px solid ${t.accent}` : `1px solid ${theme.cardBorder}`, background: t.cardBg, cursor: 'pointer' }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px', marginBottom: '4px' }}>
                            <span style={{ fontSize: '0.9rem' }}>{t.icon}</span>
                            <span className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: t.text }}>{t.name}</span>
                          </div>
                        </button>);
                      })}
                    </div>
                  </div>
                ))}
                <button onClick={() => setShowThemePicker(false)} style={{ ...s.btn, width: '100%', marginTop: '6px' }}>Done</button>
              </div>
            </div>
          )}

          {/* Settings */}
          {showSettings && (
            <div style={s.modal} className="fade" onClick={() => setShowSettings(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>âš™ï¸ Settings</h2>
                <div style={{ marginBottom: '14px' }}>
                  <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>Name your cafÃ©:</label>
                  <input value={cafeName} onChange={e => setCafeName(e.target.value)} style={s.input} maxLength={24} />
                </div>
                
                <div style={{ marginBottom: '14px' }}>
                  <label className="bt" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '0.85rem', color: theme.text, cursor: 'pointer' }}>
                    <input type="checkbox" checked={highContrast} onChange={e => setHighContrast(e.target.checked)} style={{ accentColor: theme.accent }} />
                    â™¿ High Contrast Mode
                  </label>
                </div>

                <div style={{ marginBottom: '14px' }}>
                  <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Season: {seasonDeco.emoji} {seasonDeco.name}</p>
                </div>

                <div style={{ marginBottom: '14px', padding: '10px', background: theme.progressBg, borderRadius: '10px' }}>
                  <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Your stats:</p>
                  <div className="bt" style={{ fontSize: '0.75rem', color: theme.text, lineHeight: 1.6 }}>
                    <p>ðŸ† {gameStats.xp} XP â€¢ {currentLevel.title}</p>
                    <p>âœ“ {gameStats.totalTasksCompleted} tasks â€¢ â­ {gameStats.totalHabitsCompleted} habits</p>
                    <p>ðŸ“… {gameStats.appStreak} day streak â€¢ â„ï¸ {gameStats.freezesAvailable} freeze</p>
                  </div>
                </div>
                
                <p className="bt" style={{ fontSize: '0.7rem', color: theme.textMuted, marginBottom: '14px' }}>ðŸ’¡ Swipe right âœ“ | Swipe left Ã—</p>
                <button onClick={() => setShowSettings(false)} style={{ ...s.btn, width: '100%' }}>Done</button>
              </div>
            </div>
          )}

          {/* Badges */}
          {showBadges && (
            <div style={s.modal} className="fade" onClick={() => setShowBadges(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, textAlign: 'center', marginBottom: '4px' }}>ðŸ† Achievements</h2>
                <p className="bt" style={{ textAlign: 'center', fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '16px' }}>{gameStats.unlockedBadges.length}/{badges.length} unlocked</p>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: '8px', maxHeight: '350px', overflow: 'auto' }}>
                  {badges.map(b => {
                    const unlocked = gameStats.unlockedBadges.includes(b.id);
                    return (<div key={b.id} style={{ padding: '12px 8px', borderRadius: '12px', background: unlocked ? theme.accentLight : theme.progressBg, border: `1px solid ${theme.cardBorder}`, textAlign: 'center', opacity: unlocked ? 1 : 0.5 }}>
                      <div style={{ fontSize: '1.5rem', marginBottom: '4px', filter: unlocked ? 'none' : 'grayscale(1)' }}>{b.icon}</div>
                      <p className="bt" style={{ fontSize: '0.7rem', fontWeight: 600, color: theme.text }}>{b.name}</p>
                      <p className="bt" style={{ fontSize: '0.55rem', color: theme.textMuted }}>{b.desc}</p>
                      {unlocked && <button onClick={() => shareAchievement(`I earned the "${b.name}" badge at ${cafeName}! ${b.icon}`)} className="bt" style={{ marginTop: '4px', background: 'none', border: 'none', color: theme.accent, fontSize: '0.6rem', cursor: 'pointer' }}>ðŸ“¤ Share</button>}
                    </div>);
                  })}
                </div>
                <button onClick={() => setShowBadges(false)} style={{ ...s.btn, width: '100%', marginTop: '14px' }}>Close</button>
              </div>
            </div>
          )}

          {/* Challenges */}
          {showChallenges && (
            <div style={s.modal} className="fade" onClick={() => setShowChallenges(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>ðŸ† Challenges</h2>
                
                <h3 className="bt" style={{ fontSize: '0.9rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ“… Weekly Challenge</h3>
                {weeklyChallenge && (
                  <div style={{ ...s.card, marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.5rem' }}>{weeklyChallenge.icon}</span>
                      <div>
                        <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text }}>{weeklyChallenge.name}</p>
                        <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{weeklyChallenge.desc}</p>
                      </div>
                    </div>
                    <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                      <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px', transition: 'width 0.5s' }} />
                    </div>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.accent, marginTop: '4px', textAlign: 'right' }}>{Math.min(challenges.weekly.progress, weeklyChallenge.target)}/{weeklyChallenge.target} â€¢ +{weeklyChallenge.xp} XP</p>
                  </div>
                )}

                <h3 className="bt" style={{ fontSize: '0.9rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸ“† Monthly Challenge</h3>
                {monthlyChallenge && (
                  <div style={s.card}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.5rem' }}>{monthlyChallenge.icon}</span>
                      <div>
                        <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text }}>{monthlyChallenge.name}</p>
                        <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{monthlyChallenge.desc}</p>
                      </div>
                    </div>
                    <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                      <div style={{ height: '100%', width: `${Math.min(100, (challenges.monthly.progress / monthlyChallenge.target) * 100)}%`, background: theme.xpBar, borderRadius: '999px', transition: 'width 0.5s' }} />
                    </div>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.accent, marginTop: '4px', textAlign: 'right' }}>{Math.min(challenges.monthly.progress, monthlyChallenge.target)}/{monthlyChallenge.target} â€¢ +{monthlyChallenge.xp} XP</p>
                  </div>
                )}

                <button onClick={() => setShowChallenges(false)} style={{ ...s.btn, width: '100%', marginTop: '14px' }}>Close</button>
              </div>
            </div>
          )}

          {/* Year in Review */}
          {showYearReview && (
            <div style={s.modal} className="fade" onClick={() => setShowYearReview(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                  <span style={{ fontSize: '2.5rem' }}>{brewThemes[brewType].icon}</span>
                  <h2 className="hw" style={{ fontSize: '1.6rem', color: theme.text, marginTop: '8px' }}>{currentYear} Year in Review</h2>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: '10px', marginBottom: '16px' }}>
                  {[{ v: gameStats.xp, l: 'Total XP' }, { v: yearReview.badgesEarned, l: 'Badges' }, { v: yearReview.totalHabits, l: 'Habits Done' }, { v: yearReview.totalTasks, l: 'Tasks Done' }].map((stat, i) => (
                    <div key={i} style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', textAlign: 'center' }}>
                      <p style={{ fontSize: '1.5rem', fontWeight: 600, color: theme.text }}>{stat.v}</p>
                      <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary }}>{stat.l}</p>
                    </div>
                  ))}
                </div>

                <div style={{ background: theme.accentLight, borderRadius: '12px', padding: '14px', marginBottom: '12px' }}>
                  <div className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, lineHeight: 1.8 }}>
                    <p>ðŸ”¥ Longest streak: <strong style={{ color: theme.text }}>{yearReview.longestStreak} days</strong></p>
                    <p>ðŸ˜Š Avg mood: <strong style={{ color: theme.text }}>{yearReview.avgMood || 'â€”'}/5</strong></p>
                    <p>ðŸ“ Journal entries: <strong style={{ color: theme.text }}>{yearReview.totalJournal}</strong></p>
                    <p>â±ï¸ Focus time: <strong style={{ color: theme.text }}>{Math.round(yearReview.totalFocus / 60)} hours</strong></p>
                  </div>
                </div>

                <div style={{ textAlign: 'center', padding: '12px', background: theme.streakGradient, borderRadius: '12px', marginBottom: '14px' }}>
                  <p className="hw" style={{ fontSize: '1.2rem', color: theme.isDark ? '#1a1a1a' : '#fff' }}>{currentLevel.icon} {currentLevel.title}</p>
                </div>

                <button onClick={() => shareAchievement(`My ${currentYear} at ${cafeName}: ${yearReview.totalHabits} habits, ${yearReview.totalTasks} tasks, ${yearReview.longestStreak}-day streak! â˜•ðŸ†`)} style={{ ...s.btnSecondary, width: '100%', marginBottom: '10px' }}>ðŸ“¤ Share My Year</button>
                <button onClick={() => setShowYearReview(false)} style={{ ...s.btn, width: '100%' }}>Close</button>
              </div>
            </div>
          )}

          {/* Custom Timer */}
          {showCustomTimer && (
            <div style={s.modal} onClick={() => setShowCustomTimer(false)}>
              <div style={{ ...s.modalContent, maxWidth: '300px', textAlign: 'center' }} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>â±ï¸ Custom Timer</h2>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', marginBottom: '20px' }}>
                  <button onClick={() => setCustomTimerMins(Math.max(1, customTimerMins - 5))} style={{ ...s.btnSecondary, padding: '10px 16px', fontSize: '1.2rem' }}>-</button>
                  <div>
                    <input type="number" value={customTimerMins} onChange={e => setCustomTimerMins(Math.max(1, Math.min(180, parseInt(e.target.value) || 1)))} style={{ ...s.input, width: '80px', textAlign: 'center', fontSize: '1.5rem', fontWeight: 600 }} min="1" max="180" />
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginTop: '4px' }}>minutes</p>
                  </div>
                  <button onClick={() => setCustomTimerMins(Math.min(180, customTimerMins + 5))} style={{ ...s.btnSecondary, padding: '10px 16px', fontSize: '1.2rem' }}>+</button>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowCustomTimer(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={() => { setTimerSeconds(customTimerMins * 60); setShowCustomTimer(false); }} style={{ ...s.btn, flex: 1 }}>Set Timer</button>
                </div>
              </div>
            </div>
          )}

          {/* Sound Menu */}
          {showSoundMenu && (
            <div style={{ ...s.modal, alignItems: 'flex-end' }} onClick={() => setShowSoundMenu(false)}>
              <div style={{ background: theme.modalBg, borderRadius: '20px 20px 0 0', width: '100%', maxWidth: '28rem', padding: '20px', paddingBottom: 'max(20px,env(safe-area-inset-bottom))', maxHeight: '90vh', overflow: 'auto' }} className="slide" onClick={e => e.stopPropagation()}>
                <h3 className="hw" style={{ fontSize: '1.4rem', color: theme.text, textAlign: 'center', marginBottom: '4px' }}>ðŸŽµ Soundscape</h3>
                <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary, textAlign: 'center', marginBottom: '16px' }}>
                  {isDark ? 'ðŸŒ™ Dark mode: Warmer, deeper tones' : 'â˜€ï¸ Light mode: Brighter, airy tones'}
                </p>
                
                {/* Big Play/Stop Button */}
                <div style={{ textAlign: 'center', marginBottom: '16px' }}>
                  <button 
                    onClick={() => { if (ambientSound === 'off') { setAmbientSound('both'); } setSoundEnabled(!soundEnabled); }}
                    disabled={ambientSound === 'off'}
                    style={{ 
                      width: '72px', 
                      height: '72px', 
                      borderRadius: '50%', 
                      border: 'none',
                      background: soundEnabled ? theme.streakGradient : theme.accentGradient,
                      cursor: ambientSound === 'off' ? 'not-allowed' : 'pointer',
                      opacity: ambientSound === 'off' ? 0.5 : 1,
                      fontSize: '1.8rem',
                      boxShadow: soundEnabled ? '0 0 20px rgba(74,222,128,0.4)' : '0 4px 15px rgba(0,0,0,0.2)',
                      transition: 'all 0.3s'
                    }}
                  >
                    {soundEnabled ? 'â¸' : 'â–¶'}
                  </button>
                </div>

                {/* Volume Sliders - Only show when sound is enabled */}
                {ambientSound !== 'off' && (
                  <div style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text, marginBottom: '12px' }}>ðŸŽšï¸ Volume</p>
                    
                    {/* Ambiance Volume */}
                    {(ambientSound === 'ambiance' || ambientSound === 'both') && (
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>ðŸŒ§ï¸ Ambiance</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>{ambianceVolume}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          value={ambianceVolume}
                          onChange={e => setAmbianceVolume(parseInt(e.target.value))}
                          style={{ width: '100%', accentColor: theme.accent, height: '6px', borderRadius: '3px', cursor: 'pointer' }}
                        />
                      </div>
                    )}
                    
                    {/* Music Volume */}
                    {(ambientSound === 'music' || ambientSound === 'both') && (
                      <div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>ðŸŽ¹ Music</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>{musicVolume}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          value={musicVolume}
                          onChange={e => setMusicVolume(parseInt(e.target.value))}
                          style={{ width: '100%', accentColor: theme.accent, height: '6px', borderRadius: '3px', cursor: 'pointer' }}
                        />
                      </div>
                    )}
                  </div>
                )}

                {/* Mood Presets */}
                {ambientSound !== 'off' && (
                  <div style={{ marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '8px' }}>Mood:</p>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px' }}>
                      {Object.entries(moodConfigs).map(([key, config]) => (
                        <button 
                          key={key}
                          onClick={() => setSoundMood(key)}
                          style={{
                            padding: '10px 6px',
                            borderRadius: '10px',
                            border: soundMood === key ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                            background: soundMood === key ? theme.accentLight : 'transparent',
                            cursor: 'pointer',
                            textAlign: 'center'
                          }}
                        >
                          <span style={{ fontSize: '1.2rem', display: 'block' }}>{config.icon}</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.text, fontWeight: soundMood === key ? 600 : 400 }}>
                            {key.charAt(0).toUpperCase() + key.slice(1)}
                          </span>
                        </button>
                      ))}
                    </div>
                    <p className="bt" style={{ fontSize: '0.6rem', color: theme.textMuted, textAlign: 'center', marginTop: '6px' }}>
                      {moodConfigs[soundMood].desc}
                    </p>
                  </div>
                )}
                
                {/* Sound Mode Options */}
                <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '6px' }}>Sound Mode:</p>
                <div style={{ display: 'flex', gap: '6px', marginBottom: '14px' }}>
                  {[
                    { id: 'off', icon: 'ðŸ”‡', name: 'Off' },
                    { id: 'ambiance', icon: 'ðŸŒ§ï¸', name: 'Ambiance' },
                    { id: 'music', icon: 'ðŸŽ¹', name: 'Music' },
                    { id: 'both', icon: 'âœ¨', name: 'Full' },
                  ].map(opt => (
                    <button 
                      key={opt.id} 
                      onClick={() => { setAmbientSound(opt.id); if (opt.id === 'off') setSoundEnabled(false); }}
                      style={{ 
                        flex: 1,
                        padding: '10px 6px', 
                        borderRadius: '10px', 
                        border: ambientSound === opt.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, 
                        background: ambientSound === opt.id ? theme.accentLight : 'transparent',
                        cursor: 'pointer',
                        textAlign: 'center'
                      }}
                    >
                      <span style={{ fontSize: '1.1rem', display: 'block' }}>{opt.icon}</span>
                      <span className="bt" style={{ fontSize: '0.65rem', color: theme.text }}>{opt.name}</span>
                    </button>
                  ))}
                </div>

                {/* Sound Sources (Mix & Match) */}
                {ambientSound !== 'off' && (
                  <div style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ðŸŽ¨ Sound Sources</p>
                    
                    {(ambientSound === 'ambiance' || ambientSound === 'both') && (
                      <div style={{ marginBottom: ambientSound === 'both' ? '10px' : 0 }}>
                        <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary, marginBottom: '5px' }}>Ambiance Style:</p>
                        <div style={{ display: 'flex', gap: '5px' }}>
                          {[
                            { id: 'auto', label: 'âœ¨ Auto' },
                            { id: 'coffee', label: 'â˜• CafÃ©' },
                            { id: 'tea', label: 'ðŸµ Rain' },
                            { id: 'matcha', label: 'ðŸƒ Wind' },
                          ].map(opt => (
                            <button 
                              key={opt.id}
                              onClick={() => setSoundAmbianceSource(opt.id)}
                              style={{
                                flex: 1,
                                padding: '8px 2px',
                                borderRadius: '8px',
                                border: soundAmbianceSource === opt.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                                background: soundAmbianceSource === opt.id ? theme.accentLight : 'transparent',
                                cursor: 'pointer',
                                fontSize: '0.65rem',
                                color: theme.text,
                                fontFamily: "'Lora',serif"
                              }}
                            >{opt.label}</button>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {(ambientSound === 'music' || ambientSound === 'both') && (
                      <div>
                        <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary, marginBottom: '5px' }}>Music Style:</p>
                        <div style={{ display: 'flex', gap: '5px' }}>
                          {[
                            { id: 'auto', label: 'âœ¨ Auto' },
                            { id: 'coffee', label: 'â˜• Piano' },
                            { id: 'tea', label: 'ðŸµ Chimes' },
                            { id: 'matcha', label: 'ðŸƒ Bowls' },
                          ].map(opt => (
                            <button 
                              key={opt.id}
                              onClick={() => setSoundMusicSource(opt.id)}
                              style={{
                                flex: 1,
                                padding: '8px 2px',
                                borderRadius: '8px',
                                border: soundMusicSource === opt.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                                background: soundMusicSource === opt.id ? theme.accentLight : 'transparent',
                                cursor: 'pointer',
                                fontSize: '0.65rem',
                                color: theme.text,
                                fontFamily: "'Lora',serif"
                              }}
                            >{opt.label}</button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Background Play Toggle */}
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 14px', background: theme.progressBg, borderRadius: '10px', marginBottom: '14px' }}>
                  <div>
                    <p className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.text }}>ðŸ”„ Background Play</p>
                    <p className="bt" style={{ fontSize: '0.55rem', color: theme.textSecondary }}>Keep playing when you leave</p>
                  </div>
                  <button 
                    onClick={() => setBackgroundPlay(!backgroundPlay)}
                    style={{
                      width: '46px',
                      height: '26px',
                      borderRadius: '13px',
                      border: 'none',
                      background: backgroundPlay ? theme.accent : theme.inputBorder,
                      cursor: 'pointer',
                      position: 'relative',
                      transition: 'background 0.2s'
                    }}
                  >
                    <div style={{
                      width: '20px',
                      height: '20px',
                      borderRadius: '50%',
                      background: '#fff',
                      position: 'absolute',
                      top: '3px',
                      left: backgroundPlay ? '23px' : '3px',
                      transition: 'left 0.2s',
                      boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                    }} />
                  </button>
                </div>

                {/* Now Playing Status */}
                {soundEnabled && ambientSound !== 'off' && (
                  <div style={{ textAlign: 'center', marginBottom: '14px', padding: '10px', background: 'rgba(74,222,128,0.1)', borderRadius: '10px', border: '1px solid rgba(74,222,128,0.3)' }}>
                    <p className="bt" style={{ fontSize: '0.7rem', color: '#4ade80' }}>
                      ðŸŽµ {moodConfigs[soundMood].icon} {soundMood.charAt(0).toUpperCase() + soundMood.slice(1)} â€¢ {' '}
                      {ambientSound === 'ambiance' && `${activeAmbianceProfile.icon} ${activeAmbianceProfile.name}`}
                      {ambientSound === 'music' && `${activeMusicProfile.icon} ${activeMusicProfile.music.style}`}
                      {ambientSound === 'both' && `${activeAmbianceProfile.icon} + ${activeMusicProfile.icon}`}
                    </p>
                  </div>
                )}

                <button onClick={() => setShowSoundMenu(false)} style={{ ...s.btn, width: '100%' }}>Done</button>
              </div>
            </div>
          )}

          {/* Export */}
          {showExport && (
            <div style={s.modal} onClick={() => setShowExport(false)}>
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide" onClick={e => e.stopPropagation()}>
                <span style={{ fontSize: '2rem' }}>ðŸ’¾</span>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginTop: '8px', marginBottom: '12px' }}>Export Your Data</h2>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, marginBottom: '20px' }}>Download all your habits, tasks, mood logs, journal entries, and stats as a JSON file.</p>
                <button onClick={exportData} style={{ ...s.btn, width: '100%', marginBottom: '10px' }}>ðŸ“¥ Download Backup</button>
                <button onClick={() => setShowExport(false)} style={{ ...s.btnSecondary, width: '100%' }}>Cancel</button>
              </div>
            </div>
          )}

          {/* Undo Toast */}
          {undoAction && (
            <div style={{ position: 'fixed', bottom: '100px', left: '50%', transform: 'translateX(-50%)', background: theme.text, color: theme.modalBg, padding: '10px 16px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '10px', zIndex: 1000, boxShadow: '0 4px 20px rgba(0,0,0,0.3)' }} className="slide">
              <span className="bt" style={{ fontSize: '0.85rem' }}>{undoAction.type} deleted</span>
              <button onClick={() => { undoAction.action(); setUndoAction(null); }} style={{ background: theme.accent, color: '#fff', border: 'none', padding: '5px 10px', borderRadius: '6px', fontWeight: 600, cursor: 'pointer', fontSize: '0.8rem' }}>Undo</button>
            </div>
          )}

          {/* Celebration */}
          {celebration && (
            <div style={{ position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%,-50%)', background: theme.accentGradient, color: theme.isDark ? '#1a1a1a' : '#fff', padding: '16px 28px', borderRadius: '16px', zIndex: 3000, textAlign: 'center', boxShadow: '0 10px 40px rgba(0,0,0,0.3)' }} className="slide">
              <p className="hw" style={{ fontSize: '1.4rem', margin: 0 }}>{celebration}</p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    setTimeout(() => document.getElementById('loadingScreen').classList.add('hidden'), 800);
  </script>
  <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);</script>
</body>
</html>
