<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#5D4037" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Daily Brew">
  <title>My Daily Brew</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Cormorant+Garamond:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    html, body, #root { height: 100%; width: 100%; overflow-x: hidden; }
    body { font-family: 'Cormorant Garamond', Georgia, serif; min-height: 100vh; transition: background 0.4s ease; overscroll-behavior: none; }
    .loading-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; background: linear-gradient(180deg, #F5E6D3 0%, #FDFBF7 50%, #F5E6D3 100%); transition: opacity 0.5s; }
    .loading-screen.hidden { opacity: 0; pointer-events: none; }
    .loading-icon { font-size: 56px; animation: steam 2s ease-in-out infinite; }
    @keyframes steam { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.1); } }
    .loading-text { font-family: 'Caveat', cursive; font-size: 26px; color: #5D4037; margin-top: 16px; }
    .loading-subtext { font-family: 'Lora', serif; font-size: 14px; color: #8B7355; margin-top: 8px; opacity: 0.8; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-icon">â˜•</div>
    <div class="loading-text">Brewing something special...</div>
    <div class="loading-subtext">v6.5 Grand Reopening</div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const store = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} };
    const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
    const getDateKey = (d = new Date()) => d.toISOString().split('T')[0];
    const getDayOfWeek = (d = new Date()) => d.getDay();
    const isSameDay = (d1, d2) => getDateKey(d1) === getDateKey(d2);
    const formatTime = (t) => { if (!t) return ''; const [h, m] = t.split(':').map(Number); return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`; };
    const formatTimer = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
    const getWeekNumber = () => Math.floor(new Date().getTime() / (7 * 24 * 60 * 60 * 1000));
    const getMonthKey = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEASONAL THEMES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const getCurrentSeason = () => {
      const month = new Date().getMonth();
      if (month >= 2 && month <= 4) return 'spring';
      if (month >= 5 && month <= 7) return 'summer';
      if (month >= 8 && month <= 10) return 'fall';
      return 'winter';
    };

    const seasonalDecorations = {
      spring: { emoji: 'ğŸŒ¸', name: 'Cherry Blossom', accent: '#FFB7C5' },
      summer: { emoji: 'ğŸŒ»', name: 'Sunshine', accent: '#FFD93D' },
      fall: { emoji: 'ğŸ‚', name: 'Pumpkin Spice', accent: '#D2691E' },
      winter: { emoji: 'â„ï¸', name: 'Peppermint', accent: '#B8E0E0' }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BREW-THEMED DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const brewRanks = {
      coffee: [
        { level: 1, title: 'Coffee Bean', xp: 0, icon: 'ğŸ«˜' },
        { level: 2, title: 'Barista Trainee', xp: 100, icon: 'ğŸ‘¶' },
        { level: 3, title: 'Junior Barista', xp: 300, icon: 'â˜•' },
        { level: 4, title: 'Senior Barista', xp: 600, icon: 'â­' },
        { level: 5, title: 'Head Barista', xp: 1000, icon: 'ğŸ–ï¸' },
        { level: 6, title: 'CafÃ© Manager', xp: 1500, icon: 'ğŸ‘”' },
        { level: 7, title: 'CafÃ© Owner', xp: 2500, icon: 'ğŸ†' },
      ],
      tea: [
        { level: 1, title: 'Tea Leaf', xp: 0, icon: 'ğŸŒ¿' },
        { level: 2, title: 'Tea Apprentice', xp: 100, icon: 'ğŸƒ' },
        { level: 3, title: 'Tea Steeper', xp: 300, icon: 'ğŸµ' },
        { level: 4, title: 'Tea Blender', xp: 600, icon: 'â­' },
        { level: 5, title: 'Tea Sommelier', xp: 1000, icon: 'ğŸ–ï¸' },
        { level: 6, title: 'Tea Sage', xp: 1500, icon: 'ğŸ§˜' },
        { level: 7, title: 'Tea Grandmaster', xp: 2500, icon: 'ğŸ‘‘' },
      ],
      matcha: [
        { level: 1, title: 'Matcha Seedling', xp: 0, icon: 'ğŸŒ±' },
        { level: 2, title: 'Matcha Student', xp: 100, icon: 'ğŸ“š' },
        { level: 3, title: 'Matcha Whisker', xp: 300, icon: 'ğŸƒ' },
        { level: 4, title: 'Matcha Artisan', xp: 600, icon: 'ğŸ¨' },
        { level: 5, title: 'Matcha Sensei', xp: 1000, icon: 'ğŸ¥‹' },
        { level: 6, title: 'Matcha Master', xp: 1500, icon: 'ğŸ¯' },
        { level: 7, title: 'Zen Grandmaster', xp: 2500, icon: 'ğŸ‰' },
      ]
    };

    const brewBadges = {
      coffee: [
        { id: 'first_habit', name: 'First Sip', desc: 'Complete your first habit', icon: 'â˜•', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Regular Order', desc: '7-day streak', icon: 'ğŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Loyal Customer', desc: '30-day streak', icon: 'ğŸ’', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Roast', desc: 'Complete all daily goals', icon: 'âœ¨', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Barista\'s Best', desc: '7 perfect days', icon: 'ğŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Coffee Connoisseur', desc: 'Track mood 7 days', icon: 'ğŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Deep Brew', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Espresso Shot', desc: '10 hours focus', icon: 'âš¡', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Coffee Journal', desc: '5 journal entries', icon: 'ğŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Order Up!', desc: '25 tasks done', icon: 'ğŸ›ï¸', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Rush Hour Hero', desc: '100 tasks done', icon: 'ğŸ’¯', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Morning Brew', desc: 'Task before 8 AM', icon: 'ğŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Late Night Latte', desc: 'Task after 10 PM', icon: 'ğŸ¦‰', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Daily Grind', desc: '14-day app streak', icon: 'ğŸ“…', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Iced Coffee', desc: 'Use streak freeze', icon: 'â„ï¸', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Challenge Champion', desc: 'Complete a challenge', icon: 'ğŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Social Barista', desc: 'Share an achievement', icon: 'ğŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Data Roaster', desc: 'Export your data', icon: 'ğŸ’¾', check: s => s.timesExported >= 1 },
      ],
      tea: [
        { id: 'first_habit', name: 'First Steep', desc: 'Complete your first habit', icon: 'ğŸµ', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Daily Ritual', desc: '7-day streak', icon: 'ğŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Tea Tradition', desc: '30-day streak', icon: 'ğŸ’', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Steep', desc: 'Complete all daily goals', icon: 'âœ¨', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Golden Cup', desc: '7 perfect days', icon: 'ğŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Tea Taster', desc: 'Track mood 7 days', icon: 'ğŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Zen Focus', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Tea Meditation', desc: '10 hours focus', icon: 'ğŸ§˜', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Tea Thoughts', desc: '5 journal entries', icon: 'ğŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Steeping Success', desc: '25 tasks done', icon: 'ğŸ«–', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Tea Party Host', desc: '100 tasks done', icon: 'ğŸ’¯', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Morning Tea', desc: 'Task before 8 AM', icon: 'ğŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Chamomile Night', desc: 'Task after 10 PM', icon: 'ğŸŒ™', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Tea Time', desc: '14-day app streak', icon: 'ğŸ“…', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Iced Tea', desc: 'Use streak freeze', icon: 'ğŸ§Š', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Challenge Conqueror', desc: 'Complete a challenge', icon: 'ğŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Tea Socialite', desc: 'Share an achievement', icon: 'ğŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Tea Archivist', desc: 'Export your data', icon: 'ğŸ’¾', check: s => s.timesExported >= 1 },
      ],
      matcha: [
        { id: 'first_habit', name: 'First Whisk', desc: 'Complete your first habit', icon: 'ğŸƒ', check: s => s.totalHabitsCompleted >= 1 },
        { id: 'streak_7', name: 'Daily Practice', desc: '7-day streak', icon: 'ğŸ”', check: s => s.maxStreak >= 7 },
        { id: 'streak_30', name: 'Zen Discipline', desc: '30-day streak', icon: 'ğŸ’', check: s => s.maxStreak >= 30 },
        { id: 'perfect_day', name: 'Perfect Balance', desc: 'Complete all daily goals', icon: 'â˜¯ï¸', check: s => s.perfectDays >= 1 },
        { id: 'perfect_week', name: 'Harmony Week', desc: '7 perfect days', icon: 'ğŸŒŸ', check: s => s.perfectDays >= 7 },
        { id: 'mood_tracker', name: 'Mindful Taster', desc: 'Track mood 7 days', icon: 'ğŸ˜Š', check: s => s.moodDaysTracked >= 7 },
        { id: 'focus_hour', name: 'Zen Focus', desc: '60 min focus total', icon: 'â±ï¸', check: s => s.totalFocusMinutes >= 60 },
        { id: 'focus_master', name: 'Deep Meditation', desc: '10 hours focus', icon: 'ğŸ§˜', check: s => s.totalFocusMinutes >= 600 },
        { id: 'journal_5', name: 'Zen Journal', desc: '5 journal entries', icon: 'ğŸ“', check: s => s.journalEntries >= 5 },
        { id: 'tasks_25', name: 'Flowing Progress', desc: '25 tasks done', icon: 'ğŸŒŠ', check: s => s.totalTasksCompleted >= 25 },
        { id: 'tasks_100', name: 'Mountain Climber', desc: '100 tasks done', icon: 'ğŸ”ï¸', check: s => s.totalTasksCompleted >= 100 },
        { id: 'early_bird', name: 'Sunrise Ritual', desc: 'Task before 8 AM', icon: 'ğŸŒ…', check: s => s.earlyTasks >= 1 },
        { id: 'night_owl', name: 'Moonlit Practice', desc: 'Task after 10 PM', icon: 'ğŸŒ™', check: s => s.lateTasks >= 1 },
        { id: 'consistent', name: 'Path of Zen', desc: '14-day app streak', icon: 'ğŸ›¤ï¸', check: s => s.appStreak >= 14 },
        { id: 'freeze_used', name: 'Frozen Matcha', desc: 'Use streak freeze', icon: 'ğŸ§Š', check: s => s.freezesUsed >= 1 },
        { id: 'challenge_complete', name: 'Zen Champion', desc: 'Complete a challenge', icon: 'ğŸ…', check: s => s.challengesCompleted >= 1 },
        { id: 'shared', name: 'Zen Teacher', desc: 'Share an achievement', icon: 'ğŸ“¤', check: s => s.timesShared >= 1 },
        { id: 'exported', name: 'Scroll Keeper', desc: 'Export your data', icon: 'ğŸ’¾', check: s => s.timesExported >= 1 },
      ]
    };

    const brewMessages = {
      coffee: { emptyHabits: "No habits brewing yet! Let's start your routine â˜•", emptyTasks: "All clear! Grab a coffee and relax! â˜•", perfect: "Perfect roast today! You're amazing âœ¨", good: "You're brewing greatness! â˜•", start: "One sip at a time â˜•", timerDone: "â˜• Brew complete!", timerFocus: "Stay focused, one cup at a time", freeze: "â„ï¸ Iced Coffee saved your streak!" },
      tea: { emptyHabits: "No habits steeping yet! Let's start your ritual ğŸµ", emptyTasks: "All clear! Enjoy a peaceful cup of tea! ğŸµ", perfect: "Perfect steep today! You're amazing âœ¨", good: "You're steeping success! ğŸµ", start: "One steep at a time ğŸµ", timerDone: "ğŸµ Steep complete!", timerFocus: "Stay focused, find your calm", freeze: "ğŸ§Š Iced Tea saved your streak!" },
      matcha: { emptyHabits: "No habits cultivated yet! Let's find balance ğŸƒ", emptyTasks: "All clear! Find your zen moment! ğŸƒ", perfect: "Perfect harmony today! You're amazing âœ¨", good: "You're finding balance! ğŸƒ", start: "One breath at a time ğŸƒ", timerDone: "ğŸƒ Meditation complete!", timerFocus: "Stay focused, embrace the calm", freeze: "ğŸ§Š Frozen Matcha saved your streak!" }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DAILY JOURNAL PROMPTS - 366 unique prompts for the year
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const journalPrompts = [
      // January - New Beginnings & Reflection (1-31)
      "What word do you want to define this year?",
      "What's one habit you'd like to build this year?",
      "Describe your ideal ordinary day.",
      "What are you most looking forward to?",
      "What lesson from last year do you want to remember?",
      "Who do you want to spend more time with?",
      "What would you do if you knew you couldn't fail?",
      "What's something you've been putting off?",
      "Describe a place where you feel completely at peace.",
      "What does success mean to you right now?",
      "What's a small joy you experienced recently?",
      "If you could master any skill instantly, what would it be?",
      "What boundaries do you need to set or maintain?",
      "Write about someone who believed in you.",
      "What are you curious about lately?",
      "What does your inner critic say? How can you respond kindly?",
      "Describe your relationship with rest.",
      "What's something you're proud of that no one knows about?",
      "What would you tell your younger self?",
      "What makes you feel most alive?",
      "What's a fear you'd like to overcome?",
      "Describe a moment of unexpected kindness.",
      "What does your ideal morning look like?",
      "What are you holding onto that you need to let go?",
      "Who has shaped who you are today?",
      "What's something you believe that most people don't?",
      "Describe a challenge that made you stronger.",
      "What brings you comfort on hard days?",
      "What's your favorite way to show love?",
      "If today was your last, what would you regret not doing?",
      "What intention do you want to set for February?",
      // February - Love & Connection (32-59)
      "What does love mean to you?",
      "Write about a friendship that changed you.",
      "How do you show yourself compassion?",
      "What's the kindest thing someone has done for you?",
      "Describe your perfect date (with anyone or alone).",
      "What do you love about your home?",
      "Who makes you laugh the hardest?",
      "What's a relationship you'd like to improve?",
      "How do you feel about vulnerability?",
      "Write a love letter to your body.",
      "What's a tradition you cherish?",
      "Describe someone you admire and why.",
      "What does self-care look like for you?",
      "What's the best advice you've received about relationships?",
      "How do you handle conflict?",
      "What makes you feel truly seen?",
      "Write about a time you forgave someone.",
      "What do you need more of in your relationships?",
      "Describe your love language in action.",
      "What's something nice you can do for someone tomorrow?",
      "How has your idea of love evolved?",
      "What boundaries protect your peace?",
      "Write about a mentor or role model.",
      "What do you love about yourself?",
      "How do you reconnect after an argument?",
      "What does unconditional love feel like?",
      "Describe a moment of deep connection.",
      "What are you grateful for in your relationships?",
      // March - Growth & Change (60-90)
      "What area of your life needs attention?",
      "Describe a time you surprised yourself.",
      "What's growing in your life right now?",
      "What do you need to prune or let go?",
      "How do you handle change?",
      "What's a belief you've outgrown?",
      "Describe your relationship with failure.",
      "What would you try if judgment didn't exist?",
      "What's one thing you can improve this week?",
      "How do you celebrate small wins?",
      "What's something difficult you're grateful for?",
      "Describe a turning point in your life.",
      "What are you learning right now?",
      "How do you stay motivated?",
      "What's holding you back from your potential?",
      "Write about a risk that paid off.",
      "What does courage look like for you today?",
      "How have you changed in the last year?",
      "What skill would improve your daily life?",
      "Describe your growth mindset (or fixed mindset).",
      "What's a mistake that taught you something valuable?",
      "How do you handle uncertainty?",
      "What are you ready to begin?",
      "Write about someone who inspires your growth.",
      "What does progress look like in your life?",
      "How do you push through resistance?",
      "What are you becoming?",
      "Describe a moment of breakthrough.",
      "What do you want to be known for?",
      "How will you nurture your growth this spring?",
      "What seeds are you planting for the future?",
      // April - Creativity & Play (91-120)
      "When did you last do something just for fun?",
      "What creative outlet calls to you?",
      "Describe your inner child.",
      "What did you love doing as a kid?",
      "How can you add more play to your life?",
      "What inspires your creativity?",
      "Write about a time you made something you were proud of.",
      "What's blocking your creative expression?",
      "Describe your ideal creative space.",
      "What would you create if you had unlimited resources?",
      "How do you feel about making mistakes in creative work?",
      "What art, music, or media moves you?",
      "Write a short story about your day (make it dramatic!).",
      "What's a creative skill you'd like to develop?",
      "How does creativity help you process emotions?",
      "Describe something beautiful you saw recently.",
      "What does your imagination show you?",
      "How can you make boring tasks more fun?",
      "Write about a creative person you admire.",
      "What hobby have you always wanted to try?",
      "How do you balance productivity and play?",
      "Describe a moment of flow state.",
      "What would you do with an unexpected free day?",
      "How does nature inspire you?",
      "What's something silly that makes you happy?",
      "Write about the colors of your current mood.",
      "How can you express yourself more authentically?",
      "What childhood game would you play again?",
      "Describe your creative dreams.",
      "How will you make space for joy this month?",
      // May - Gratitude & Abundance (121-151)
      "List 10 simple pleasures in your life.",
      "What's something free that brings you joy?",
      "Write about a person you're thankful for.",
      "What's working well in your life right now?",
      "How do you practice gratitude daily?",
      "What's a luxury you once dreamed of that you now have?",
      "Describe abundance beyond money.",
      "What are you taking for granted?",
      "Write a thank you letter you'll never send.",
      "What's the best thing about today?",
      "How has your definition of wealth changed?",
      "What do you have enough of?",
      "Describe a gift that meant the world to you.",
      "What privilege are you grateful for?",
      "How do you share your abundance with others?",
      "What's a memory that makes you smile?",
      "What modern convenience amazes you?",
      "Write about something you're grateful to have learned.",
      "What's a challenge you're now thankful for?",
      "How do you find gratitude on hard days?",
      "What's the best compliment you've received?",
      "Describe a meal that brought you joy.",
      "What are you grateful for about your body?",
      "Write about a place that fills your cup.",
      "What's something beautiful about your life story?",
      "How has gratitude changed your perspective?",
      "What opportunity are you thankful for?",
      "Describe the abundance in your ordinary day.",
      "What are you grateful for that money can't buy?",
      "How will you spread gratitude this summer?",
      "What makes your life rich?",
      // June - Energy & Vitality (152-181)
      "How does your body feel right now?",
      "What gives you energy?",
      "What drains your energy?",
      "Describe your ideal relationship with exercise.",
      "How do you honor your body's needs?",
      "What does feeling healthy mean to you?",
      "Write about a time you felt physically powerful.",
      "How do you fuel yourself (food, rest, movement)?",
      "What's one healthy habit you want to strengthen?",
      "How does nature affect your energy?",
      "Describe your sleep routine.",
      "What physical activity brings you joy?",
      "How do you listen to your body's signals?",
      "What's your relationship with rest?",
      "Write about movement that feels like celebration.",
      "How do you recharge when depleted?",
      "What does your body need more of?",
      "Describe how stress shows up in your body.",
      "What energizes you in the morning?",
      "How do you wind down at night?",
      "What's one thing you love about your body?",
      "How has your energy changed over the years?",
      "What environment makes you feel most alive?",
      "Write about a moment of physical joy.",
      "How do you balance activity and rest?",
      "What does vitality look like for you?",
      "How do you care for your future self?",
      "Describe your ideal summer day.",
      "What wellness practice serves you best?",
      "How will you honor your energy this month?",
      // July - Freedom & Adventure (182-212)
      "What does freedom mean to you?",
      "Describe an adventure you dream of taking.",
      "What's the most spontaneous thing you've done?",
      "Where would you go if you could go anywhere?",
      "What rules would you break?",
      "Write about a time you stepped outside your comfort zone.",
      "What's on your bucket list?",
      "How do you define adventure in daily life?",
      "What's something wild you've always wanted to try?",
      "Describe a perfect road trip.",
      "What freedom do you take for granted?",
      "How do you balance security and adventure?",
      "Write about a travel memory.",
      "What's the bravest thing you've ever done?",
      "How do you find adventure without leaving home?",
      "What cultural experience would you love to have?",
      "Describe your relationship with spontaneity.",
      "What's holding you back from an adventure?",
      "Write about someone who lives adventurously.",
      "What would you do with a month of total freedom?",
      "How do you handle the unknown?",
      "What's an adventure you can plan for this year?",
      "Describe feeling completely free.",
      "What small adventure can you take this week?",
      "How do you create space for exploration?",
      "What have you discovered about yourself through travel?",
      "Write about a place you want to return to.",
      "What does your spirit of adventure look like?",
      "How can you bring more adventure into ordinary days?",
      "What freedom are you working toward?",
      "What adventure awaits you?",
      // August - Wisdom & Learning (213-243)
      "What's the most important thing you've learned this year?",
      "Who is the wisest person you know?",
      "What subject fascinates you?",
      "Write about a book that changed you.",
      "What life lesson took you too long to learn?",
      "How do you approach learning new things?",
      "What would you teach others?",
      "Describe a moment of sudden understanding.",
      "What do you wish you had studied?",
      "How do you learn best?",
      "Write about a teacher who impacted you.",
      "What wisdom would you share with a younger generation?",
      "How do you stay curious?",
      "What mistake taught you the most?",
      "Describe your relationship with knowledge.",
      "What question do you keep asking yourself?",
      "How has your thinking evolved?",
      "Write about a documentary or article that moved you.",
      "What's something you recently changed your mind about?",
      "How do you handle being wrong?",
      "What's a skill you're currently developing?",
      "Describe wisdom vs. intelligence.",
      "What do you want to understand better?",
      "How do you apply what you learn?",
      "Write about a hard-won insight.",
      "What's the best thing about lifelong learning?",
      "How do you share knowledge with others?",
      "What would you study if time and money were unlimited?",
      "Describe a moment of growth mindset.",
      "What learning goal do you have for fall?",
      "What has experience taught you?",
      // September - Purpose & Direction (244-273)
      "What gives your life meaning?",
      "Describe your sense of purpose.",
      "What impact do you want to have?",
      "How do you define a meaningful life?",
      "Write about a time you felt purposeful.",
      "What cause matters most to you?",
      "How do you align your actions with your values?",
      "What legacy do you want to leave?",
      "Describe your vision for the next 5 years.",
      "What would you do if you knew it would work?",
      "How do you find direction when lost?",
      "Write about someone living their purpose.",
      "What's your personal mission?",
      "How do you balance purpose and presence?",
      "What does fulfillment feel like?",
      "Write about a meaningful project or goal.",
      "How do you stay focused on what matters?",
      "What distracts you from your purpose?",
      "Describe a moment when everything made sense.",
      "What would your ideal contribution be?",
      "How do you want to be remembered?",
      "Write about finding meaning in small things.",
      "What's the next right step for you?",
      "How do you reconnect with your why?",
      "What brings you a sense of purpose daily?",
      "Describe your north star.",
      "How has your purpose evolved?",
      "What meaningful goal are you working toward?",
      "Write about purpose in ordinary moments.",
      "How will you pursue meaning this fall?",
      // October - Fears & Shadows (274-304)
      "What fear have you overcome?",
      "Write about something that scares you.",
      "How do you face the unknown?",
      "What's your relationship with darkness?",
      "Describe a fear that's actually protecting you.",
      "What would you do if you weren't afraid?",
      "How do you comfort yourself when anxious?",
      "Write about a nightmare and what it might mean.",
      "What's hiding in your shadow?",
      "How do you find courage?",
      "What fear is holding you back?",
      "Describe making peace with uncertainty.",
      "What's the worst that could happen? Really?",
      "How do you transform fear into action?",
      "Write about facing something difficult.",
      "What do you avoid thinking about?",
      "How has fear shaped your choices?",
      "What would brave you do?",
      "Describe a time fear was a teacher.",
      "What's on the other side of your fear?",
      "How do you sit with discomfort?",
      "Write about something you've been denying.",
      "What part of yourself needs acceptance?",
      "How do you build courage daily?",
      "What's a healthy fear vs. an unhealthy one?",
      "Describe your relationship with change.",
      "What are you afraid to want?",
      "How do you face your shadows?",
      "Write about growth through discomfort.",
      "What fear can you release before November?",
      "What truth have you been avoiding?",
      // November - Home & Belonging (305-334)
      "What does home mean to you?",
      "Describe where you feel you belong.",
      "What traditions give you comfort?",
      "Write about your roots.",
      "How do you create home wherever you are?",
      "What does your ideal home feel like?",
      "Who are your chosen family?",
      "Describe a meal that feels like home.",
      "What makes you feel like you belong?",
      "How do you cultivate community?",
      "Write about a place that shaped you.",
      "What objects make a space feel like yours?",
      "How do you welcome others into your life?",
      "Describe the feeling of returning home.",
      "What traditions do you want to create?",
      "How do you find belonging in new places?",
      "Write about someone who feels like home.",
      "What does sanctuary mean to you?",
      "How do you nurture your sense of belonging?",
      "What's your relationship with your hometown?",
      "Describe your inner home.",
      "What makes you feel rooted?",
      "How do you handle feeling like an outsider?",
      "Write about chosen family.",
      "What does hospitality mean to you?",
      "How do you create belonging for others?",
      "What's the heart of your home?",
      "Describe a community you're part of.",
      "What makes you grateful for your home?",
      "How will you cultivate warmth this season?",
      // December - Reflection & Renewal (335-366)
      "What was this year's biggest lesson?",
      "Describe a highlight from each month.",
      "What are you most proud of this year?",
      "Write about a challenge you overcame.",
      "What surprised you about this year?",
      "How have you grown?",
      "What relationships deepened this year?",
      "Describe a moment of joy from this year.",
      "What do you want to leave behind?",
      "How did your priorities shift?",
      "Write about a risk you took.",
      "What brought unexpected happiness?",
      "How did you take care of yourself?",
      "What goal did you achieve?",
      "Describe a moment of peace this year.",
      "What do you want more of next year?",
      "How did you show up for others?",
      "Write about something that didn't go as planned.",
      "What are you ready to release?",
      "How did you practice gratitude?",
      "What new habit stuck?",
      "Describe your year in three words.",
      "What do you appreciate about yourself?",
      "How did you handle difficult moments?",
      "Write a letter to next year's you.",
      "What do you want to remember about this year?",
      "How did you find moments of stillness?",
      "What are you hopeful about?",
      "Describe the person you're becoming.",
      "What's your intention for the new year?",
      "How will you celebrate how far you've come?",
      "What's the first thing you want to do next year?"
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHALLENGES SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const weeklyChallengeDefs = [
      { id: 'habits_21', name: 'Habit Hero', desc: 'Complete 21 habits this week', target: 21, type: 'habits', xp: 100, icon: 'â­' },
      { id: 'tasks_15', name: 'Task Tornado', desc: 'Complete 15 tasks this week', target: 15, type: 'tasks', xp: 75, icon: 'ğŸŒªï¸' },
      { id: 'focus_120', name: 'Deep Focus Week', desc: 'Focus for 2 hours total', target: 120, type: 'focus', xp: 100, icon: 'ğŸ¯' },
      { id: 'mood_7', name: 'Mood Tracker', desc: 'Log mood every day', target: 7, type: 'moods', xp: 50, icon: 'ğŸ˜Š' },
      { id: 'perfect_3', name: 'Triple Threat', desc: '3 perfect days', target: 3, type: 'perfect', xp: 150, icon: 'âœ¨' },
    ];

    const monthlyChallengeDefs = [
      { id: 'habits_100', name: 'Century Club', desc: '100 habits this month', target: 100, type: 'habits', xp: 300, icon: 'ğŸ’¯' },
      { id: 'streak_14', name: 'Fortnight Force', desc: '14-day streak', target: 14, type: 'streak', xp: 200, icon: 'ğŸ”¥' },
      { id: 'journal_20', name: 'Diary Devotee', desc: '20 journal entries', target: 20, type: 'journal', xp: 250, icon: 'ğŸ“š' },
      { id: 'focus_600', name: 'Focus Master', desc: '10 hours of focus', target: 600, type: 'focus', xp: 350, icon: 'ğŸ§ ' },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI COACH TIPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const getDailyTip = (stats, brewType) => {
      const tips = {
        coffee: {
          lowMood: "â˜• Feeling a bit flat? Sometimes a change of scenery or a short walk can perk you up like a fresh espresso!",
          streakRisk: "â˜• Your streak is precious! Even completing one small habit keeps the momentum brewing.",
          perfectDay: "â˜• You're on fire today! Keep this energy going - you're the head barista of your life!",
          morning: "â˜• Good morning! Start with your easiest habit - it's like that first sip of coffee that gets everything flowing.",
          evening: "â˜• Winding down? Take a moment to reflect on your wins today. Every small step counts!",
          newUser: "â˜• Welcome to the cafÃ©! Start small - pick just one habit and make it your daily ritual.",
          focusTip: "â˜• Try the Pomodoro technique: 25 minutes of focus, then a coffee break!",
          habitTip: "â˜• Stack your habits! Do your new habit right after something you already do daily.",
        },
        tea: {
          lowMood: "ğŸµ Feeling low? Take a mindful moment. Brew some tea and breathe deeply - calm is coming.",
          streakRisk: "ğŸµ Your streak is like a delicate tea - nurture it with just one small action today.",
          perfectDay: "ğŸµ Beautiful harmony today! You're steeping in success and it shows!",
          morning: "ğŸµ Good morning! Like a gentle tea, ease into your day with your simplest habit first.",
          evening: "ğŸµ Evening reflection time. What brought you peace today? Savor those moments.",
          newUser: "ğŸµ Welcome, friend! Start with one calming habit. Let it steep into your routine naturally.",
          focusTip: "ğŸµ Focus is like steeping tea - give it time and attention for the best results.",
          habitTip: "ğŸµ Attach new habits to your tea time for a soothing ritual.",
        },
        matcha: {
          lowMood: "ğŸƒ Feeling unbalanced? Return to your breath. Each moment is a chance to find your center again.",
          streakRisk: "ğŸƒ Your streak is part of your practice. Honor it with even the smallest mindful action.",
          perfectDay: "ğŸƒ Perfect balance achieved! You are the master of your own zen garden today!",
          morning: "ğŸƒ Good morning! Begin with intention. What will bring you harmony today?",
          evening: "ğŸƒ As the day settles, reflect on your journey. Growth happens in stillness too.",
          newUser: "ğŸƒ Welcome to the path! One small habit, practiced with intention, creates lasting change.",
          focusTip: "ğŸƒ Focus is meditation in action. Be present with your task, breath by breath.",
          habitTip: "ğŸƒ Let habits flow naturally, like water finding its path. Don't force - allow.",
        }
      };
      
      const hour = new Date().getHours();
      const brewTips = tips[brewType];
      
      if (stats.moodDaysTracked > 0 && stats.lastMoodValue <= 2) return brewTips.lowMood;
      if (stats.appStreak > 3 && stats.perfectDayToday === false && hour >= 20) return brewTips.streakRisk;
      if (stats.perfectDayToday) return brewTips.perfectDay;
      if (stats.totalHabitsCompleted < 5) return brewTips.newUser;
      if (hour < 10) return brewTips.morning;
      if (hour >= 18) return brewTips.evening;
      if (Math.random() > 0.5) return brewTips.focusTip;
      return brewTips.habitTip;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THEME SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const brewThemes = {
      coffee: {
        icon: 'â˜•', name: 'Coffee',
        light: { id: 'coffee-light', name: 'Light Brew', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #F5E6D3 0%, #FDFBF7 50%, #F5E6D3 100%)', cardBg: 'linear-gradient(145deg, #FDFBF7 0%, #FBF7F0 100%)', cardBorder: '#E8DCC8', text: '#5D4037', textSecondary: '#8B7355', textMuted: '#C4A77D', accent: '#8B7355', accentLight: '#E8DCC8', accentGradient: 'linear-gradient(145deg, #8B7355 0%, #6B5344 100%)', inputBg: '#FDFBF7', inputBorder: '#D4C4A8', progressBg: '#F0E6D8', streakGradient: 'linear-gradient(145deg, #D4A574 0%, #C4946A 100%)', navBg: 'rgba(253, 251, 247, 0.95)', modalBg: '#FDFBF7', success: '#8FB573', danger: '#C57373', xpBar: 'linear-gradient(90deg, #D4A574 0%, #8B7355 100%)', themeColor: '#5D4037', isDark: false },
        dark: { id: 'coffee-dark', name: 'Dark Brew', icon: 'ğŸŒ™', bg: 'linear-gradient(180deg, #1A1412 0%, #2D2320 50%, #1A1412 100%)', cardBg: 'linear-gradient(145deg, #2D2320 0%, #3D322E 100%)', cardBorder: '#4A3F3A', text: '#F5E6D3', textSecondary: '#C4A77D', textMuted: '#8B7355', accent: '#D4A574', accentLight: '#3D322E', accentGradient: 'linear-gradient(145deg, #D4A574 0%, #C4946A 100%)', inputBg: '#2D2320', inputBorder: '#4A3F3A', progressBg: '#3D322E', streakGradient: 'linear-gradient(145deg, #C4946A 0%, #A67B5B 100%)', navBg: 'rgba(45, 35, 32, 0.95)', modalBg: '#2D2320', success: '#7A9A6A', danger: '#9A6A6A', xpBar: 'linear-gradient(90deg, #C4946A 0%, #8B6B4A 100%)', themeColor: '#1A1412', isDark: true }
      },
      tea: {
        icon: 'ğŸµ', name: 'Tea',
        light: { id: 'tea-light', name: 'White Tea', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #FDF8E8 0%, #FFFDF5 50%, #FDF8E8 100%)', cardBg: 'linear-gradient(145deg, #FFFDF5 0%, #FDF8E8 100%)', cardBorder: '#E8DFB8', text: '#6B5D14', textSecondary: '#8B7B34', textMuted: '#C4B477', accent: '#A8923D', accentLight: '#F0E8C8', accentGradient: 'linear-gradient(145deg, #C4A43D 0%, #A8862D 100%)', inputBg: '#FFFDF5', inputBorder: '#D4C898', progressBg: '#F5EED8', streakGradient: 'linear-gradient(145deg, #D4B454 0%, #C4A444 100%)', navBg: 'rgba(255, 253, 245, 0.95)', modalBg: '#FFFDF5', success: '#8FB573', danger: '#C57373', xpBar: 'linear-gradient(90deg, #D4B454 0%, #A8923D 100%)', themeColor: '#A8923D', isDark: false },
        dark: { id: 'tea-dark', name: 'Black Tea', icon: 'ğŸŒ™', bg: 'linear-gradient(180deg, #1A1808 0%, #2D2810 50%, #1A1808 100%)', cardBg: 'linear-gradient(145deg, #2D2810 0%, #3D3820 100%)', cardBorder: '#4A4530', text: '#F5EED3', textSecondary: '#C4B477', textMuted: '#8B7B34', accent: '#D4B454', accentLight: '#3D3820', accentGradient: 'linear-gradient(145deg, #D4B454 0%, #C4A444 100%)', inputBg: '#2D2810', inputBorder: '#4A4530', progressBg: '#3D3820', streakGradient: 'linear-gradient(145deg, #C4A444 0%, #A48B3B 100%)', navBg: 'rgba(45, 40, 16, 0.95)', modalBg: '#2D2810', success: '#7A9A6A', danger: '#9A6A6A', xpBar: 'linear-gradient(90deg, #C4A444 0%, #8B7B34 100%)', themeColor: '#1A1808', isDark: true }
      },
      matcha: {
        icon: 'ğŸƒ', name: 'Matcha',
        light: { id: 'matcha-light', name: 'Light Matcha', icon: 'â˜€ï¸', bg: 'linear-gradient(180deg, #EFF5E6 0%, #F8FBF5 50%, #EFF5E6 100%)', cardBg: 'linear-gradient(145deg, #F8FBF5 0%, #EFF5E6 100%)', cardBorder: '#D4E4C4', text: '#3D5D2D', textSecondary: '#5B7B4B', textMuted: '#9AB48A', accent: '#6B8B5B', accentLight: '#E0EED4', accentGradient: 'linear-gradient(145deg, #7B9B6B 0%, #5B7B4B 100%)', inputBg: '#F8FBF5', inputBorder: '#C4D4B4', progressBg: '#E4EED8', streakGradient: 'linear-gradient(145deg, #8BAB7B 0%, #7B9B6B 100%)', navBg: 'rgba(248, 251, 245, 0.95)', modalBg: '#F8FBF5', success: '#7B9B6B', danger: '#B57373', xpBar: 'linear-gradient(90deg, #8BAB7B 0%, #6B8B5B 100%)', themeColor: '#6B8B5B', isDark: false },
        dark: { id: 'matcha-dark', name: 'Dark Matcha', icon: 'ğŸŒ™', bg: 'linear-gradient(180deg, #0F1A0C 0%, #1E2D18 50%, #0F1A0C 100%)', cardBg: 'linear-gradient(145deg, #1E2D18 0%, #2E3D28 100%)', cardBorder: '#3A4A34', text: '#E4EED8', textSecondary: '#9AB48A', textMuted: '#5B7B4B', accent: '#8BAB7B', accentLight: '#2E3D28', accentGradient: 'linear-gradient(145deg, #8BAB7B 0%, #7B9B6B 100%)', inputBg: '#1E2D18', inputBorder: '#3A4A34', progressBg: '#2E3D28', streakGradient: 'linear-gradient(145deg, #7B9B6B 0%, #6B8B5B 100%)', navBg: 'rgba(30, 45, 24, 0.95)', modalBg: '#1E2D18', success: '#6B8B5B', danger: '#8B5B5B', xpBar: 'linear-gradient(90deg, #7B9B6B 0%, #5B7B4B 100%)', themeColor: '#0F1A0C', isDark: true }
      }
    };

    const categories = [
      { id: 'health', name: 'Health', icon: 'ğŸ’ª', color: '#7BB56B' },
      { id: 'work', name: 'Work', icon: 'ğŸ’¼', color: '#8B6BB5' },
      { id: 'creative', name: 'Creative', icon: 'ğŸ¨', color: '#B5956B' },
      { id: 'social', name: 'Social', icon: 'ğŸ‘¥', color: '#B56BB5' },
      { id: 'chores', name: 'Chores', icon: 'ğŸ ', color: '#6BB5B5' },
      { id: 'self', name: 'Self Care', icon: 'ğŸ’†', color: '#B56B8B' },
    ];

    const defaultEmojis = ['ğŸ’§','ğŸƒ','ğŸ“–','ğŸ˜´','ğŸ¥—','ğŸ“','ğŸ¨','ğŸ§˜','ğŸ’¬','âœ¨','ğŸµ','ğŸš¶','ğŸƒ','ğŸ““','ğŸ¤¸','ğŸ’Š','ğŸ§¹','ğŸŒ…','ğŸ','ğŸ’¤','ğŸ¯','ğŸ“±','ğŸ§ ','â¤ï¸','ğŸŒ¿','â˜€ï¸','ğŸŒ™','â­','ğŸ”¥','ğŸ’ª'];
    const moodEmojis = [{ emoji: 'ğŸ˜¢', label: 'Rough', value: 1 }, { emoji: 'ğŸ˜•', label: 'Meh', value: 2 }, { emoji: 'ğŸ˜Š', label: 'Good', value: 3 }, { emoji: 'ğŸ˜„', label: 'Great', value: 4 }, { emoji: 'ğŸ¤©', label: 'Amazing', value: 5 }];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WHAT'S NEW CONTENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const whatsNewContent = [
      { version: '6.4', title: 'ğŸµ Refined Experience', items: [
        { icon: 'ğŸ¹', title: 'Improved Music', desc: 'Faster, more harmonious chord progressions' },
        { icon: 'ğŸ›¡ï¸', title: 'XP Protection', desc: 'No more XP exploits from re-checking' },
        { icon: 'ğŸ—‘ï¸', title: 'Safe Deletion', desc: 'Confirmation required before deleting' },
        { icon: 'ğŸŒ¤ï¸', title: 'Live Weather', desc: 'Current conditions in your header' },
        { icon: 'ğŸ””', title: 'Notifications', desc: 'Enable reminders in settings' },
      ]},
      { version: '6.0', title: 'ğŸ‰ Grand Reopening!', items: [
        { icon: 'ğŸšï¸', title: 'Volume Sliders', desc: 'Control ambiance & music independently' },
        { icon: 'ğŸ ', title: 'Mood Presets', desc: 'Cozy, Chill, Upbeat, Soothing, Meditative, Focus' },
        { icon: 'ğŸŒ™', title: 'Light/Dark Sound', desc: 'Sounds adapt to your color theme' },
        { icon: 'ğŸ‚', title: 'Seasonal Themes', desc: 'Automatic decorations for each season' },
        { icon: 'ğŸ†', title: 'Challenges', desc: 'Weekly & monthly goals for XP' },
        { icon: 'ğŸ“…', title: 'Year in Review', desc: 'See your complete journey' },
      ]},
      { version: '5.0', title: 'â˜• Themed Experience', items: [
        { icon: 'â˜•ğŸµğŸƒ', title: 'Brew-Specific Everything', desc: 'Ranks, badges, and messages match your brew' },
        { icon: 'â±ï¸', title: 'Custom Timer', desc: 'Set any focus duration you want' },
        { icon: 'ğŸ“Š', title: 'Mood Insights', desc: 'See how habits affect your mood' },
      ]},
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TUTORIAL STEPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const tutorialSteps = [
      { id: 'welcome', title: 'Welcome to the CafÃ©! â˜•', subtitle: 'Pull up a chair, friend!', content: "We've been busy renovating! Your cozy productivity companion is now better than ever. Let me show you around the new digs!", icon: 'ğŸ ', highlight: null },
      { id: 'brew', title: 'Pick Your Signature Drink', subtitle: 'Every regular has their usual...', content: "Choose Coffee â˜•, Tea ğŸµ, or Matcha ğŸƒ - each with unique ranks, badges, and vibes. Your whole experience adapts to your brew!", icon: 'â˜•', highlight: 'theme' },
      { id: 'habits', title: 'Your Daily Specials', subtitle: 'The menu of good habits!', content: "Add habits you want to build. Tap or swipe right to complete. Use the ğŸ—‘ button to remove (with confirmation). Build streaks and watch them grow!", icon: 'â­', highlight: 'habits' },
      { id: 'tasks', title: 'Today\'s Orders', subtitle: 'One task at a time, barista!', content: "Add tasks with priorities, categories, times, and subtasks. Set them to repeat daily, on weekdays, or weekly!", icon: 'âœ“', highlight: 'tasks' },
      { id: 'timer', title: 'The Focus Bar', subtitle: 'Time to get in the zone!', content: "Use our cozy focus timer with brew-specific soundscapes. Pick a preset or set your own custom duration. Deep work, cafÃ© style!", icon: 'â±ï¸', highlight: 'timer' },
      { id: 'journal', title: 'The Corner Booth', subtitle: 'Your private reflection spot...', content: "Journal your gratitude, daily reflections, and tomorrow's plans. It's your cozy corner for self-discovery.", icon: 'ğŸ“', highlight: 'journal' },
      { id: 'challenges', title: 'Weekly Specials Board', subtitle: 'Extra rewards await!', content: "Check out weekly and monthly challenges for bonus XP. Push yourself and earn special recognition!", icon: 'ğŸ†', highlight: 'challenges' },
      { id: 'streak', title: 'Streak Insurance', subtitle: 'We\'ve got your back!', content: "Life happens! You get one free streak freeze per week. If you miss a day, it activates automatically to protect your progress.", icon: 'â„ï¸', highlight: 'streak' },
      { id: 'sounds', title: 'Your Signature Soundtrack', subtitle: 'Set the perfect mood...', content: "Tap the ğŸµ button anytime to open Soundscape. Choose a mood (Cozy, Chill, Focus...), adjust volume sliders, and mix any ambiance with any music. Light mode sounds brighter, dark mode sounds warmer!", icon: 'ğŸµ', highlight: 'sounds' },
      { id: 'ready', title: 'Your Table is Ready!', subtitle: 'Time to make it yours...', content: "That's the grand tour! Remember, every small sip of progress counts. Your journey to better habits starts with a single step. Enjoy your stay! â˜•", icon: 'âœ¨', highlight: null },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SWIPEABLE COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function SwipeableCard({ children, onSwipeLeft, onSwipeRight, style }) {
      const [touchStart, setTouchStart] = useState(null);
      const [touchEnd, setTouchEnd] = useState(null);
      const [offset, setOffset] = useState(0);
      const minSwipe = 50;
      const onTouchStart = (e) => { setTouchEnd(null); setTouchStart(e.targetTouches[0].clientX); };
      const onTouchMove = (e) => { setTouchEnd(e.targetTouches[0].clientX); if (touchStart) setOffset(e.targetTouches[0].clientX - touchStart); };
      const onTouchEnd = () => { if (!touchStart || !touchEnd) { setOffset(0); return; } const dist = touchStart - touchEnd; if (dist > minSwipe && onSwipeLeft) onSwipeLeft(); if (dist < -minSwipe && onSwipeRight) onSwipeRight(); setOffset(0); };
      const bgColor = offset > minSwipe ? 'rgba(139,181,115,0.3)' : offset < -minSwipe ? 'rgba(197,115,115,0.3)' : 'transparent';
      return (<div onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd} style={{ ...style, transform: `translateX(${Math.max(-100, Math.min(100, offset * 0.5))}px)`, transition: offset === 0 ? 'transform 0.2s' : 'none', background: bgColor }}>{children}</div>);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function App() {
      const APP_VERSION = '6.7.0';
      const season = getCurrentSeason();
      const seasonDeco = seasonalDecorations[season];

      // Core state
      const [brewType, setBrewType] = useState(() => load('brewType', 'coffee'));
      const [isDark, setIsDark] = useState(() => load('isDark', false));
      const [highContrast, setHighContrast] = useState(() => load('highContrast', false));
      const theme = brewThemes[brewType][isDark ? 'dark' : 'light'];
      const levels = brewRanks[brewType];
      const badges = brewBadges[brewType];
      const messages = brewMessages[brewType];

      const [activeTab, setActiveTab] = useState('today');
      const [habits, setHabits] = useState(() => load('habits', [{ id: 1, name: 'Drink water', icon: 'ğŸ’§', completed: false, streak: 0, history: {} }]));
      const [tasks, setTasks] = useState(() => load('tasks', []));
      const [moods, setMoods] = useState(() => load('moods', {}));
      const [journal, setJournal] = useState(() => load('journal', {}));
      const [habitHistory, setHabitHistory] = useState(() => load('habitHistory', {}));
      const [gameStats, setGameStats] = useState(() => load('gameStats', { xp: 0, totalHabitsCompleted: 0, totalTasksCompleted: 0, perfectDays: 0, moodDaysTracked: 0, totalFocusMinutes: 0, journalEntries: 0, earlyTasks: 0, lateTasks: 0, appStreak: 0, maxStreak: 0, lastActiveDate: null, unlockedBadges: [], freezesAvailable: 1, freezesUsed: 0, weeklyFreeze: null, challengesCompleted: 0, timesShared: 0, timesExported: 0, lastMoodValue: 3, perfectDayToday: false }));
      const [challenges, setChallenges] = useState(() => load('challenges', { weekly: { id: null, progress: 0, week: null }, monthly: { id: null, progress: 0, month: null } }));
      const [dailyXPAwarded, setDailyXPAwarded] = useState(() => {
        const saved = load('dailyXPAwarded', { date: null, habits: [], tasks: [] });
        // Reset if it's a new day
        if (saved.date !== getDateKey()) return { date: getDateKey(), habits: [], tasks: [] };
        return saved;
      });
      const [cafeName, setCafeName] = useState(() => load('cafeName', 'My Daily Brew'));

      // UI state
      const [showWhatsNew, setShowWhatsNew] = useState(() => load('lastSeenVersion', '0') !== APP_VERSION);
      const [showTutorial, setShowTutorial] = useState(false);
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showAddHabit, setShowAddHabit] = useState(false);
      const [showAddTask, setShowAddTask] = useState(false);
      const [showThemePicker, setShowThemePicker] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showBadges, setShowBadges] = useState(false);
      const [showQuickAdd, setShowQuickAdd] = useState(false);
      const [showSubtaskInput, setShowSubtaskInput] = useState(null);
      const [showChallenges, setShowChallenges] = useState(false);
      const [showYearReview, setShowYearReview] = useState(false);
      const [showCustomTimer, setShowCustomTimer] = useState(false);
      const [showExport, setShowExport] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState(null); // { type: 'habit'|'task', id, name }
      const [celebration, setCelebration] = useState(null);
      const [undoAction, setUndoAction] = useState(null);
      const [showDailyTip, setShowDailyTip] = useState(() => load('lastTipDate', '') !== getDateKey());
      const [showNotificationPrompt, setShowNotificationPrompt] = useState(() => !load('notificationPromptDismissed', false));
      const [weather, setWeather] = useState(() => load('weather', { temp: null, icon: null, lastFetch: null }));
      const [newHabit, setNewHabit] = useState({ name: '', icon: 'ğŸ’§' });
      const [newTask, setNewTask] = useState({ text: '', time: '', priority: 'medium', category: null, recurring: 'none', subtasks: [] });
      const [newSubtask, setNewSubtask] = useState('');
      const [calendarDate, setCalendarDate] = useState(new Date());
      const [timerSeconds, setTimerSeconds] = useState(25 * 60);
      const [timerRunning, setTimerRunning] = useState(false);
      const [timerTask, setTimerTask] = useState(null);
      const [timerStartTime, setTimerStartTime] = useState(null);
      const [customTimerMins, setCustomTimerMins] = useState(25);
      const [ambientSound, setAmbientSound] = useState(() => load('ambientSound', 'off')); // 'off', 'ambiance', 'music', 'both'
      const [musicTrack, setMusicTrack] = useState(() => load('musicTrack', 'auto')); // 'auto' or specific track id
      const [ambianceTrack, setAmbianceTrack] = useState(() => load('ambianceTrack', 'auto')); // 'auto' or specific track id
      const [ambianceVolume, setAmbianceVolume] = useState(() => load('ambianceVolume', 35)); // 0-100
      const [musicVolume, setMusicVolume] = useState(() => load('musicVolume', 25)); // 0-100
      const [soundMood, setSoundMood] = useState(() => load('soundMood', 'cozy')); // kept for ambiance mood override
      const [backgroundPlay, setBackgroundPlay] = useState(() => load('backgroundPlay', false));
      const [soundEnabled, setSoundEnabled] = useState(false); // Whether sound is currently playing
      const [showSoundMenu, setShowSoundMenu] = useState(false);
      
      // Audio file definitions
      const musicTracks = {
        'cafe-contemplations': { name: 'CafÃ© Contemplations', icon: 'â˜•', file: 'sounds/cafe-contemplations.mp3', theme: 'coffee', mode: 'light' },
        'elegant-background': { name: 'Elegant Background', icon: 'ğŸ¹', file: 'sounds/elegant-background.mp3', theme: 'coffee', mode: 'dark' },
        'tea-time-piano': { name: 'Tea Time Piano', icon: 'ğŸµ', file: 'sounds/tea-time-piano.mp3', theme: 'tea', mode: 'light' },
        'minimal-lofi': { name: 'Minimal Lo-Fi', icon: 'ğŸ§', file: 'sounds/minimal-lofi.mp3', theme: 'tea', mode: 'dark' },
        'zen-garden': { name: 'Zen Garden', icon: 'ğŸ‹', file: 'sounds/zen-garden.mp3', theme: 'matcha', mode: 'light' },
        'japanese-lofi': { name: 'Japanese Lo-Fi', icon: 'ğŸ‡¯ğŸ‡µ', file: 'sounds/japanese-lofi.mp3', theme: 'matcha', mode: 'dark' },
      };
      
      const ambianceTracks = {
        'fireplace': { name: 'Fireplace', icon: 'ğŸ”¥', file: 'sounds/fireplace.mp3', theme: 'coffee', mood: 'cozy' },
        'rain': { name: 'Soft Rain', icon: 'ğŸŒ§ï¸', file: 'sounds/rain.mp3', theme: 'tea' },
        'wind': { name: 'Wind in Trees', icon: 'ğŸƒ', file: 'sounds/wind.mp3', theme: 'matcha' },
        'ocean': { name: 'Ocean Waves', icon: 'ğŸŒŠ', file: 'sounds/ocean.mp3', mood: 'soothing' },
      };
      
      // Get active track based on auto-selection or manual override
      const getActiveMusicTrack = useCallback(() => {
        if (musicTrack !== 'auto') return musicTrack;
        // Auto selection: theme + light/dark mode
        const mode = isDark ? 'dark' : 'light';
        const match = Object.entries(musicTracks).find(([id, t]) => 
          t.theme === brewType && t.mode === mode
        );
        return match ? match[0] : 'cafe-contemplations';
      }, [musicTrack, brewType, isDark]);
      
      const getActiveAmbianceTrack = useCallback(() => {
        if (ambianceTrack !== 'auto') return ambianceTrack;
        // Auto selection: mood override first, then theme-based defaults
        if (soundMood === 'cozy') return 'fireplace';
        if (soundMood === 'soothing') return 'ocean';
        // Theme-based defaults: coffeeâ†’fireplace, teaâ†’rain, matchaâ†’wind
        if (brewType === 'coffee') return 'fireplace';
        if (brewType === 'tea') return 'rain';
        if (brewType === 'matcha') return 'wind';
        return 'fireplace';
      }, [ambianceTrack, brewType, soundMood]);
      
      // Audio refs for HTML5 Audio elements
      const musicAudioRef = useRef(null);
      const ambianceAudioRef = useRef(null);
      
      const [todayJournal, setTodayJournal] = useState(() => load('journal', {})[getDateKey()] || { gratitude: '', reflection: '', tomorrow: '', promptResponse: '' });
      
      // Get today's journal prompt (0-365 based on day of year)
      const getDayOfYear = (date) => {
        const start = new Date(date.getFullYear(), 0, 0);
        const diff = date - start;
        const oneDay = 1000 * 60 * 60 * 24;
        return Math.floor(diff / oneDay) - 1; // 0-indexed
      };
      const todayPrompt = journalPrompts[getDayOfYear(new Date())] || journalPrompts[0];
      
      const timerRef = useRef(null);

      const today = new Date();
      const todayKey = getDateKey();
      const currentYear = today.getFullYear();

      // Save effects
      useEffect(() => { store('habits', habits); }, [habits]);
      useEffect(() => { store('tasks', tasks); }, [tasks]);
      useEffect(() => { store('moods', moods); }, [moods]);
      useEffect(() => { store('journal', journal); }, [journal]);
      useEffect(() => { store('habitHistory', habitHistory); }, [habitHistory]);
      useEffect(() => { store('gameStats', gameStats); }, [gameStats]);
      useEffect(() => { store('challenges', challenges); }, [challenges]);
      useEffect(() => { store('dailyXPAwarded', dailyXPAwarded); }, [dailyXPAwarded]);
      useEffect(() => { store('brewType', brewType); }, [brewType]);
      useEffect(() => { store('isDark', isDark); }, [isDark]);
      useEffect(() => { store('highContrast', highContrast); }, [highContrast]);
      useEffect(() => { store('cafeName', cafeName); }, [cafeName]);
      useEffect(() => { store('ambientSound', ambientSound); }, [ambientSound]);
      useEffect(() => { store('musicTrack', musicTrack); }, [musicTrack]);
      useEffect(() => { store('ambianceTrack', ambianceTrack); }, [ambianceTrack]);
      useEffect(() => { store('ambianceVolume', ambianceVolume); }, [ambianceVolume]);
      useEffect(() => { store('musicVolume', musicVolume); }, [musicVolume]);
      useEffect(() => { store('soundMood', soundMood); }, [soundMood]);
      useEffect(() => { store('backgroundPlay', backgroundPlay); }, [backgroundPlay]);
      useEffect(() => { store('weather', weather); }, [weather]);
      useEffect(() => { document.getElementById('themeColor').content = theme.themeColor; }, [theme]);

      // Weather fetching
      useEffect(() => {
        const fetchWeather = async () => {
          // Only fetch if last fetch was more than 30 minutes ago
          if (weather.lastFetch && Date.now() - weather.lastFetch < 30 * 60 * 1000) return;
          
          try {
            // Get user's location
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(async (position) => {
              const { latitude, longitude } = position.coords;
              // Using Open-Meteo (free, no API key needed)
              const response = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`
              );
              if (!response.ok) return;
              const data = await response.json();
              
              // Map weather codes to icons
              const weatherIcons = {
                0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸',
                45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
                51: 'ğŸŒ§ï¸', 53: 'ğŸŒ§ï¸', 55: 'ğŸŒ§ï¸',
                61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸',
                71: 'ğŸŒ¨ï¸', 73: 'ğŸŒ¨ï¸', 75: 'ğŸŒ¨ï¸',
                77: 'ğŸŒ¨ï¸', 80: 'ğŸŒ¦ï¸', 81: 'ğŸŒ¦ï¸', 82: 'ğŸŒ¦ï¸',
                85: 'ğŸŒ¨ï¸', 86: 'ğŸŒ¨ï¸',
                95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
              };
              
              const temp = Math.round(data.current.temperature_2m);
              const icon = weatherIcons[data.current.weather_code] || 'ğŸŒ¡ï¸';
              
              setWeather({ temp, icon, lastFetch: Date.now() });
            }, () => {
              // Geolocation denied - silently fail
            }, { timeout: 10000 });
          } catch (e) {
            // Weather fetch failed - silently fail
          }
        };
        
        fetchWeather();
        // Refresh every 30 minutes
        const interval = setInterval(fetchWeather, 30 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AUDIO SYSTEM - HTML5 Audio with crossfade looping
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      const FADE_DURATION = 3000; // 3 seconds for fade in/out
      const CROSSFADE_BUFFER = 4; // Start crossfade 4 seconds before end
      
      // Refs for managing crossfade
      const musicNextRef = useRef(null); // For crossfade overlap
      const ambianceNextRef = useRef(null);
      const fadeIntervalsRef = useRef({ music: null, ambiance: null, musicNext: null, ambianceNext: null });
      
      // Fade audio volume smoothly
      const fadeAudio = useCallback((audio, fromVol, toVol, duration, onComplete) => {
        if (!audio) return null;
        const steps = 30;
        const stepTime = duration / steps;
        const volStep = (toVol - fromVol) / steps;
        let currentStep = 0;
        
        const interval = setInterval(() => {
          currentStep++;
          const newVol = Math.max(0, Math.min(1, fromVol + (volStep * currentStep)));
          try { audio.volume = newVol; } catch(e) {}
          
          if (currentStep >= steps) {
            clearInterval(interval);
            if (onComplete) onComplete();
          }
        }, stepTime);
        
        return interval;
      }, []);
      
      // Setup crossfade looping for an audio element
      const setupCrossfadeLoop = useCallback((audio, file, targetVolume, type) => {
        if (!audio) return;
        
        const handleTimeUpdate = () => {
          if (!audio || audio.paused) return;
          
          const timeLeft = audio.duration - audio.currentTime;
          const nextRef = type === 'music' ? musicNextRef : ambianceNextRef;
          
          // Start crossfade when approaching end
          if (timeLeft <= CROSSFADE_BUFFER && timeLeft > CROSSFADE_BUFFER - 0.5 && !nextRef.current) {
            // Create next audio for seamless loop
            const nextAudio = new Audio(file);
            nextAudio.volume = 0;
            nextAudio.play().catch(() => {});
            nextRef.current = nextAudio;
            
            // Fade out current
            fadeIntervalsRef.current[type] = fadeAudio(audio, targetVolume, 0, FADE_DURATION, () => {
              audio.pause();
              audio.currentTime = 0;
            });
            
            // Fade in next
            fadeIntervalsRef.current[type + 'Next'] = fadeAudio(nextAudio, 0, targetVolume, FADE_DURATION, () => {
              // Swap refs - next becomes current
              if (type === 'music') {
                musicAudioRef.current = nextAudio;
                musicNextRef.current = null;
              } else {
                ambianceAudioRef.current = nextAudio;
                ambianceNextRef.current = null;
              }
              // Setup crossfade on the new current
              setupCrossfadeLoop(nextAudio, file, targetVolume, type);
            });
          }
        };
        
        audio.addEventListener('timeupdate', handleTimeUpdate);
        audio.dataset.hasCrossfade = 'true';
        
        return () => audio.removeEventListener('timeupdate', handleTimeUpdate);
      }, [fadeAudio]);
      
      // Start audio with fade in
      const startAudioWithFade = useCallback((file, targetVolume, type) => {
        const audio = new Audio(file);
        audio.volume = 0;
        audio.loop = false; // We handle looping manually for crossfade
        
        audio.play().then(() => {
          // Fade in
          fadeAudio(audio, 0, targetVolume, FADE_DURATION);
          // Setup crossfade loop
          setupCrossfadeLoop(audio, file, targetVolume, type);
        }).catch(e => console.log(`${type} autoplay blocked:`, e));
        
        return audio;
      }, [fadeAudio, setupCrossfadeLoop]);
      
      // Stop audio with fade out
      const stopAudioWithFade = useCallback((audioRef, nextRef, type) => {
        // Clear any existing fade intervals
        if (fadeIntervalsRef.current[type]) clearInterval(fadeIntervalsRef.current[type]);
        if (fadeIntervalsRef.current[type + 'Next']) clearInterval(fadeIntervalsRef.current[type + 'Next']);
        
        const audio = audioRef.current;
        const next = nextRef?.current;
        
        if (audio) {
          fadeAudio(audio, audio.volume, 0, FADE_DURATION / 2, () => {
            audio.pause();
            audioRef.current = null;
          });
        }
        if (next) {
          fadeAudio(next, next.volume, 0, FADE_DURATION / 2, () => {
            next.pause();
            nextRef.current = null;
          });
        }
      }, [fadeAudio]);
      
      // Update music volume (apply to both current and next if crossfading)
      useEffect(() => {
        const vol = musicVolume / 100;
        if (musicAudioRef.current && !fadeIntervalsRef.current.music) {
          musicAudioRef.current.volume = vol;
        }
        if (musicNextRef.current && !fadeIntervalsRef.current.musicNext) {
          musicNextRef.current.volume = vol;
        }
      }, [musicVolume]);
      
      // Update ambiance volume
      useEffect(() => {
        const vol = ambianceVolume / 100;
        if (ambianceAudioRef.current && !fadeIntervalsRef.current.ambiance) {
          ambianceAudioRef.current.volume = vol;
        }
        if (ambianceNextRef.current && !fadeIntervalsRef.current.ambianceNext) {
          ambianceNextRef.current.volume = vol;
        }
      }, [ambianceVolume]);
      
      // Main audio playback effect
      useEffect(() => {
        // Stop all audio if sound is disabled or mode is off
        if (!soundEnabled || ambientSound === 'off') {
          stopAudioWithFade(musicAudioRef, musicNextRef, 'music');
          stopAudioWithFade(ambianceAudioRef, ambianceNextRef, 'ambiance');
          return;
        }
        
        // Handle music
        if (ambientSound === 'music' || ambientSound === 'both') {
          const trackId = getActiveMusicTrack();
          const track = musicTracks[trackId];
          
          if (track) {
            // Create new audio if needed or if track changed
            if (!musicAudioRef.current || musicAudioRef.current.dataset.trackId !== trackId) {
              // Fade out old track if exists
              if (musicAudioRef.current) {
                stopAudioWithFade(musicAudioRef, musicNextRef, 'music');
              }
              // Start new track with fade in
              setTimeout(() => {
                const audio = startAudioWithFade(track.file, musicVolume / 100, 'music');
                audio.dataset.trackId = trackId;
                musicAudioRef.current = audio;
              }, musicAudioRef.current ? FADE_DURATION / 2 : 0);
            }
          }
        } else {
          // Stop music if mode doesn't include it
          if (musicAudioRef.current) {
            stopAudioWithFade(musicAudioRef, musicNextRef, 'music');
          }
        }
        
        // Handle ambiance
        if (ambientSound === 'ambiance' || ambientSound === 'both') {
          const trackId = getActiveAmbianceTrack();
          const track = ambianceTracks[trackId];
          
          if (track) {
            // Create new audio if needed or if track changed
            if (!ambianceAudioRef.current || ambianceAudioRef.current.dataset.trackId !== trackId) {
              // Fade out old track if exists
              if (ambianceAudioRef.current) {
                stopAudioWithFade(ambianceAudioRef, ambianceNextRef, 'ambiance');
              }
              // Start new track with fade in
              setTimeout(() => {
                const audio = startAudioWithFade(track.file, ambianceVolume / 100, 'ambiance');
                audio.dataset.trackId = trackId;
                ambianceAudioRef.current = audio;
              }, ambianceAudioRef.current ? FADE_DURATION / 2 : 0);
            }
          }
        } else {
          // Stop ambiance if mode doesn't include it
          if (ambianceAudioRef.current) {
            stopAudioWithFade(ambianceAudioRef, ambianceNextRef, 'ambiance');
          }
        }
        
        // Cleanup on unmount
        return () => {
          // Clear all intervals
          Object.values(fadeIntervalsRef.current).forEach(i => i && clearInterval(i));
          // Stop all audio immediately on unmount
          [musicAudioRef, musicNextRef, ambianceAudioRef, ambianceNextRef].forEach(ref => {
            if (ref.current) {
              ref.current.pause();
              ref.current = null;
            }
          });
        };
      }, [soundEnabled, ambientSound, getActiveMusicTrack, getActiveAmbianceTrack, startAudioWithFade, stopAudioWithFade]);

      // Handle visibility change (pause when leaving app)
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (document.hidden && !backgroundPlay) {
            setSoundEnabled(false);
          }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, [backgroundPlay]);

      // Toggle sound helper
      const toggleSound = useCallback(() => {
        if (ambientSound === 'off') {
          setAmbientSound('both');
          setSoundEnabled(true);
        } else if (soundEnabled) {
          setSoundEnabled(false);
        } else {
          setSoundEnabled(true);
        }
      }, [ambientSound, soundEnabled]);

      // Daily reset & challenges
      useEffect(() => {
        const lastDate = gameStats.lastActiveDate;
        if (lastDate !== todayKey) {
          setHabits(h => h.map(habit => ({ ...habit, completed: false })));
          
          // Reset recurring tasks
          const dayOfWeek = getDayOfWeek();
          const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
          setTasks(t => t.map(task => {
            if (!task.recurring || task.recurring === 'none') return task;
            if (task.recurring === 'daily') return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            if (task.recurring === 'weekdays' && isWeekday) return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            if (task.recurring === 'weekly' && dayOfWeek === 1) return { ...task, done: false, lastReset: todayKey, subtasks: (task.subtasks || []).map(st => ({ ...st, done: false })) };
            return task;
          }));
          
          const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
          const isConsecutive = lastDate === getDateKey(yesterday);
          if (!isConsecutive && lastDate && gameStats.freezesAvailable > 0) {
            setGameStats(s => ({ ...s, freezesUsed: s.freezesUsed + 1, freezesAvailable: s.freezesAvailable - 1 }));
            triggerCelebration(messages.freeze);
          }
          const weekNum = getWeekNumber();
          if (gameStats.weeklyFreeze !== weekNum) setGameStats(s => ({ ...s, freezesAvailable: 1, weeklyFreeze: weekNum }));
          setGameStats(s => ({ ...s, lastActiveDate: todayKey, appStreak: isConsecutive || (s.freezesUsed > 0) ? s.appStreak + 1 : 1, perfectDayToday: false }));
          
          // Weekly challenge reset
          if (challenges.weekly.week !== weekNum) {
            const newChallenge = weeklyChallengeDefs[Math.floor(Math.random() * weeklyChallengeDefs.length)];
            setChallenges(c => ({ ...c, weekly: { id: newChallenge.id, progress: 0, week: weekNum } }));
          }
          // Monthly challenge reset
          const monthKey = getMonthKey();
          if (challenges.monthly.month !== monthKey) {
            const newChallenge = monthlyChallengeDefs[Math.floor(Math.random() * monthlyChallengeDefs.length)];
            setChallenges(c => ({ ...c, monthly: { id: newChallenge.id, progress: 0, month: monthKey } }));
          }
        }
      }, []);

      // Timer
      useEffect(() => {
        if (timerRunning && timerSeconds > 0) {
          timerRef.current = setTimeout(() => setTimerSeconds(s => s - 1), 1000);
        } else if (timerRunning && timerSeconds === 0) {
          setTimerRunning(false);
          setSoundEnabled(false); // Stop sound when timer completes
          const elapsed = timerStartTime ? Math.round((Date.now() - timerStartTime) / 60000) : 25;
          setGameStats(s => ({ ...s, totalFocusMinutes: s.totalFocusMinutes + elapsed }));
          updateChallengeProgress('focus', elapsed);
          addXP(elapsed);
          triggerCelebration(messages.timerDone);
          if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
          
          // Send notification via service worker (works better on mobile/background)
          if ('Notification' in window && Notification.permission === 'granted') {
            (async () => {
              try {
                if ('serviceWorker' in navigator) {
                  const reg = await navigator.serviceWorker.ready;
                  await reg.showNotification('My Daily Brew â˜•', {
                    body: `${messages.timerDone} ${elapsed} minutes of focus earned you ${elapsed} XP!`,
                    icon: '/icons/icon-192.png',
                    tag: 'timer-complete',
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                  });
                } else {
                  new Notification('My Daily Brew', {
                    body: `${messages.timerDone} ${elapsed} minutes of focus earned you ${elapsed} XP!`,
                    icon: '/icons/icon-192.png',
                    tag: 'timer-complete'
                  });
                }
              } catch (e) { console.log('Timer notification failed:', e); }
            })();
          }
        }
        return () => clearTimeout(timerRef.current);
      }, [timerRunning, timerSeconds]);

      // Badge checking
      useEffect(() => {
        const newBadges = badges.filter(b => !gameStats.unlockedBadges.includes(b.id) && b.check(gameStats));
        if (newBadges.length > 0) {
          const updated = [...gameStats.unlockedBadges, ...newBadges.map(b => b.id)];
          setGameStats(s => ({ ...s, unlockedBadges: updated }));
          newBadges.forEach((b, i) => setTimeout(() => { triggerCelebration(`ğŸ† ${b.name}!`); addXP(50); }, i * 1500));
        }
      }, [gameStats, badges]);

      // Task reminder notifications - improved system
      const [notifiedTasks, setNotifiedTasks] = useState(() => {
        const saved = load('notifiedTasks', { date: null, ids: [] });
        // Reset if it's a new day
        if (saved.date !== getDateKey()) return { date: getDateKey(), ids: [] };
        return saved;
      });
      
      useEffect(() => { store('notifiedTasks', notifiedTasks); }, [notifiedTasks]);
      
      // Helper function to send notifications (uses service worker when available)
      const sendNotification = async (title, options) => {
        try {
          if ('serviceWorker' in navigator) {
            const reg = await navigator.serviceWorker.ready;
            await reg.showNotification(title, options);
            return true;
          } else {
            new Notification(title, options);
            return true;
          }
        } catch (e) {
          console.log('Notification failed:', e);
          return false;
        }
      };
      
      useEffect(() => {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        
        const checkTaskReminders = async () => {
          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          
          // Find tasks that are due now or slightly overdue (within 5 min window)
          const dueTasks = tasks.filter(t => {
            if (!t.time || t.done) return false;
            // Already notified today?
            if (notifiedTasks.ids.includes(t.id)) return false;
            
            const [hours, mins] = t.time.split(':').map(Number);
            const taskMinutes = hours * 60 + mins;
            
            // Notify if task is due now or up to 5 minutes ago (in case we missed it)
            return currentMinutes >= taskMinutes && currentMinutes <= taskMinutes + 5;
          });
          
          dueTasks.forEach(async (task) => {
            const sent = await sendNotification('Task Reminder â˜•', {
              body: `Time to: ${task.text}`,
              icon: '/icons/icon-192.png',
              tag: `task-${task.id}-${getDateKey()}`,
              requireInteraction: true,
              vibrate: [200, 100, 200]
            });
            
            if (sent) {
              // Mark as notified
              setNotifiedTasks(prev => ({
                ...prev,
                ids: [...prev.ids, task.id]
              }));
              
              // Also vibrate if supported
              if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
            }
          });
          
          // Also check for upcoming tasks (5 min warning)
          const upcomingTasks = tasks.filter(t => {
            if (!t.time || t.done) return false;
            const warningId = `upcoming-${t.id}`;
            if (notifiedTasks.ids.includes(warningId)) return false;
            
            const [hours, mins] = t.time.split(':').map(Number);
            const taskMinutes = hours * 60 + mins;
            
            // 5 minute warning
            return currentMinutes >= taskMinutes - 5 && currentMinutes < taskMinutes;
          });
          
          upcomingTasks.forEach(async (task) => {
            const sent = await sendNotification('Upcoming Task â°', {
              body: `In 5 minutes: ${task.text}`,
              icon: '/icons/icon-192.png',
              tag: `upcoming-${task.id}-${getDateKey()}`,
              silent: true // Don't vibrate for upcoming, just notify
            });
            
            if (sent) {
              setNotifiedTasks(prev => ({
                ...prev,
                ids: [...prev.ids, `upcoming-${task.id}`]
              }));
            }
          });
        };
        
        // Check every 30 seconds for better accuracy
        checkTaskReminders();
        const interval = setInterval(checkTaskReminders, 30000);
        return () => clearInterval(interval);
      }, [tasks, notifiedTasks]);

      // Request notification permission on first load
      useEffect(() => {
        if ('Notification' in window && Notification.permission === 'default') {
          // Don't auto-prompt, let user initiate from settings
        }
      }, []);

      // XP and levels
      const currentLevel = useMemo(() => { for (let i = levels.length - 1; i >= 0; i--) { if (gameStats.xp >= levels[i].xp) return levels[i]; } return levels[0]; }, [gameStats.xp, levels]);
      const nextLevel = useMemo(() => { const idx = levels.findIndex(l => l.level === currentLevel.level); return levels[idx + 1] || null; }, [currentLevel, levels]);
      const xpProgress = useMemo(() => { if (!nextLevel) return 100; const min = currentLevel.xp; const need = nextLevel.xp - min; const have = gameStats.xp - min; return Math.round((have / need) * 100); }, [gameStats.xp, currentLevel, nextLevel]);
      const addXP = (amount) => setGameStats(s => ({ ...s, xp: s.xp + amount }));
      const triggerCelebration = (msg) => { setCelebration(msg); if ('vibrate' in navigator) navigator.vibrate(100); setTimeout(() => setCelebration(null), 2500); };

      // Challenge progress
      const updateChallengeProgress = (type, amount = 1) => {
        setChallenges(c => {
          const updated = { ...c };
          // Weekly
          const wDef = weeklyChallengeDefs.find(d => d.id === c.weekly.id);
          if (wDef && wDef.type === type) {
            updated.weekly = { ...c.weekly, progress: c.weekly.progress + amount };
            if (updated.weekly.progress >= wDef.target && c.weekly.progress < wDef.target) {
              setTimeout(() => { addXP(wDef.xp); triggerCelebration(`ğŸ… Challenge Complete: ${wDef.name}!`); setGameStats(s => ({ ...s, challengesCompleted: s.challengesCompleted + 1 })); }, 500);
            }
          }
          // Monthly
          const mDef = monthlyChallengeDefs.find(d => d.id === c.monthly.id);
          if (mDef && mDef.type === type) {
            updated.monthly = { ...c.monthly, progress: c.monthly.progress + amount };
            if (updated.monthly.progress >= mDef.target && c.monthly.progress < mDef.target) {
              setTimeout(() => { addXP(mDef.xp); triggerCelebration(`ğŸ… Monthly Challenge: ${mDef.name}!`); setGameStats(s => ({ ...s, challengesCompleted: s.challengesCompleted + 1 })); }, 500);
            }
          }
          return updated;
        });
      };

      // Daily tip
      const dailyTip = useMemo(() => getDailyTip(gameStats, brewType), [gameStats, brewType]);
      const dismissDailyTip = () => { setShowDailyTip(false); store('lastTipDate', todayKey); };

      // Habit actions
      const toggleHabit = (id) => {
        const habit = habits.find(h => h.id === id);
        const nowComplete = !habit.completed;
        const newHistory = { ...(habit.history || habitHistory[id] || {}), [todayKey]: nowComplete };
        setHabitHistory(h => ({ ...h, [id]: newHistory }));
        
        // Check if XP was already awarded for this habit today
        const alreadyAwarded = dailyXPAwarded.habits.includes(id);
        
        setHabits(habits.map(h => {
          if (h.id !== id) return h;
          if (nowComplete && !alreadyAwarded) { 
            addXP(10); 
            updateChallengeProgress('habits'); 
            setDailyXPAwarded(prev => ({ ...prev, habits: [...prev.habits, id] }));
            const newStreak = h.streak + 1; 
            setGameStats(s => ({ ...s, totalHabitsCompleted: s.totalHabitsCompleted + 1, maxStreak: Math.max(s.maxStreak, newStreak) })); 
            if (newStreak % 7 === 0) triggerCelebration(`ğŸ”¥ ${newStreak} day streak!`); 
          }
          return { ...h, completed: nowComplete, streak: nowComplete ? h.streak + 1 : Math.max(0, h.streak - 1), history: newHistory };
        }));
        checkPerfectDay();
      };

      const addHabit = () => { if (!newHabit.name.trim()) return; setHabits([...habits, { id: Date.now(), name: newHabit.name, icon: newHabit.icon, completed: false, streak: 0, history: {} }]); setNewHabit({ name: '', icon: 'ğŸ’§' }); setShowAddHabit(false); setShowQuickAdd(false); };
      const confirmDeleteHabit = (id) => { const habit = habits.find(h => h.id === id); setConfirmDelete({ type: 'habit', id, name: habit.name, icon: habit.icon }); };
      const deleteHabit = (id) => { const habit = habits.find(h => h.id === id); setHabits(habits.filter(h => h.id !== id)); setUndoAction({ type: 'habit', action: () => setHabits(h => [...h, habit]) }); setTimeout(() => setUndoAction(null), 4000); setConfirmDelete(null); };
      const reorderHabit = (id, dir) => { const idx = habits.findIndex(h => h.id === id); if ((dir === -1 && idx === 0) || (dir === 1 && idx === habits.length - 1)) return; const n = [...habits]; [n[idx], n[idx + dir]] = [n[idx + dir], n[idx]]; setHabits(n); };

      // Task actions
      const toggleTask = (id) => {
        // Check if XP was already awarded for this task today
        const alreadyAwarded = dailyXPAwarded.tasks.includes(id);
        
        setTasks(tasks.map(t => {
          if (t.id !== id) return t;
          const nowDone = !t.done;
          if (nowDone && !alreadyAwarded) { 
            addXP(15); 
            updateChallengeProgress('tasks'); 
            setDailyXPAwarded(prev => ({ ...prev, tasks: [...prev.tasks, id] }));
            const hour = new Date().getHours(); 
            setGameStats(s => ({ ...s, totalTasksCompleted: s.totalTasksCompleted + 1, earlyTasks: hour < 8 ? s.earlyTasks + 1 : s.earlyTasks, lateTasks: hour >= 22 ? s.lateTasks + 1 : s.lateTasks })); 
          }
          return { ...t, done: nowDone };
        }));
        checkPerfectDay();
      };

      const toggleSubtask = (taskId, subIdx) => { setTasks(tasks.map(t => { if (t.id !== taskId) return t; const subs = [...(t.subtasks || [])]; subs[subIdx] = { ...subs[subIdx], done: !subs[subIdx].done }; const allDone = subs.every(s => s.done); return { ...t, subtasks: subs, done: allDone ? true : t.done }; })); };
      const addSubtaskToTask = (taskId, text) => { if (!text.trim()) return; setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), { text, done: false }] } : t)); setNewSubtask(''); setShowSubtaskInput(null); };
      const addTask = () => { if (!newTask.text.trim()) return; setTasks([...tasks, { ...newTask, id: Date.now(), done: false, lastReset: todayKey }]); setNewTask({ text: '', time: '', priority: 'medium', category: null, recurring: 'none', subtasks: [] }); setShowAddTask(false); setShowQuickAdd(false); };
      const confirmDeleteTask = (id) => { const task = tasks.find(t => t.id === id); setConfirmDelete({ type: 'task', id, name: task.text }); };
      const deleteTask = (id) => { const task = tasks.find(t => t.id === id); setTasks(tasks.filter(t => t.id !== id)); setUndoAction({ type: 'task', action: () => setTasks(ts => [...ts, task]) }); setTimeout(() => setUndoAction(null), 4000); setConfirmDelete(null); };

      const checkPerfectDay = () => { setTimeout(() => { const allH = habits.length > 0 && habits.every(h => h.completed); const activeTasks = tasks.filter(t => !t.recurring || t.recurring === 'none' || (t.recurring === 'daily') || (t.recurring === 'weekdays' && getDayOfWeek() >= 1 && getDayOfWeek() <= 5) || (t.recurring === 'weekly' && getDayOfWeek() === 1)); const allT = activeTasks.length === 0 || activeTasks.every(t => t.done); if (allH && allT && !gameStats.perfectDayToday) { setGameStats(s => ({ ...s, perfectDays: s.perfectDays + 1, perfectDayToday: true })); updateChallengeProgress('perfect'); triggerCelebration('âœ¨ Perfect day!'); addXP(50); } }, 100); };

      const setMood = (value) => { const isNew = !moods[todayKey]; setMoods({ ...moods, [todayKey]: { value, time: Date.now() } }); setGameStats(s => ({ ...s, lastMoodValue: value, moodDaysTracked: isNew ? s.moodDaysTracked + 1 : s.moodDaysTracked })); if (isNew) { addXP(5); updateChallengeProgress('moods'); } };
      const saveJournal = () => { const isNew = !journal[todayKey]; setJournal({ ...journal, [todayKey]: todayJournal }); if (isNew && (todayJournal.gratitude || todayJournal.reflection || todayJournal.tomorrow)) { setGameStats(s => ({ ...s, journalEntries: s.journalEntries + 1 })); updateChallengeProgress('journal'); addXP(10); } };

      // Share
      const shareAchievement = async (text) => {
        const shareData = { title: 'My Daily Brew', text: text, url: 'https://mydailybrew.app' };
        try {
          if (navigator.share) { await navigator.share(shareData); setGameStats(s => ({ ...s, timesShared: s.timesShared + 1 })); triggerCelebration('ğŸ“¤ Shared!'); }
          else { await navigator.clipboard.writeText(text); triggerCelebration('ğŸ“‹ Copied to clipboard!'); setGameStats(s => ({ ...s, timesShared: s.timesShared + 1 })); }
        } catch(e) { console.log('Share failed'); }
      };

      // Export
      const exportData = () => {
        const data = { habits, tasks, moods, journal, gameStats, cafeName, brewType, exportDate: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `daily-brew-backup-${todayKey}.json`; a.click();
        URL.revokeObjectURL(url);
        setGameStats(s => ({ ...s, timesExported: s.timesExported + 1 }));
        triggerCelebration('ğŸ’¾ Data exported!');
        setShowExport(false);
      };

      const dismissWhatsNew = () => { setShowWhatsNew(false); store('lastSeenVersion', APP_VERSION); if (!load('tutorialSeen', false)) setShowTutorial(true); };
      const dismissTutorial = () => { setShowTutorial(false); store('tutorialSeen', true); };

      // Stats
      const completedHabits = habits.filter(h => h.completed).length;
      const dayOfWeek = getDayOfWeek();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      const isMonday = dayOfWeek === 1;
      const todayTasks = tasks.filter(t => {
        if (!t.recurring || t.recurring === 'none') return true;
        if (t.recurring === 'daily') return true;
        if (t.recurring === 'weekdays' && isWeekday) return true;
        if (t.recurring === 'weekly' && isMonday) return true;
        return false;
      });
      const completedTasks = todayTasks.filter(t => t.done).length;
      const progress = Math.round(((completedHabits + completedTasks) / Math.max(1, habits.length + todayTasks.length)) * 100);

      // Calendar
      const calMonth = calendarDate.getMonth();
      const calYear = calendarDate.getFullYear();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const calDays = useMemo(() => { const d = []; for (let i = 0; i < firstDay; i++) d.push(null); for (let i = 1; i <= daysInMonth; i++) d.push(new Date(calYear, calMonth, i)); return d; }, [calYear, calMonth, firstDay, daysInMonth]);

      // Heatmap
      const heatmapData = useMemo(() => {
        const weeks = [];
        for (let w = 11; w >= 0; w--) {
          const week = [];
          for (let d = 0; d < 7; d++) {
            const date = new Date(); date.setDate(date.getDate() - (w * 7 + (6 - d)));
            const key = getDateKey(date);
            const completedCount = habits.filter(h => (h.history || habitHistory[h.id] || {})[key]).length;
            week.push({ date: key, count: completedCount, total: habits.length });
          }
          weeks.push(week);
        }
        return weeks;
      }, [habits, habitHistory]);

      // Year review
      // Mood Insights - correlate mood with habits
      const moodInsights = useMemo(() => {
        const moodDays = Object.entries(moods);
        if (moodDays.length < 3) return null;
        
        // Calculate average mood on high vs low habit completion days
        let highCompletionMoods = [];
        let lowCompletionMoods = [];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const moodByDay = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
        
        moodDays.forEach(([dateKey, moodData]) => {
          const date = new Date(dateKey);
          const dow = date.getDay();
          moodByDay[dow].push(moodData.value);
          
          // Check habit completion for that day
          const completedCount = habits.filter(h => (h.history || habitHistory[h.id] || {})[dateKey]).length;
          const completionRate = habits.length > 0 ? completedCount / habits.length : 0;
          
          if (completionRate >= 0.7) highCompletionMoods.push(moodData.value);
          else if (completionRate <= 0.3) lowCompletionMoods.push(moodData.value);
        });
        
        const avgHighCompletion = highCompletionMoods.length > 0 ? (highCompletionMoods.reduce((a, b) => a + b, 0) / highCompletionMoods.length).toFixed(1) : null;
        const avgLowCompletion = lowCompletionMoods.length > 0 ? (lowCompletionMoods.reduce((a, b) => a + b, 0) / lowCompletionMoods.length).toFixed(1) : null;
        
        // Find best/worst mood days
        const avgByDay = dayNames.map((name, i) => ({
          name,
          avg: moodByDay[i].length > 0 ? moodByDay[i].reduce((a, b) => a + b, 0) / moodByDay[i].length : null,
          count: moodByDay[i].length
        })).filter(d => d.count >= 2);
        
        const bestDay = avgByDay.length > 0 ? avgByDay.reduce((best, d) => d.avg > (best?.avg || 0) ? d : best, null) : null;
        const moodDiff = avgHighCompletion && avgLowCompletion ? (avgHighCompletion - avgLowCompletion).toFixed(1) : null;
        
        return { avgHighCompletion, avgLowCompletion, moodDiff, bestDay, hasEnoughData: moodDays.length >= 7 };
      }, [moods, habits, habitHistory]);

      const yearReview = useMemo(() => {
        const yearMoods = Object.entries(moods).filter(([k]) => k.startsWith(`${currentYear}`));
        const avgMood = yearMoods.length ? (yearMoods.reduce((s, [, v]) => s + v.value, 0) / yearMoods.length).toFixed(1) : null;
        const moodCounts = yearMoods.reduce((a, [, v]) => { a[v.value] = (a[v.value] || 0) + 1; return a; }, {});
        const totalJournal = Object.keys(journal).filter(k => k.startsWith(`${currentYear}`)).length;
        return { avgMood, moodCounts, totalJournal, daysTracked: yearMoods.length, totalHabits: gameStats.totalHabitsCompleted, totalTasks: gameStats.totalTasksCompleted, totalFocus: gameStats.totalFocusMinutes, longestStreak: gameStats.maxStreak, badgesEarned: gameStats.unlockedBadges.length };
      }, [moods, journal, gameStats, currentYear]);

      // Challenge display
      const weeklyChallenge = weeklyChallengeDefs.find(c => c.id === challenges.weekly.id);
      const monthlyChallenge = monthlyChallengeDefs.find(c => c.id === challenges.monthly.id);

      // Styles
      const s = {
        card: { background: theme.cardBg, border: `1px solid ${theme.cardBorder}`, borderRadius: '16px', padding: '14px', marginBottom: '10px' },
        btn: { background: theme.accentGradient, color: theme.isDark ? '#1a1a1a' : '#fff', border: 'none', borderRadius: '12px', padding: '12px 20px', fontFamily: "'Lora',serif", fontWeight: 600, cursor: 'pointer' },
        btnSecondary: { background: theme.progressBg, color: theme.text, border: `1px solid ${theme.cardBorder}`, borderRadius: '12px', padding: '10px 16px', fontFamily: "'Lora',serif", fontWeight: 500, cursor: 'pointer' },
        input: { background: theme.inputBg, border: `1px solid ${theme.inputBorder}`, borderRadius: '12px', padding: '12px', fontFamily: "'Lora',serif", fontSize: '1rem', color: theme.text, width: '100%', outline: 'none' },
        navItem: (a) => ({ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', padding: '8px 12px', borderRadius: '12px', background: a ? theme.accentGradient : 'transparent', color: a ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.textSecondary, border: 'none', cursor: 'pointer', fontFamily: "'Lora',serif", fontSize: '9px', fontWeight: a ? 600 : 400 }),
        fab: { position: 'fixed', bottom: '90px', right: '20px', width: '56px', height: '56px', borderRadius: '50%', background: theme.accentGradient, border: 'none', fontSize: '24px', cursor: 'pointer', boxShadow: '0 4px 20px rgba(0,0,0,0.3)', zIndex: 99, display: 'flex', alignItems: 'center', justifyContent: 'center', color: theme.isDark ? '#1a1a1a' : '#fff' },
        modal: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(8px)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' },
        modalContent: { background: theme.modalBg, borderRadius: '20px', maxWidth: '360px', width: '100%', padding: '20px', maxHeight: '85vh', overflow: 'auto' }
      };

      return (
        <div style={{ minHeight: '100vh', background: theme.bg, transition: 'background 0.4s', filter: highContrast ? 'contrast(1.2)' : 'none' }}>
          <style>{`
            .hw { font-family: 'Caveat', cursive; }
            .bt { font-family: 'Lora', serif; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
            @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
            .fade { animation: fadeIn 0.3s; }
            .slide { animation: slideUp 0.4s; }
            .pop { animation: pop 0.3s; }
            .pulse { animation: pulse 2s infinite; }
            .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
          `}</style>

          <div style={{ maxWidth: '28rem', margin: '0 auto', padding: '16px 14px 100px' }}>
            {/* Header with seasonal decoration */}
            <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '14px' }}>
              <div>
                <h1 className="hw" style={{ fontSize: '1.6rem', color: theme.text, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }} aria-label={`${cafeName} - ${brewThemes[brewType].name} theme`}>
                  {brewThemes[brewType].icon} {cafeName} <span style={{ fontSize: '0.9rem' }}>{seasonDeco.emoji}</span>
                </h1>
                <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginTop: '2px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                  {today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
                  {weather.temp && (
                    <span style={{ display: 'inline-flex', alignItems: 'center', gap: '2px', padding: '1px 6px', background: theme.progressBg, borderRadius: '8px', fontSize: '0.7rem' }}>
                      {weather.icon} {weather.temp}Â°
                    </span>
                  )}
                </p>
              </div>
              <div style={{ display: 'flex', gap: '6px' }}>
                <button onClick={() => setShowSoundMenu(true)} aria-label="Sound settings" style={{ background: soundEnabled ? theme.accentGradient : theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer', position: 'relative' }}>
                  <span>{soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}</span>
                  {soundEnabled && <span style={{ position: 'absolute', top: '-2px', right: '-2px', width: '8px', height: '8px', background: '#4ade80', borderRadius: '50%', border: '2px solid ' + theme.bg }} />}
                </button>
                <button onClick={() => setShowThemePicker(true)} aria-label="Change theme" style={{ background: theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>
                  <span>{brewThemes[brewType].icon}</span>
                  <span style={{ fontSize: '0.75rem' }}>{isDark ? 'ğŸŒ™' : 'â˜€ï¸'}</span>
                </button>
                <button onClick={() => setShowSettings(true)} aria-label="Settings" style={{ background: theme.accentLight, border: `1px solid ${theme.cardBorder}`, borderRadius: '10px', padding: '6px 10px', cursor: 'pointer' }}>âš™ï¸</button>
              </div>
            </header>

            {/* XP Bar */}
            <div style={{ ...s.card, padding: '10px 14px', display: 'flex', alignItems: 'center', gap: '10px' }} onClick={() => setShowBadges(true)} role="button" aria-label={`Level ${currentLevel.level}: ${currentLevel.title}. ${gameStats.xp} XP. Tap to view badges.`}>
              <div style={{ fontSize: '1.3rem' }}>{currentLevel.icon}</div>
              <div style={{ flex: 1 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '3px' }}>
                  <span className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.text }}>{currentLevel.title}</span>
                  <span className="bt" style={{ fontSize: '0.65rem', color: theme.textMuted }}>{gameStats.xp} XP</span>
                </div>
                <div style={{ height: '5px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }} role="progressbar" aria-valuenow={xpProgress} aria-valuemin="0" aria-valuemax="100">
                  <div style={{ height: '100%', width: `${xpProgress}%`, background: theme.xpBar, borderRadius: '999px', transition: 'width 0.5s' }} />
                </div>
              </div>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: '0.7rem', color: theme.textMuted }}>ğŸ† {gameStats.unlockedBadges.length}/{badges.length}</div>
                {gameStats.freezesAvailable > 0 && <div style={{ fontSize: '0.6rem', color: theme.accent }}>â„ï¸ {gameStats.freezesAvailable}</div>}
              </div>
            </div>

            {/* Daily Tip Card */}
            {showDailyTip && (
              <div style={{ ...s.card, background: theme.accentLight, borderColor: theme.accent }} className="slide">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                  <div style={{ flex: 1 }}>
                    <p className="bt" style={{ fontSize: '0.7rem', color: theme.accent, fontWeight: 600, marginBottom: '4px' }}>ğŸ¤– Today's Barista Tip</p>
                    <p className="bt" style={{ fontSize: '0.85rem', color: theme.text, lineHeight: 1.4 }}>{dailyTip}</p>
                  </div>
                  <button onClick={dismissDailyTip} style={{ background: 'none', border: 'none', color: theme.textMuted, cursor: 'pointer', padding: '4px' }}>Ã—</button>
                </div>
              </div>
            )}

            {/* Notification Prompt Banner */}
            {showNotificationPrompt && 'Notification' in window && Notification.permission === 'default' && (
              <div style={{ ...s.card, background: `linear-gradient(135deg, ${theme.accent}15, ${theme.accent}25)`, borderColor: theme.accent, display: 'flex', alignItems: 'center', gap: '12px' }} className="slide">
                <span style={{ fontSize: '1.5rem' }}>ğŸ””</span>
                <div style={{ flex: 1 }}>
                  <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text, marginBottom: '2px' }}>Enable Notifications?</p>
                  <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>Get reminded when timers complete & tasks are due</p>
                </div>
                <div style={{ display: 'flex', gap: '6px' }}>
                  <button 
                    onClick={async () => {
                      const permission = await Notification.requestPermission();
                      if (permission === 'granted') {
                        new Notification('My Daily Brew â˜•', { 
                          body: 'You\'ll now get timer and task reminders!', 
                          icon: '/icons/icon-192.png',
                          tag: 'welcome'
                        });
                        triggerCelebration('ğŸ”” Notifications enabled!');
                      }
                      setShowNotificationPrompt(false);
                      store('notificationPromptDismissed', true);
                    }}
                    style={{ ...s.btn, padding: '6px 12px', fontSize: '0.75rem' }}
                  >
                    Enable
                  </button>
                  <button 
                    onClick={() => { setShowNotificationPrompt(false); store('notificationPromptDismissed', true); }}
                    style={{ background: 'none', border: 'none', color: theme.textMuted, cursor: 'pointer', fontSize: '1.2rem', padding: '4px' }}
                  >
                    Ã—
                  </button>
                </div>
              </div>
            )}

            {/* TODAY TAB */}
            {activeTab === 'today' && (
              <div className="fade">
                {/* Progress */}
                <div style={s.card}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                    <div>
                      <p className="bt" style={{ fontSize: '0.65rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: theme.textSecondary }}>Today's Progress</p>
                      <p style={{ fontSize: '1.75rem', fontWeight: 600, color: theme.text }}>{progress}%</p>
                    </div>
                    <div className="bt" style={{ textAlign: 'right', fontSize: '0.75rem', color: theme.textSecondary }}>
                      <p><span style={{ color: theme.text, fontWeight: 600 }}>{completedHabits}</span>/{habits.length} habits</p>
                      <p><span style={{ color: theme.text, fontWeight: 600 }}>{completedTasks}</span>/{todayTasks.length} tasks</p>
                    </div>
                  </div>
                  <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                    <div style={{ height: '100%', width: `${progress}%`, background: theme.accentGradient, borderRadius: '999px', transition: 'width 0.5s' }} />
                  </div>
                </div>

                {/* Mood */}
                <div style={s.card}>
                  <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '8px' }}>How are you feeling?</p>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: '5px' }} role="radiogroup" aria-label="Mood selection">
                    {moodEmojis.map(m => (
                      <button key={m.value} onClick={() => setMood(m.value)} className={moods[todayKey]?.value === m.value ? 'pop' : ''} aria-pressed={moods[todayKey]?.value === m.value} style={{ flex: 1, padding: '8px 4px', borderRadius: '12px', border: moods[todayKey]?.value === m.value ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, background: moods[todayKey]?.value === m.value ? theme.accentLight : 'transparent', cursor: 'pointer' }}>
                        <div style={{ fontSize: '1.2rem' }}>{m.emoji}</div>
                        <div className="bt" style={{ fontSize: '0.5rem', color: theme.textMuted, marginTop: '2px' }}>{m.label}</div>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Active Challenges Preview */}
                {(weeklyChallenge || monthlyChallenge) && (
                  <div style={{ ...s.card, cursor: 'pointer' }} onClick={() => setShowChallenges(true)}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                      <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text }}>ğŸ† Active Challenges</p>
                      <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>View all â†’</span>
                    </div>
                    {weeklyChallenge && (
                      <div style={{ marginBottom: '6px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                          <span className="bt" style={{ color: theme.textSecondary }}>{weeklyChallenge.icon} {weeklyChallenge.name}</span>
                          <span className="bt" style={{ color: theme.accent }}>{challenges.weekly.progress}/{weeklyChallenge.target}</span>
                        </div>
                        <div style={{ height: '4px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                          <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Habits */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '14px 0 8px' }}>
                  <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>â­ Habits</h2>
                  <button onClick={() => setShowAddHabit(true)} style={{ ...s.btn, padding: '5px 12px', fontSize: '1rem' }} aria-label="Add habit">+</button>
                </div>

                {habits.length === 0 && <p className="bt" style={{ textAlign: 'center', color: theme.textMuted, padding: '16px' }}>{messages.emptyHabits}</p>}

                {habits.map(h => (
                  <SwipeableCard key={h.id} onSwipeRight={() => toggleHabit(h.id)} style={{ ...s.card, display: 'flex', alignItems: 'center', gap: '10px', borderColor: h.completed ? theme.success : theme.cardBorder }}>
                    <button onClick={() => toggleHabit(h.id)} className={h.completed ? 'pop' : ''} aria-pressed={h.completed} style={{ width: '40px', height: '40px', borderRadius: '12px', border: h.completed ? 'none' : `2px solid ${theme.inputBorder}`, background: h.completed ? theme.accentGradient : theme.progressBg, fontSize: '1rem', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: h.completed ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text, flexShrink: 0 }}>
                      {h.completed ? 'âœ“' : h.icon}
                    </button>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p className="bt" style={{ fontSize: '0.9rem', fontWeight: 500, color: h.completed ? theme.textMuted : theme.text, textDecoration: h.completed ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{h.name}</p>
                      <span className="bt" style={{ fontSize: '0.6rem', padding: '2px 6px', borderRadius: '999px', background: theme.streakGradient, color: theme.isDark ? '#1a1a1a' : '#fff' }}>ğŸ”¥ {h.streak}d</span>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                      <button onClick={() => reorderHabit(h.id, -1)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }} aria-label="Move up">â–²</button>
                      <button onClick={() => reorderHabit(h.id, 1)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }} aria-label="Move down">â–¼</button>
                    </div>
                    <button onClick={() => confirmDeleteHabit(h.id)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.9rem', cursor: 'pointer', padding: '6px' }} aria-label="Delete habit">ğŸ—‘</button>
                  </SwipeableCard>
                ))}

                {/* Tasks */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '14px 0 8px' }}>
                  <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>âœ“ Tasks</h2>
                  <button onClick={() => setShowAddTask(true)} style={{ ...s.btn, padding: '5px 12px', fontSize: '1rem' }} aria-label="Add task">+</button>
                </div>

                {todayTasks.length === 0 && <p className="bt" style={{ textAlign: 'center', color: theme.textMuted, padding: '16px' }}>{messages.emptyTasks}</p>}

                {todayTasks.sort((a, b) => ({ high: 0, medium: 1, low: 2 })[a.priority] - ({ high: 0, medium: 1, low: 2 })[b.priority]).map(task => {
                  const cat = categories.find(c => c.id === task.category);
                  const subtasksDone = (task.subtasks || []).filter(st => st.done).length;
                  const subtasksTotal = (task.subtasks || []).length;
                  return (
                    <SwipeableCard key={task.id} onSwipeRight={() => toggleTask(task.id)} style={{ ...s.card, opacity: task.done ? 0.7 : 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <button onClick={() => toggleTask(task.id)} className={task.done ? 'pop' : ''} style={{ width: '36px', height: '36px', borderRadius: '12px', border: task.done ? 'none' : `2px solid ${theme.inputBorder}`, background: task.done ? theme.accentGradient : theme.progressBg, fontSize: '0.9rem', cursor: 'pointer', flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', color: task.done ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text }}>
                          {task.done && 'âœ“'}
                        </button>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 500, color: task.done ? theme.textMuted : theme.text, textDecoration: task.done ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{task.text}</p>
                          <div style={{ display: 'flex', gap: '4px', alignItems: 'center', marginTop: '3px', flexWrap: 'wrap' }}>
                            {task.time && <span className="bt" style={{ fontSize: '0.6rem', color: theme.textSecondary }}>ğŸ• {formatTime(task.time)}</span>}
                            {cat && <span style={{ fontSize: '0.55rem', padding: '1px 5px', borderRadius: '4px', background: `${cat.color}22`, color: cat.color }}>{cat.icon}</span>}
                            {task.recurring && task.recurring !== 'none' && <span className="bt" style={{ fontSize: '0.55rem', color: theme.accent }}>ğŸ”„ {task.recurring === 'daily' ? 'Daily' : task.recurring === 'weekdays' ? 'Weekdays' : 'Weekly'}</span>}
                            {subtasksTotal > 0 && <span className="bt" style={{ fontSize: '0.55rem', color: theme.textMuted }}>ğŸ“‹ {subtasksDone}/{subtasksTotal}</span>}
                          </div>
                        </div>
                        <button onClick={() => confirmDeleteTask(task.id)} style={{ background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.9rem', cursor: 'pointer', padding: '6px' }}>ğŸ—‘</button>
                      </div>
                      {subtasksTotal > 0 && (
                        <div style={{ marginTop: '8px', paddingLeft: '46px' }}>
                          {task.subtasks.map((st, i) => (
                            <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                              <button onClick={() => toggleSubtask(task.id, i)} style={{ width: '18px', height: '18px', borderRadius: '5px', border: st.done ? 'none' : `1px solid ${theme.inputBorder}`, background: st.done ? theme.accent : 'transparent', fontSize: '0.6rem', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff' }}>{st.done && 'âœ“'}</button>
                              <span className="bt" style={{ fontSize: '0.75rem', color: st.done ? theme.textMuted : theme.textSecondary, textDecoration: st.done ? 'line-through' : 'none' }}>{st.text}</span>
                            </div>
                          ))}
                        </div>
                      )}
                      {showSubtaskInput === task.id ? (
                        <div style={{ marginTop: '8px', paddingLeft: '46px', display: 'flex', gap: '6px' }}>
                          <input value={newSubtask} onChange={e => setNewSubtask(e.target.value)} placeholder="Add subtask..." style={{ ...s.input, padding: '8px', fontSize: '0.8rem', flex: 1 }} onKeyPress={e => e.key === 'Enter' && addSubtaskToTask(task.id, newSubtask)} autoFocus />
                          <button onClick={() => addSubtaskToTask(task.id, newSubtask)} style={{ ...s.btn, padding: '8px 12px', fontSize: '0.8rem' }}>+</button>
                        </div>
                      ) : (
                        <button onClick={() => setShowSubtaskInput(task.id)} className="bt" style={{ marginTop: '6px', marginLeft: '46px', background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.7rem', cursor: 'pointer' }}>+ Add subtask</button>
                      )}
                    </SwipeableCard>
                  );
                })}

                {/* Motivational */}
                <div style={{ ...s.card, textAlign: 'center', marginTop: '12px' }}>
                  <span style={{ fontSize: '1.1rem' }}>{brewThemes[brewType].icon}</span>
                  <p className="hw" style={{ fontSize: '1rem', color: theme.textSecondary, marginTop: '4px' }}>
                    {progress === 100 ? messages.perfect : progress > 60 ? messages.good : messages.start}
                  </p>
                </div>
              </div>
            )}

            {/* TIMER TAB */}
            {activeTab === 'timer' && (
              <div className="fade">
                <div style={{ ...s.card, textAlign: 'center', padding: '24px 16px' }}>
                  <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '4px' }}>â±ï¸ Focus Time</h2>
                  <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '16px' }}>{timerTask || messages.timerFocus}</p>
                  <div style={{ fontSize: '3rem', fontWeight: 300, color: theme.text, fontFamily: "'Lora',serif", marginBottom: '16px' }} aria-live="polite">{formatTimer(timerSeconds)}</div>
                  
                  {/* Sound Settings Button */}
                  <div style={{ marginBottom: '16px', display: 'flex', gap: '8px', justifyContent: 'center', alignItems: 'center' }}>
                    <button onClick={() => setShowSoundMenu(true)} style={{ ...s.btnSecondary, display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px' }}>
                      <span style={{ fontSize: '1.1rem' }}>{ambientSound === 'off' ? 'ğŸ”‡' : ambientSound === 'ambiance' ? 'ğŸŒ§ï¸' : ambientSound === 'music' ? 'ğŸ¹' : 'âœ¨'}</span>
                      <span className="bt" style={{ fontSize: '0.8rem' }}>
                        {ambientSound === 'off' ? 'Sound Off' : 
                         ambientSound === 'ambiance' ? (ambianceTracks[getActiveAmbianceTrack()]?.name || 'Ambiance') :
                         ambientSound === 'music' ? (musicTracks[getActiveMusicTrack()]?.name || 'Music') :
                         'Full Soundscape'}
                      </span>
                      <span style={{ fontSize: '0.7rem', opacity: 0.7 }}>â–¼</span>
                    </button>
                    {ambientSound !== 'off' && (
                      <button 
                        onClick={() => setSoundEnabled(!soundEnabled)} 
                        style={{ 
                          ...s.btnSecondary, 
                          padding: '10px 14px',
                          background: soundEnabled ? theme.accentGradient : theme.progressBg,
                          color: soundEnabled ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text
                        }}
                      >
                        {soundEnabled ? 'â¸' : 'â–¶'}
                      </button>
                    )}
                  </div>

                  <div style={{ display: 'flex', gap: '8px', justifyContent: 'center', marginBottom: '16px' }}>
                    {!timerRunning ? (
                      <button onClick={() => { setTimerRunning(true); setTimerStartTime(Date.now()); if (ambientSound !== 'off') setSoundEnabled(true); }} style={{ ...s.btn, padding: '10px 24px' }}>â–¶ Start</button>
                    ) : (
                      <button onClick={() => { setTimerRunning(false); setSoundEnabled(false); }} style={{ ...s.btn, padding: '10px 24px' }}>â¸ Pause</button>
                    )}
                    <button onClick={() => { setTimerRunning(false); setTimerSeconds(25 * 60); setTimerTask(null); setTimerStartTime(null); setSoundEnabled(false); }} style={s.btnSecondary}>â†º</button>
                  </div>
                  <div style={{ display: 'flex', gap: '6px', justifyContent: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    {[5, 15, 25, 45, 60].map(m => (
                      <button key={m} onClick={() => { setTimerSeconds(m * 60); setTimerRunning(false); }} style={{ padding: '6px 12px', borderRadius: '8px', border: `1px solid ${theme.cardBorder}`, background: 'transparent', color: theme.textSecondary, fontFamily: "'Lora',serif", fontSize: '0.75rem', cursor: 'pointer' }}>{m}m</button>
                    ))}
                  </div>
                  <button onClick={() => setShowCustomTimer(true)} className="bt" style={{ background: 'none', border: 'none', color: theme.accent, fontSize: '0.8rem', cursor: 'pointer' }}>âš™ï¸ Custom time</button>
                </div>

                {soundEnabled && ambientSound !== 'off' && (
                  <div style={{ ...s.card, textAlign: 'center', background: theme.accentLight }} className="pulse">
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', flexWrap: 'wrap' }}>
                      <p className="bt" style={{ fontSize: '0.8rem', color: theme.accent }}>
                        ğŸµ {ambientSound === 'ambiance' && `${ambianceTracks[getActiveAmbianceTrack()]?.icon} ${ambianceTracks[getActiveAmbianceTrack()]?.name} playing...`}
                        {ambientSound === 'music' && `${musicTracks[getActiveMusicTrack()]?.icon} ${musicTracks[getActiveMusicTrack()]?.name} playing...`}
                        {ambientSound === 'both' && `${ambianceTracks[getActiveAmbianceTrack()]?.icon} + ${musicTracks[getActiveMusicTrack()]?.icon} playing...`}
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* JOURNAL TAB */}
            {activeTab === 'journal' && (
              <div className="fade">
                {/* Daily Prompt Card */}
                <div style={{ ...s.card, background: `linear-gradient(135deg, ${theme.cardBg}, ${theme.accent}15)`, border: `1px solid ${theme.accent}30`, marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '1.3rem' }}>âœ¨</span>
                    <h2 className="hw" style={{ fontSize: '1.1rem', color: theme.accent, margin: 0 }}>Today's Prompt</h2>
                    <span className="bt" style={{ fontSize: '0.65rem', color: theme.textMuted, marginLeft: 'auto' }}>Day {getDayOfYear(new Date()) + 1} of 366</span>
                  </div>
                  <p className="bt" style={{ fontSize: '0.95rem', color: theme.text, fontStyle: 'italic', marginBottom: '12px', lineHeight: 1.5 }}>"{todayPrompt}"</p>
                  <textarea 
                    value={todayJournal.promptResponse || ''} 
                    onChange={e => setTodayJournal({ ...todayJournal, promptResponse: e.target.value })} 
                    onBlur={saveJournal} 
                    placeholder="Take a moment to reflect..." 
                    style={{ ...s.input, minHeight: '90px', resize: 'vertical', fontSize: '0.9rem', background: theme.inputBg }} 
                    aria-label="Prompt response"
                  />
                </div>
                
                <div style={s.card}>
                  <h2 className="hw" style={{ fontSize: '1.3rem', color: theme.text, marginBottom: '12px' }}>ğŸ“ Daily Reflection</h2>
                  <div style={{ marginBottom: '12px' }}>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ğŸ™ 3 things I'm grateful for:</label>
                    <textarea value={todayJournal.gratitude} onChange={e => setTodayJournal({ ...todayJournal, gratitude: e.target.value })} onBlur={saveJournal} placeholder="1. ...\n2. ...\n3. ..." style={{ ...s.input, minHeight: '70px', resize: 'vertical', fontSize: '0.9rem' }} aria-label="Gratitude journal" />
                  </div>
                  <div style={{ marginBottom: '12px' }}>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ğŸ’­ How was today?</label>
                    <textarea value={todayJournal.reflection} onChange={e => setTodayJournal({ ...todayJournal, reflection: e.target.value })} onBlur={saveJournal} placeholder="What went well? What was challenging?" style={{ ...s.input, minHeight: '80px', resize: 'vertical', fontSize: '0.9rem' }} />
                  </div>
                  <div>
                    <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>ğŸ¯ Top 3 for tomorrow:</label>
                    <textarea value={todayJournal.tomorrow} onChange={e => setTodayJournal({ ...todayJournal, tomorrow: e.target.value })} onBlur={saveJournal} placeholder="1. ...\n2. ...\n3. ..." style={{ ...s.input, minHeight: '70px', resize: 'vertical', fontSize: '0.9rem' }} />
                  </div>
                </div>
                <p className="bt" style={{ textAlign: 'center', fontSize: '0.7rem', color: theme.textMuted }}>Auto-saved â€¢ {Object.keys(journal).length} entries</p>
              </div>
            )}

            {/* CALENDAR TAB */}
            {activeTab === 'calendar' && (
              <div className="fade">
                <div style={s.card}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <button onClick={() => setCalendarDate(new Date(calYear, calMonth - 1, 1))} style={{ background: 'none', border: 'none', color: theme.textSecondary, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }}>â€¹</button>
                    <h2 className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>{calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h2>
                    <button onClick={() => setCalendarDate(new Date(calYear, calMonth + 1, 1))} style={{ background: 'none', border: 'none', color: theme.textSecondary, fontSize: '1.1rem', cursor: 'pointer', padding: '6px' }}>â€º</button>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '3px', marginBottom: '4px' }}>
                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => <div key={i} className="bt" style={{ textAlign: 'center', fontSize: '0.6rem', color: theme.textMuted, padding: '3px' }}>{d}</div>)}
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '3px' }}>
                    {calDays.map((day, i) => {
                      if (!day) return <div key={i} />;
                      const dk = getDateKey(day);
                      const dm = moods[dk];
                      const isToday = isSameDay(day, today);
                      return (
                        <div key={i} style={{ aspectRatio: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', borderRadius: '8px', background: isToday ? theme.accentGradient : dm ? theme.accentLight : 'transparent', border: isToday ? 'none' : `1px solid ${theme.cardBorder}` }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: isToday ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text, fontWeight: isToday ? 600 : 400 }}>{day.getDate()}</span>
                          {dm && <span style={{ fontSize: '0.45rem' }}>{moodEmojis.find(m => m.value === dm.value)?.emoji}</span>}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Heatmap */}
                <div style={s.card}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ”¥ Habit Heatmap (12 weeks)</h3>
                  <div style={{ display: 'flex', gap: '2px', justifyContent: 'center' }}>
                    {heatmapData.map((week, wi) => (
                      <div key={wi} style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        {week.map((day, di) => {
                          const intensity = day.total > 0 ? day.count / day.total : 0;
                          return (<div key={di} title={`${day.date}: ${day.count}/${day.total}`} style={{ width: '10px', height: '10px', borderRadius: '2px', background: intensity === 0 ? theme.progressBg : `rgba(${theme.isDark ? '139,171,123' : '107,139,91'}, ${0.3 + intensity * 0.7})`, cursor: 'pointer', transition: 'transform 0.2s' }} />);
                        })}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* STATS TAB */}
            {activeTab === 'stats' && (
              <div className="fade">
                {/* Year in Review */}
                <button onClick={() => setShowYearReview(true)} style={{ ...s.card, width: '100%', textAlign: 'center', cursor: 'pointer', border: `2px solid ${theme.accent}` }}>
                  <span style={{ fontSize: '1.2rem' }}>ğŸ“…</span>
                  <p className="hw" style={{ fontSize: '1.2rem', color: theme.text, marginTop: '4px' }}>{currentYear} Year in Review</p>
                </button>

                {/* Challenges */}
                <div style={{ ...s.card, cursor: 'pointer' }} onClick={() => setShowChallenges(true)}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ† Challenges</h3>
                  {weeklyChallenge && (
                    <div style={{ marginBottom: '8px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                        <span className="bt" style={{ color: theme.textSecondary }}>Weekly: {weeklyChallenge.name}</span>
                        <span className="bt" style={{ color: theme.accent }}>{Math.min(challenges.weekly.progress, weeklyChallenge.target)}/{weeklyChallenge.target}</span>
                      </div>
                      <div style={{ height: '6px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                        <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                      </div>
                    </div>
                  )}
                  {monthlyChallenge && (
                    <div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '3px' }}>
                        <span className="bt" style={{ color: theme.textSecondary }}>Monthly: {monthlyChallenge.name}</span>
                        <span className="bt" style={{ color: theme.accent }}>{Math.min(challenges.monthly.progress, monthlyChallenge.target)}/{monthlyChallenge.target}</span>
                      </div>
                      <div style={{ height: '6px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                        <div style={{ height: '100%', width: `${Math.min(100, (challenges.monthly.progress / monthlyChallenge.target) * 100)}%`, background: theme.xpBar, borderRadius: '999px' }} />
                      </div>
                    </div>
                  )}
                </div>

                {/* Mood Insights */}
                {moodInsights && (
                  <div style={s.card}>
                    <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ˜Š Mood Insights</h3>
                    {moodInsights.hasEnoughData ? (
                      <div className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, lineHeight: 1.6 }}>
                        {moodInsights.moodDiff && parseFloat(moodInsights.moodDiff) > 0 && (
                          <p style={{ marginBottom: '8px', padding: '8px', background: theme.accentLight, borderRadius: '8px' }}>
                            <span style={{ fontSize: '1.1rem' }}>âœ¨</span> Your mood is <strong style={{ color: theme.accent }}>+{moodInsights.moodDiff} points higher</strong> on days you complete most habits!
                          </p>
                        )}
                        {moodInsights.avgHighCompletion && (
                          <p>ğŸ“ˆ High habit days: <strong style={{ color: theme.text }}>{moodInsights.avgHighCompletion}/5</strong> avg mood</p>
                        )}
                        {moodInsights.avgLowCompletion && (
                          <p>ğŸ“‰ Low habit days: <strong style={{ color: theme.text }}>{moodInsights.avgLowCompletion}/5</strong> avg mood</p>
                        )}
                        {moodInsights.bestDay && (
                          <p style={{ marginTop: '6px' }}>ğŸŒŸ Best mood day: <strong style={{ color: theme.accent }}>{moodInsights.bestDay.name}</strong> ({moodInsights.bestDay.avg.toFixed(1)}/5)</p>
                        )}
                      </div>
                    ) : (
                      <p className="bt" style={{ fontSize: '0.75rem', color: theme.textMuted }}>Track your mood for a week to unlock insights!</p>
                    )}
                  </div>
                )}

                {/* Streaks */}
                <div style={s.card}>
                  <h3 className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ”¥ Streaks</h3>
                  {habits.sort((a, b) => b.streak - a.streak).slice(0, 5).map(h => (
                    <div key={h.id} style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1rem' }}>{h.icon}</span>
                      <div style={{ flex: 1 }}>
                        <p className="bt" style={{ fontSize: '0.75rem', color: theme.text }}>{h.name}</p>
                        <div style={{ height: '4px', background: theme.progressBg, borderRadius: '999px', marginTop: '3px', overflow: 'hidden' }}>
                          <div style={{ height: '100%', width: `${Math.min(100, h.streak * 3.33)}%`, background: theme.streakGradient, borderRadius: '999px' }} />
                        </div>
                      </div>
                      <span className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.accent }}>{h.streak}d</span>
                    </div>
                  ))}
                </div>

                {/* Quick Actions */}
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowExport(true)} style={{ ...s.btnSecondary, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', padding: '14px' }}>
                    <span style={{ fontSize: '1.2rem' }}>ğŸ’¾</span>
                    <span className="bt" style={{ fontSize: '0.75rem' }}>Export Data</span>
                  </button>
                  <button onClick={() => shareAchievement(`I'm a ${currentLevel.title} at ${cafeName}! ${gameStats.xp} XP earned on my productivity journey. â˜•ğŸ†`)} style={{ ...s.btnSecondary, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', padding: '14px' }}>
                    <span style={{ fontSize: '1.2rem' }}>ğŸ“¤</span>
                    <span className="bt" style={{ fontSize: '0.75rem' }}>Share Progress</span>
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Bottom Nav */}
          <nav style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: theme.navBg, borderTop: `1px solid ${theme.cardBorder}`, display: 'flex', justifyContent: 'space-around', padding: '5px 0', paddingBottom: 'max(5px,env(safe-area-inset-bottom))', backdropFilter: 'blur(20px)', zIndex: 100 }} role="navigation" aria-label="Main navigation">
            {[{ id: 'today', icon: 'ğŸ“‹', label: 'Today' }, { id: 'timer', icon: 'â±ï¸', label: 'Focus' }, { id: 'journal', icon: 'ğŸ“', label: 'Journal' }, { id: 'calendar', icon: 'ğŸ“…', label: 'Calendar' }, { id: 'stats', icon: 'ğŸ“Š', label: 'Stats' }].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={s.navItem(activeTab === tab.id)} aria-current={activeTab === tab.id ? 'page' : undefined}>
                <span style={{ fontSize: '1.1rem' }}>{tab.icon}</span>
                <span>{tab.label}</span>
              </button>
            ))}
          </nav>

          {/* Floating Sound Button */}
          <button 
            onClick={() => setShowSoundMenu(true)} 
            style={{ 
              position: 'fixed', 
              bottom: '90px', 
              left: '20px', 
              width: '48px', 
              height: '48px', 
              borderRadius: '50%', 
              background: soundEnabled ? theme.accentGradient : theme.cardBg, 
              border: `2px solid ${soundEnabled ? 'transparent' : theme.cardBorder}`, 
              fontSize: '20px', 
              cursor: 'pointer', 
              boxShadow: '0 4px 16px rgba(0,0,0,0.2)', 
              zIndex: 99, 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              color: soundEnabled ? (theme.isDark ? '#1a1a1a' : '#fff') : theme.text
            }} 
            aria-label="Sound settings"
          >
            {soundEnabled ? 'ğŸµ' : 'ğŸ”‡'}
          </button>

          {/* FAB */}
          <button onClick={() => setShowQuickAdd(true)} style={s.fab} aria-label="Quick add">+</button>

          {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
          {/* MODALS */}
          {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}

          {/* What's New / Grand Reopening */}
          {showWhatsNew && (
            <div style={s.modal} className="fade">
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide">
                <div style={{ fontSize: '3rem', marginBottom: '8px' }}>ğŸ‰</div>
                <h2 className="hw" style={{ fontSize: '1.8rem', color: theme.text, marginBottom: '4px' }}>Grand Reopening!</h2>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, marginBottom: '20px' }}>We've been renovating! Pull up a chair and see what's new...</p>
                
                <div style={{ textAlign: 'left', maxHeight: '300px', overflow: 'auto', marginBottom: '16px' }}>
                  {whatsNewContent.map((section, i) => (
                    <div key={i} style={{ marginBottom: '16px' }}>
                      <h3 className="hw" style={{ fontSize: '1.2rem', color: theme.accent, marginBottom: '8px' }}>{section.title}</h3>
                      {section.items.map((item, j) => (
                        <div key={j} style={{ display: 'flex', gap: '10px', alignItems: 'flex-start', marginBottom: '8px', padding: '8px', background: theme.progressBg, borderRadius: '10px' }}>
                          <span style={{ fontSize: '1.2rem' }}>{item.icon}</span>
                          <div>
                            <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text }}>{item.title}</p>
                            <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{item.desc}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
                
                <button onClick={dismissWhatsNew} style={{ ...s.btn, width: '100%' }}>Show Me Around! â˜•</button>
              </div>
            </div>
          )}

          {/* Interactive Tutorial */}
          {showTutorial && (
            <div style={s.modal} className="fade">
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide">
                <button onClick={dismissTutorial} style={{ position: 'absolute', top: '16px', right: '16px', background: 'none', border: 'none', color: theme.textMuted, fontSize: '0.8rem', cursor: 'pointer' }}>Skip tour</button>
                
                <div style={{ fontSize: '2.5rem', marginBottom: '12px' }}>{tutorialSteps[tutorialStep].icon}</div>
                <h2 className="hw" style={{ fontSize: '1.5rem', color: theme.text, marginBottom: '4px' }}>{tutorialSteps[tutorialStep].title}</h2>
                <p className="bt" style={{ fontSize: '0.9rem', color: theme.accent, fontStyle: 'italic', marginBottom: '12px' }}>{tutorialSteps[tutorialStep].subtitle}</p>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, lineHeight: 1.5, marginBottom: '20px' }}>{tutorialSteps[tutorialStep].content}</p>
                
                {/* Progress dots */}
                <div style={{ display: 'flex', justifyContent: 'center', gap: '6px', marginBottom: '16px' }}>
                  {tutorialSteps.map((_, i) => (
                    <div key={i} style={{ width: i === tutorialStep ? '20px' : '8px', height: '8px', borderRadius: '4px', background: i === tutorialStep ? theme.accentGradient : theme.progressBg, transition: 'all 0.3s' }} />
                  ))}
                </div>
                
                <div style={{ display: 'flex', gap: '10px' }}>
                  {tutorialStep > 0 && (
                    <button onClick={() => setTutorialStep(s => s - 1)} style={{ ...s.btnSecondary, flex: 1 }}>â† Back</button>
                  )}
                  {tutorialStep < tutorialSteps.length - 1 ? (
                    <button onClick={() => setTutorialStep(s => s + 1)} style={{ ...s.btn, flex: 1 }}>Next â†’</button>
                  ) : (
                    <button onClick={dismissTutorial} style={{ ...s.btn, flex: 1 }}>Let's Brew! â˜•</button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Quick Add */}
          {showQuickAdd && (
            <div style={{ ...s.modal, alignItems: 'flex-end' }} onClick={() => setShowQuickAdd(false)}>
              <div style={{ background: theme.modalBg, borderRadius: '20px 20px 0 0', width: '100%', maxWidth: '28rem', padding: '20px', paddingBottom: 'max(20px,env(safe-area-inset-bottom))' }} className="slide" onClick={e => e.stopPropagation()}>
                <h3 className="hw" style={{ fontSize: '1.3rem', color: theme.text, textAlign: 'center', marginBottom: '16px' }}>Quick Add</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => { setShowQuickAdd(false); setShowAddHabit(true); }} style={{ ...s.btn, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '6px', padding: '16px' }}>
                    <span style={{ fontSize: '1.5rem' }}>â­</span><span>New Habit</span>
                  </button>
                  <button onClick={() => { setShowQuickAdd(false); setShowAddTask(true); }} style={{ ...s.btn, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '6px', padding: '16px' }}>
                    <span style={{ fontSize: '1.5rem' }}>âœ“</span><span>New Task</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add Habit */}
          {showAddHabit && (
            <div style={s.modal} onClick={() => setShowAddHabit(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>â­ New Habit</h2>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '8px' }}>Choose an icon:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px', maxHeight: '120px', overflow: 'auto' }}>
                  {defaultEmojis.map(e => (<button key={e} onClick={() => setNewHabit({ ...newHabit, icon: e })} style={{ width: '36px', height: '36px', borderRadius: '10px', border: newHabit.icon === e ? `2px solid ${theme.accent}` : 'none', background: newHabit.icon === e ? theme.accentLight : theme.progressBg, fontSize: '1.1rem', cursor: 'pointer' }}>{e}</button>))}
                </div>
                <input value={newHabit.name} onChange={e => setNewHabit({ ...newHabit, name: e.target.value })} placeholder="Habit name..." style={{ ...s.input, marginBottom: '14px' }} onKeyPress={e => e.key === 'Enter' && addHabit()} autoFocus />
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowAddHabit(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={addHabit} style={{ ...s.btn, flex: 1 }}>Add Habit</button>
                </div>
              </div>
            </div>
          )}

          {/* Add Task */}
          {showAddTask && (
            <div style={s.modal} onClick={() => setShowAddTask(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>âœ“ New Task</h2>
                <input value={newTask.text} onChange={e => setNewTask({ ...newTask, text: e.target.value })} placeholder="What needs doing?" style={{ ...s.input, marginBottom: '12px' }} autoFocus />
                <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                  <input type="time" value={newTask.time} onChange={e => setNewTask({ ...newTask, time: e.target.value })} style={{ ...s.input, flex: 1 }} />
                  <select value={newTask.priority} onChange={e => setNewTask({ ...newTask, priority: e.target.value })} style={{ ...s.input, flex: 1 }}>
                    <option value="high">ğŸ”´ High</option>
                    <option value="medium">ğŸŸ¡ Medium</option>
                    <option value="low">ğŸŸ¢ Low</option>
                  </select>
                </div>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Category:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px' }}>
                  {categories.map(c => (<button key={c.id} onClick={() => setNewTask({ ...newTask, category: newTask.category === c.id ? null : c.id })} style={{ padding: '5px 10px', borderRadius: '8px', border: newTask.category === c.id ? `2px solid ${c.color}` : `1px solid ${theme.cardBorder}`, background: newTask.category === c.id ? `${c.color}22` : 'transparent', fontSize: '0.7rem', cursor: 'pointer' }}>{c.icon}</button>))}
                </div>
                <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>ğŸ”„ Repeat:</p>
                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', marginBottom: '14px' }}>
                  {[{ id: 'none', label: 'Once' }, { id: 'daily', label: 'Daily' }, { id: 'weekdays', label: 'Weekdays' }, { id: 'weekly', label: 'Weekly' }].map(r => (
                    <button key={r.id} onClick={() => setNewTask({ ...newTask, recurring: r.id })} style={{ padding: '6px 12px', borderRadius: '8px', border: newTask.recurring === r.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, background: newTask.recurring === r.id ? theme.accentLight : 'transparent', fontSize: '0.75rem', color: theme.text, cursor: 'pointer', fontFamily: "'Lora',serif" }}>{r.label}</button>
                  ))}
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowAddTask(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={addTask} style={{ ...s.btn, flex: 1 }}>Add Task</button>
                </div>
              </div>
            </div>
          )}

          {/* Theme Picker */}
          {showThemePicker && (
            <div style={s.modal} className="fade" onClick={() => setShowThemePicker(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.5rem', color: theme.text, textAlign: 'center', marginBottom: '16px' }}>{brewThemes[brewType].icon} Choose Your Brew</h2>
                {Object.entries(brewThemes).map(([key, brew]) => (
                  <div key={key} style={{ marginBottom: '14px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.2rem' }}>{brew.icon}</span>
                      <span className="bt" style={{ fontSize: '0.95rem', fontWeight: 600, color: theme.text }}>{brew.name}</span>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      {['light', 'dark'].map(mode => {
                        const t = brew[mode];
                        const isActive = brewType === key && isDark === (mode === 'dark');
                        return (<button key={mode} onClick={() => { setBrewType(key); setIsDark(mode === 'dark'); }} style={{ flex: 1, padding: '12px 10px', borderRadius: '12px', border: isActive ? `3px solid ${t.accent}` : `1px solid ${theme.cardBorder}`, background: t.cardBg, cursor: 'pointer' }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px', marginBottom: '4px' }}>
                            <span style={{ fontSize: '0.9rem' }}>{t.icon}</span>
                            <span className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: t.text }}>{t.name}</span>
                          </div>
                        </button>);
                      })}
                    </div>
                  </div>
                ))}
                <button onClick={() => setShowThemePicker(false)} style={{ ...s.btn, width: '100%', marginTop: '6px' }}>Done</button>
              </div>
            </div>
          )}

          {/* Settings */}
          {showSettings && (
            <div style={s.modal} className="fade" onClick={() => setShowSettings(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>âš™ï¸ Settings</h2>
                <div style={{ marginBottom: '14px' }}>
                  <label className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, display: 'block', marginBottom: '4px' }}>Name your cafÃ©:</label>
                  <input value={cafeName} onChange={e => setCafeName(e.target.value)} style={s.input} maxLength={24} />
                </div>
                
                <div style={{ marginBottom: '14px' }}>
                  <label className="bt" style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '0.85rem', color: theme.text, cursor: 'pointer' }}>
                    <input type="checkbox" checked={highContrast} onChange={e => setHighContrast(e.target.checked)} style={{ accentColor: theme.accent }} />
                    â™¿ High Contrast Mode
                  </label>
                </div>

                <div style={{ marginBottom: '14px' }}>
                  <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Season: {seasonDeco.emoji} {seasonDeco.name}</p>
                </div>

                <div style={{ marginBottom: '14px', padding: '10px', background: theme.progressBg, borderRadius: '10px' }}>
                  <p className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '6px' }}>Your stats:</p>
                  <div className="bt" style={{ fontSize: '0.75rem', color: theme.text, lineHeight: 1.6 }}>
                    <p>ğŸ† {gameStats.xp} XP â€¢ {currentLevel.title}</p>
                    <p>âœ“ {gameStats.totalTasksCompleted} tasks â€¢ â­ {gameStats.totalHabitsCompleted} habits</p>
                    <p>ğŸ“… {gameStats.appStreak} day streak â€¢ â„ï¸ {gameStats.freezesAvailable} freeze</p>
                  </div>
                </div>

                {/* Notifications */}
                <div style={{ marginBottom: '14px', padding: '12px', background: theme.progressBg, borderRadius: '10px', border: 'Notification' in window && Notification.permission === 'default' ? `2px solid ${theme.accent}` : 'none' }}>
                  <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text, marginBottom: '6px' }}>ğŸ”” Notifications</p>
                  <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary, marginBottom: '10px' }}>
                    Get notified when timers complete and tasks are due
                  </p>
                  {'Notification' in window ? (
                    Notification.permission === 'granted' ? (
                      <div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: 'rgba(74,222,128,0.15)', borderRadius: '8px', marginBottom: '8px' }}>
                          <span style={{ fontSize: '1.2rem' }}>âœ…</span>
                          <div style={{ flex: 1 }}>
                            <p className="bt" style={{ fontSize: '0.8rem', color: '#4ade80', fontWeight: 600 }}>Notifications enabled!</p>
                            <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary }}>Timer alerts + task reminders (5 min warning & when due)</p>
                          </div>
                        </div>
                        <button 
                          onClick={async () => {
                            try {
                              // Try service worker notification first (works better on mobile)
                              if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                                const reg = await navigator.serviceWorker.ready;
                                await reg.showNotification('Test Notification ğŸ§ª', { 
                                  body: 'Great! Notifications are working. You\'ll be reminded 5 min before tasks and when they\'re due.', 
                                  icon: '/icons/icon-192.png',
                                  tag: 'test-notification',
                                  vibrate: [100, 50, 100]
                                });
                                triggerCelebration('âœ… Test sent!');
                              } else {
                                // Fallback to regular notification
                                const notif = new Notification('Test Notification ğŸ§ª', { 
                                  body: 'Great! Notifications are working.', 
                                  icon: '/icons/icon-192.png',
                                  tag: 'test-notification'
                                });
                                triggerCelebration('âœ… Test sent!');
                              }
                              if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
                            } catch (e) {
                              console.error('Notification error:', e);
                              // Show what went wrong
                              alert('Notification failed: ' + e.message + '\n\nTry: 1) Refresh the page, 2) Re-enable notifications in browser settings, 3) Make sure you\'re using HTTPS');
                            }
                          }}
                          style={{ ...s.btnSecondary, width: '100%', fontSize: '0.8rem', padding: '10px' }}
                        >
                          ğŸ§ª Send Test Notification
                        </button>
                      </div>
                    ) : Notification.permission === 'denied' ? (
                      <div style={{ padding: '8px 12px', background: 'rgba(239,68,68,0.1)', borderRadius: '8px' }}>
                        <p className="bt" style={{ fontSize: '0.75rem', color: '#ef4444', marginBottom: '4px' }}>âš ï¸ Notifications blocked</p>
                        <p className="bt" style={{ fontSize: '0.65rem', color: theme.textMuted }}>To enable: Open browser settings â†’ Site settings â†’ Notifications â†’ Allow for this site</p>
                      </div>
                    ) : (
                      <div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: theme.accentLight, borderRadius: '8px', marginBottom: '10px' }}>
                          <span style={{ fontSize: '1.2rem' }}>ğŸ’¡</span>
                          <p className="bt" style={{ fontSize: '0.7rem', color: theme.text }}>Enable notifications to get reminders even when the app is in the background!</p>
                        </div>
                        <button 
                          onClick={async () => {
                            const permission = await Notification.requestPermission();
                            if (permission === 'granted') {
                              new Notification('My Daily Brew â˜•', { 
                                body: 'Awesome! You\'ll now get timer and task reminders.', 
                                icon: '/icons/icon-192.png',
                                tag: 'welcome'
                              });
                              triggerCelebration('ğŸ”” Notifications enabled!');
                            }
                          }}
                          style={{ ...s.btn, width: '100%', fontSize: '0.85rem', padding: '12px' }}
                        >
                          ğŸ”” Enable Notifications
                        </button>
                      </div>
                    )
                  ) : (
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.textMuted }}>Notifications not supported in this browser. Try Chrome or Safari.</p>
                  )}
                </div>

                <p className="bt" style={{ fontSize: '0.65rem', color: theme.textMuted, marginBottom: '8px', textAlign: 'center' }}>
                  ğŸ’¡ Tip: For reliable reminders, also set alarms in your phone's clock app
                </p>
                
                <p className="bt" style={{ fontSize: '0.7rem', color: theme.textMuted, marginBottom: '14px' }}>ğŸ’¡ Swipe right to complete</p>
                <button onClick={() => setShowSettings(false)} style={{ ...s.btn, width: '100%' }}>Done</button>
              </div>
            </div>
          )}

          {/* Badges */}
          {showBadges && (
            <div style={s.modal} className="fade" onClick={() => setShowBadges(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, textAlign: 'center', marginBottom: '4px' }}>ğŸ† Achievements</h2>
                <p className="bt" style={{ textAlign: 'center', fontSize: '0.8rem', color: theme.textSecondary, marginBottom: '16px' }}>{gameStats.unlockedBadges.length}/{badges.length} unlocked</p>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: '8px', maxHeight: '350px', overflow: 'auto' }}>
                  {badges.map(b => {
                    const unlocked = gameStats.unlockedBadges.includes(b.id);
                    return (<div key={b.id} style={{ padding: '12px 8px', borderRadius: '12px', background: unlocked ? theme.accentLight : theme.progressBg, border: `1px solid ${theme.cardBorder}`, textAlign: 'center', opacity: unlocked ? 1 : 0.5 }}>
                      <div style={{ fontSize: '1.5rem', marginBottom: '4px', filter: unlocked ? 'none' : 'grayscale(1)' }}>{b.icon}</div>
                      <p className="bt" style={{ fontSize: '0.7rem', fontWeight: 600, color: theme.text }}>{b.name}</p>
                      <p className="bt" style={{ fontSize: '0.55rem', color: theme.textMuted }}>{b.desc}</p>
                      {unlocked && <button onClick={() => shareAchievement(`I earned the "${b.name}" badge at ${cafeName}! ${b.icon}`)} className="bt" style={{ marginTop: '4px', background: 'none', border: 'none', color: theme.accent, fontSize: '0.6rem', cursor: 'pointer' }}>ğŸ“¤ Share</button>}
                    </div>);
                  })}
                </div>
                <button onClick={() => setShowBadges(false)} style={{ ...s.btn, width: '100%', marginTop: '14px' }}>Close</button>
              </div>
            </div>
          )}

          {/* Challenges */}
          {showChallenges && (
            <div style={s.modal} className="fade" onClick={() => setShowChallenges(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>ğŸ† Challenges</h2>
                
                <h3 className="bt" style={{ fontSize: '0.9rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ“… Weekly Challenge</h3>
                {weeklyChallenge && (
                  <div style={{ ...s.card, marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.5rem' }}>{weeklyChallenge.icon}</span>
                      <div>
                        <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text }}>{weeklyChallenge.name}</p>
                        <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{weeklyChallenge.desc}</p>
                      </div>
                    </div>
                    <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                      <div style={{ height: '100%', width: `${Math.min(100, (challenges.weekly.progress / weeklyChallenge.target) * 100)}%`, background: theme.streakGradient, borderRadius: '999px', transition: 'width 0.5s' }} />
                    </div>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.accent, marginTop: '4px', textAlign: 'right' }}>{Math.min(challenges.weekly.progress, weeklyChallenge.target)}/{weeklyChallenge.target} â€¢ +{weeklyChallenge.xp} XP</p>
                  </div>
                )}

                <h3 className="bt" style={{ fontSize: '0.9rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ“† Monthly Challenge</h3>
                {monthlyChallenge && (
                  <div style={s.card}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '1.5rem' }}>{monthlyChallenge.icon}</span>
                      <div>
                        <p className="bt" style={{ fontSize: '0.85rem', fontWeight: 600, color: theme.text }}>{monthlyChallenge.name}</p>
                        <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>{monthlyChallenge.desc}</p>
                      </div>
                    </div>
                    <div style={{ height: '8px', background: theme.progressBg, borderRadius: '999px', overflow: 'hidden' }}>
                      <div style={{ height: '100%', width: `${Math.min(100, (challenges.monthly.progress / monthlyChallenge.target) * 100)}%`, background: theme.xpBar, borderRadius: '999px', transition: 'width 0.5s' }} />
                    </div>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.accent, marginTop: '4px', textAlign: 'right' }}>{Math.min(challenges.monthly.progress, monthlyChallenge.target)}/{monthlyChallenge.target} â€¢ +{monthlyChallenge.xp} XP</p>
                  </div>
                )}

                <button onClick={() => setShowChallenges(false)} style={{ ...s.btn, width: '100%', marginTop: '14px' }}>Close</button>
              </div>
            </div>
          )}

          {/* Year in Review */}
          {showYearReview && (
            <div style={s.modal} className="fade" onClick={() => setShowYearReview(false)}>
              <div style={s.modalContent} className="slide" onClick={e => e.stopPropagation()}>
                <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                  <span style={{ fontSize: '2.5rem' }}>{brewThemes[brewType].icon}</span>
                  <h2 className="hw" style={{ fontSize: '1.6rem', color: theme.text, marginTop: '8px' }}>{currentYear} Year in Review</h2>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: '10px', marginBottom: '16px' }}>
                  {[{ v: gameStats.xp, l: 'Total XP' }, { v: yearReview.badgesEarned, l: 'Badges' }, { v: yearReview.totalHabits, l: 'Habits Done' }, { v: yearReview.totalTasks, l: 'Tasks Done' }].map((stat, i) => (
                    <div key={i} style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', textAlign: 'center' }}>
                      <p style={{ fontSize: '1.5rem', fontWeight: 600, color: theme.text }}>{stat.v}</p>
                      <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary }}>{stat.l}</p>
                    </div>
                  ))}
                </div>

                <div style={{ background: theme.accentLight, borderRadius: '12px', padding: '14px', marginBottom: '12px' }}>
                  <div className="bt" style={{ fontSize: '0.8rem', color: theme.textSecondary, lineHeight: 1.8 }}>
                    <p>ğŸ”¥ Longest streak: <strong style={{ color: theme.text }}>{yearReview.longestStreak} days</strong></p>
                    <p>ğŸ˜Š Avg mood: <strong style={{ color: theme.text }}>{yearReview.avgMood || 'â€”'}/5</strong></p>
                    <p>ğŸ“ Journal entries: <strong style={{ color: theme.text }}>{yearReview.totalJournal}</strong></p>
                    <p>â±ï¸ Focus time: <strong style={{ color: theme.text }}>{Math.round(yearReview.totalFocus / 60)} hours</strong></p>
                  </div>
                </div>

                <div style={{ textAlign: 'center', padding: '12px', background: theme.streakGradient, borderRadius: '12px', marginBottom: '14px' }}>
                  <p className="hw" style={{ fontSize: '1.2rem', color: theme.isDark ? '#1a1a1a' : '#fff' }}>{currentLevel.icon} {currentLevel.title}</p>
                </div>

                <button onClick={() => shareAchievement(`My ${currentYear} at ${cafeName}: ${yearReview.totalHabits} habits, ${yearReview.totalTasks} tasks, ${yearReview.longestStreak}-day streak! â˜•ğŸ†`)} style={{ ...s.btnSecondary, width: '100%', marginBottom: '10px' }}>ğŸ“¤ Share My Year</button>
                <button onClick={() => setShowYearReview(false)} style={{ ...s.btn, width: '100%' }}>Close</button>
              </div>
            </div>
          )}

          {/* Custom Timer */}
          {showCustomTimer && (
            <div style={s.modal} onClick={() => setShowCustomTimer(false)}>
              <div style={{ ...s.modalContent, maxWidth: '300px', textAlign: 'center' }} className="slide" onClick={e => e.stopPropagation()}>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginBottom: '16px' }}>â±ï¸ Custom Timer</h2>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', marginBottom: '20px' }}>
                  <button onClick={() => setCustomTimerMins(Math.max(1, customTimerMins - 5))} style={{ ...s.btnSecondary, padding: '10px 16px', fontSize: '1.2rem' }}>-</button>
                  <div>
                    <input type="number" value={customTimerMins} onChange={e => setCustomTimerMins(Math.max(1, Math.min(180, parseInt(e.target.value) || 1)))} style={{ ...s.input, width: '80px', textAlign: 'center', fontSize: '1.5rem', fontWeight: 600 }} min="1" max="180" />
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginTop: '4px' }}>minutes</p>
                  </div>
                  <button onClick={() => setCustomTimerMins(Math.min(180, customTimerMins + 5))} style={{ ...s.btnSecondary, padding: '10px 16px', fontSize: '1.2rem' }}>+</button>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setShowCustomTimer(false)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={() => { setTimerSeconds(customTimerMins * 60); setShowCustomTimer(false); }} style={{ ...s.btn, flex: 1 }}>Set Timer</button>
                </div>
              </div>
            </div>
          )}

          {/* Sound Menu */}
          {showSoundMenu && (
            <div style={{ ...s.modal, alignItems: 'flex-end' }} onClick={() => setShowSoundMenu(false)}>
              <div style={{ background: theme.modalBg, borderRadius: '20px 20px 0 0', width: '100%', maxWidth: '28rem', padding: '20px', paddingBottom: 'max(20px,env(safe-area-inset-bottom))', maxHeight: '90vh', overflow: 'auto' }} className="slide" onClick={e => e.stopPropagation()}>
                <h3 className="hw" style={{ fontSize: '1.4rem', color: theme.text, textAlign: 'center', marginBottom: '4px' }}>ğŸµ Soundscape</h3>
                <p className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary, textAlign: 'center', marginBottom: '16px' }}>
                  {isDark ? 'ğŸŒ™ Dark mode: Warmer, deeper tones' : 'â˜€ï¸ Light mode: Brighter, airy tones'}
                </p>
                
                {/* Big Play/Stop Button */}
                <div style={{ textAlign: 'center', marginBottom: '16px' }}>
                  <button 
                    onClick={() => { if (ambientSound === 'off') { setAmbientSound('both'); } setSoundEnabled(!soundEnabled); }}
                    disabled={ambientSound === 'off'}
                    style={{ 
                      width: '72px', 
                      height: '72px', 
                      borderRadius: '50%', 
                      border: 'none',
                      background: soundEnabled ? theme.streakGradient : theme.accentGradient,
                      cursor: ambientSound === 'off' ? 'not-allowed' : 'pointer',
                      opacity: ambientSound === 'off' ? 0.5 : 1,
                      fontSize: '1.8rem',
                      boxShadow: soundEnabled ? '0 0 20px rgba(74,222,128,0.4)' : '0 4px 15px rgba(0,0,0,0.2)',
                      transition: 'all 0.3s'
                    }}
                  >
                    {soundEnabled ? 'â¸' : 'â–¶'}
                  </button>
                </div>

                {/* Volume Sliders - Only show when sound is enabled */}
                {ambientSound !== 'off' && (
                  <div style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text, marginBottom: '12px' }}>ğŸšï¸ Volume</p>
                    
                    {/* Ambiance Volume */}
                    {(ambientSound === 'ambiance' || ambientSound === 'both') && (
                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>ğŸŒ§ï¸ Ambiance</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>{ambianceVolume}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          value={ambianceVolume}
                          onChange={e => setAmbianceVolume(parseInt(e.target.value))}
                          style={{ width: '100%', accentColor: theme.accent, height: '6px', borderRadius: '3px', cursor: 'pointer' }}
                        />
                      </div>
                    )}
                    
                    {/* Music Volume */}
                    {(ambientSound === 'music' || ambientSound === 'both') && (
                      <div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.textSecondary }}>ğŸ¹ Music</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.accent }}>{musicVolume}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          value={musicVolume}
                          onChange={e => setMusicVolume(parseInt(e.target.value))}
                          style={{ width: '100%', accentColor: theme.accent, height: '6px', borderRadius: '3px', cursor: 'pointer' }}
                        />
                      </div>
                    )}
                  </div>
                )}

                {/* Mood Presets - for ambiance override */}
                {(ambientSound === 'ambiance' || ambientSound === 'both') && (
                  <div style={{ marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '8px' }}>Ambiance Mood:</p>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px' }}>
                      {[
                        { id: 'cozy', icon: 'ğŸ”¥', name: 'Cozy', desc: 'Warm fireplace' },
                        { id: 'chill', icon: 'ğŸŒ§ï¸', name: 'Rainy', desc: 'Soft rain' },
                        { id: 'soothing', icon: 'ğŸŒŠ', name: 'Ocean', desc: 'Gentle waves' },
                      ].map(mood => (
                        <button 
                          key={mood.id}
                          onClick={() => setSoundMood(mood.id)}
                          style={{
                            padding: '10px 6px',
                            borderRadius: '10px',
                            border: soundMood === mood.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                            background: soundMood === mood.id ? theme.accentLight : 'transparent',
                            cursor: 'pointer',
                            textAlign: 'center'
                          }}
                        >
                          <span style={{ fontSize: '1.2rem', display: 'block' }}>{mood.icon}</span>
                          <span className="bt" style={{ fontSize: '0.7rem', color: theme.text, fontWeight: soundMood === mood.id ? 600 : 400 }}>
                            {mood.name}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Sound Mode Options */}
                <p className="bt" style={{ fontSize: '0.75rem', color: theme.textSecondary, marginBottom: '6px' }}>Sound Mode:</p>
                <div style={{ display: 'flex', gap: '6px', marginBottom: '14px' }}>
                  {[
                    { id: 'off', icon: 'ğŸ”‡', name: 'Off' },
                    { id: 'ambiance', icon: 'ğŸŒ§ï¸', name: 'Ambiance' },
                    { id: 'music', icon: 'ğŸ¹', name: 'Music' },
                    { id: 'both', icon: 'âœ¨', name: 'Full' },
                  ].map(opt => (
                    <button 
                      key={opt.id} 
                      onClick={() => { setAmbientSound(opt.id); if (opt.id === 'off') setSoundEnabled(false); }}
                      style={{ 
                        flex: 1,
                        padding: '10px 6px', 
                        borderRadius: '10px', 
                        border: ambientSound === opt.id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`, 
                        background: ambientSound === opt.id ? theme.accentLight : 'transparent',
                        cursor: 'pointer',
                        textAlign: 'center'
                      }}
                    >
                      <span style={{ fontSize: '1.1rem', display: 'block' }}>{opt.icon}</span>
                      <span className="bt" style={{ fontSize: '0.65rem', color: theme.text }}>{opt.name}</span>
                    </button>
                  ))}
                </div>

                {/* Track Selection */}
                {ambientSound !== 'off' && (
                  <div style={{ background: theme.progressBg, borderRadius: '12px', padding: '14px', marginBottom: '14px' }}>
                    <p className="bt" style={{ fontSize: '0.8rem', fontWeight: 600, color: theme.text, marginBottom: '10px' }}>ğŸ¨ Track Selection</p>
                    
                    {/* Ambiance Track */}
                    {(ambientSound === 'ambiance' || ambientSound === 'both') && (
                      <div style={{ marginBottom: ambientSound === 'both' ? '12px' : 0 }}>
                        <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary, marginBottom: '6px' }}>Ambiance:</p>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                          <button 
                            onClick={() => setAmbianceTrack('auto')}
                            style={{
                              padding: '8px 12px',
                              borderRadius: '8px',
                              border: ambianceTrack === 'auto' ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                              background: ambianceTrack === 'auto' ? theme.accentLight : 'transparent',
                              cursor: 'pointer',
                              fontSize: '0.65rem',
                              color: theme.text,
                              fontFamily: "'Lora',serif"
                            }}
                          >âœ¨ Auto</button>
                          {Object.entries(ambianceTracks).map(([id, track]) => (
                            <button 
                              key={id}
                              onClick={() => setAmbianceTrack(id)}
                              style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: ambianceTrack === id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                                background: ambianceTrack === id ? theme.accentLight : 'transparent',
                                cursor: 'pointer',
                                fontSize: '0.65rem',
                                color: theme.text,
                                fontFamily: "'Lora',serif"
                              }}
                            >{track.icon} {track.name}</button>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Music Track */}
                    {(ambientSound === 'music' || ambientSound === 'both') && (
                      <div>
                        <p className="bt" style={{ fontSize: '0.65rem', color: theme.textSecondary, marginBottom: '6px' }}>Music:</p>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                          <button 
                            onClick={() => setMusicTrack('auto')}
                            style={{
                              padding: '8px 12px',
                              borderRadius: '8px',
                              border: musicTrack === 'auto' ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                              background: musicTrack === 'auto' ? theme.accentLight : 'transparent',
                              cursor: 'pointer',
                              fontSize: '0.65rem',
                              color: theme.text,
                              fontFamily: "'Lora',serif"
                            }}
                          >âœ¨ Auto</button>
                          {Object.entries(musicTracks).map(([id, track]) => (
                            <button 
                              key={id}
                              onClick={() => setMusicTrack(id)}
                              style={{
                                padding: '8px 12px',
                                borderRadius: '8px',
                                border: musicTrack === id ? `2px solid ${theme.accent}` : `1px solid ${theme.cardBorder}`,
                                background: musicTrack === id ? theme.accentLight : 'transparent',
                                cursor: 'pointer',
                                fontSize: '0.65rem',
                                color: theme.text,
                                fontFamily: "'Lora',serif"
                              }}
                            >{track.icon} {track.name}</button>
                          ))}
                        </div>
                        <p className="bt" style={{ fontSize: '0.55rem', color: theme.textMuted, marginTop: '6px' }}>
                          Auto: {isDark ? 'Dark mode tracks' : 'Light mode tracks'} based on theme
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* Background Play Toggle */}
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 14px', background: theme.progressBg, borderRadius: '10px', marginBottom: '14px' }}>
                  <div>
                    <p className="bt" style={{ fontSize: '0.75rem', fontWeight: 600, color: theme.text }}>ğŸ”„ Background Play</p>
                    <p className="bt" style={{ fontSize: '0.55rem', color: theme.textSecondary }}>Keep playing when you leave</p>
                  </div>
                  <button 
                    onClick={() => setBackgroundPlay(!backgroundPlay)}
                    style={{
                      width: '46px',
                      height: '26px',
                      borderRadius: '13px',
                      border: 'none',
                      background: backgroundPlay ? theme.accent : theme.inputBorder,
                      cursor: 'pointer',
                      position: 'relative',
                      transition: 'background 0.2s'
                    }}
                  >
                    <div style={{
                      width: '20px',
                      height: '20px',
                      borderRadius: '50%',
                      background: '#fff',
                      position: 'absolute',
                      top: '3px',
                      left: backgroundPlay ? '23px' : '3px',
                      transition: 'left 0.2s',
                      boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                    }} />
                  </button>
                </div>

                {/* Now Playing Status */}
                {soundEnabled && ambientSound !== 'off' && (
                  <div style={{ textAlign: 'center', marginBottom: '14px', padding: '10px', background: 'rgba(74,222,128,0.1)', borderRadius: '10px', border: '1px solid rgba(74,222,128,0.3)' }}>
                    <p className="bt" style={{ fontSize: '0.7rem', color: '#4ade80' }}>
                      ğŸµ Now Playing: {' '}
                      {ambientSound === 'ambiance' && `${ambianceTracks[getActiveAmbianceTrack()]?.icon} ${ambianceTracks[getActiveAmbianceTrack()]?.name}`}
                      {ambientSound === 'music' && `${musicTracks[getActiveMusicTrack()]?.icon} ${musicTracks[getActiveMusicTrack()]?.name}`}
                      {ambientSound === 'both' && `${ambianceTracks[getActiveAmbianceTrack()]?.icon} ${ambianceTracks[getActiveAmbianceTrack()]?.name} + ${musicTracks[getActiveMusicTrack()]?.icon} ${musicTracks[getActiveMusicTrack()]?.name}`}
                    </p>
                  </div>
                )}

                <button onClick={() => setShowSoundMenu(false)} style={{ ...s.btn, width: '100%' }}>Done</button>
              </div>
            </div>
          )}

          {/* Delete Confirmation */}
          {confirmDelete && (
            <div style={s.modal} onClick={() => setConfirmDelete(null)}>
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide" onClick={e => e.stopPropagation()}>
                <span style={{ fontSize: '2.5rem' }}>ğŸ—‘ï¸</span>
                <h2 className="hw" style={{ fontSize: '1.3rem', color: theme.text, marginTop: '12px', marginBottom: '8px' }}>Delete {confirmDelete.type === 'habit' ? 'Habit' : 'Task'}?</h2>
                <p className="bt" style={{ fontSize: '0.9rem', color: theme.textSecondary, marginBottom: '6px' }}>
                  {confirmDelete.icon && <span style={{ marginRight: '6px' }}>{confirmDelete.icon}</span>}
                  <strong>{confirmDelete.name}</strong>
                </p>
                <p className="bt" style={{ fontSize: '0.75rem', color: theme.textMuted, marginBottom: '20px' }}>
                  {confirmDelete.type === 'habit' ? 'This will delete the habit and reset its streak.' : 'This action can be undone for 4 seconds.'}
                </p>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button onClick={() => setConfirmDelete(null)} style={{ ...s.btnSecondary, flex: 1 }}>Cancel</button>
                  <button onClick={() => confirmDelete.type === 'habit' ? deleteHabit(confirmDelete.id) : deleteTask(confirmDelete.id)} style={{ ...s.btn, flex: 1, background: '#ef4444' }}>Delete</button>
                </div>
              </div>
            </div>
          )}

          {/* Export */}
          {showExport && (
            <div style={s.modal} onClick={() => setShowExport(false)}>
              <div style={{ ...s.modalContent, textAlign: 'center' }} className="slide" onClick={e => e.stopPropagation()}>
                <span style={{ fontSize: '2rem' }}>ğŸ’¾</span>
                <h2 className="hw" style={{ fontSize: '1.4rem', color: theme.text, marginTop: '8px', marginBottom: '12px' }}>Export Your Data</h2>
                <p className="bt" style={{ fontSize: '0.85rem', color: theme.textSecondary, marginBottom: '20px' }}>Download all your habits, tasks, mood logs, journal entries, and stats as a JSON file.</p>
                <button onClick={exportData} style={{ ...s.btn, width: '100%', marginBottom: '10px' }}>ğŸ“¥ Download Backup</button>
                <button onClick={() => setShowExport(false)} style={{ ...s.btnSecondary, width: '100%' }}>Cancel</button>
              </div>
            </div>
          )}

          {/* Undo Toast */}
          {undoAction && (
            <div style={{ position: 'fixed', bottom: '100px', left: '50%', transform: 'translateX(-50%)', background: theme.text, color: theme.modalBg, padding: '10px 16px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '10px', zIndex: 1000, boxShadow: '0 4px 20px rgba(0,0,0,0.3)' }} className="slide">
              <span className="bt" style={{ fontSize: '0.85rem' }}>{undoAction.type} deleted</span>
              <button onClick={() => { undoAction.action(); setUndoAction(null); }} style={{ background: theme.accent, color: '#fff', border: 'none', padding: '5px 10px', borderRadius: '6px', fontWeight: 600, cursor: 'pointer', fontSize: '0.8rem' }}>Undo</button>
            </div>
          )}

          {/* Celebration */}
          {celebration && (
            <div style={{ position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%,-50%)', background: theme.accentGradient, color: theme.isDark ? '#1a1a1a' : '#fff', padding: '16px 28px', borderRadius: '16px', zIndex: 3000, textAlign: 'center', boxShadow: '0 10px 40px rgba(0,0,0,0.3)' }} className="slide">
              <p className="hw" style={{ fontSize: '1.4rem', margin: 0 }}>{celebration}</p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    setTimeout(() => document.getElementById('loadingScreen').classList.add('hidden'), 800);
  </script>
  <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);</script>
</body>
</html>
